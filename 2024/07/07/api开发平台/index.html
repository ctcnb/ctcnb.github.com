<!DOCTYPE html><html lang="zh" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>api开发平台 | 编程小屋</title><meta name="author" content="阿库娅"><meta name="copyright" content="阿库娅"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="前言 背景   1．前端开发需要用到后台接口 2．使用现成的系统的功能(http:&#x2F;&#x2F;api.btstu.cn&#x2F;)   做一个API接口平台:    防止攻击（安全性)  不能随便调用(限制、开通)  统计调用次数  计费  流量保护  API接入     项目介绍   做一个提供API接口调用的平台，用户可以注册登录，开通接口调用权限。用户可以使用接口，并且每次调用会进行统计。管理员可以发布接口">
<meta property="og:type" content="article">
<meta property="og:title" content="api开发平台">
<meta property="og:url" content="http://example.com/2024/07/07/api%E5%BC%80%E5%8F%91%E5%B9%B3%E5%8F%B0/index.html">
<meta property="og:site_name" content="编程小屋">
<meta property="og:description" content="前言 背景   1．前端开发需要用到后台接口 2．使用现成的系统的功能(http:&#x2F;&#x2F;api.btstu.cn&#x2F;)   做一个API接口平台:    防止攻击（安全性)  不能随便调用(限制、开通)  统计调用次数  计费  流量保护  API接入     项目介绍   做一个提供API接口调用的平台，用户可以注册登录，开通接口调用权限。用户可以使用接口，并且每次调用会进行统计。管理员可以发布接口">
<meta property="og:locale">
<meta property="og:image" content="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png">
<meta property="article:published_time" content="2024-07-07T02:16:44.000Z">
<meta property="article:modified_time" content="2024-07-07T07:41:58.077Z">
<meta property="article:author" content="阿库娅">
<meta property="article:tag" content="java">
<meta property="article:tag" content="api开发平台">
<meta property="article:tag" content="项目实战">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2024/07/07/api%E5%BC%80%E5%8F%91%E5%B9%B3%E5%8F%B0/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Error',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'api开发平台',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-07-07 15:41:58'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.1.1"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">31</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">78</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">8</div></a></div><hr class="custom-hr"/></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog-info"><a href="/" title="编程小屋"><img class="site-icon" src="https://halo-ctc.upyun.ctcnb.cn/halo/cropped-logo.png"/><span class="site-name">编程小屋</span></a></span><div id="menus"><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">api开发平台</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2024-07-07T02:16:44.000Z" title="Created 2024-07-07 10:16:44">2024-07-07</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2024-07-07T07:41:58.077Z" title="Updated 2024-07-07 15:41:58">2024-07-07</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E7%BC%96%E7%A8%8B/">编程</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="api开发平台"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><hr>
<p><strong>背景</strong>   1．前端开发需要用到后台接口 2．使用现成的系统的功能(<a target="_blank" rel="noopener" href="http://api.btstu.cn/">http://api.btstu.cn/</a>)   <strong>做一个API接口平台:</strong>  </p>
<ol>
<li><p>防止攻击（安全性)</p>
</li>
<li><p>不能随便调用(限制、开通)</p>
</li>
<li><p>统计调用次数</p>
</li>
<li><p>计费</p>
</li>
<li><p>流量保护</p>
</li>
<li><p>API接入</p>
</li>
</ol>
<p>  <strong>项目介绍</strong>   做一个提供API接口调用的平台，用户可以注册登录，开通接口调用权限。用户可以使用接口，并且每次调用会进行统计。管理员可以发布接口、下线接口、接入接口，以及可视化接口的调用情况、数据。   <strong>业务流程</strong>   <img src="http://halo-ctc.qiniu.ctcnb.cn/markdown/api/image-20230112101821991.png">   <strong>技术选型</strong>   <strong>前端：</strong>  </p>
<ul>
<li><p>Ant Design Pro</p>
</li>
<li><p>React</p>
</li>
<li><p>Ant Design Procomponents</p>
</li>
<li><p>Umi</p>
</li>
<li><p>Umi Request (Axios的封装)</p>
</li>
</ul>
<p>  <strong>后端：</strong>  </p>
<ul>
<li><p>Java Spring Boot</p>
</li>
<li><p>Spring Boot Starter (SDK开发)</p>
</li>
<li><p>Dubbo</p>
</li>
<li><p>Nacos</p>
</li>
<li><p>Spring Cloud Gateway (网关、限流、日志实现)</p>
</li>
</ul>
<p> </p>
<h1 id="一、项目初始化"><a href="#一、项目初始化" class="headerlink" title="一、项目初始化"></a>一、项目初始化</h1><hr>
<h2 id="1、Ant-Design-Pro"><a href="#1、Ant-Design-Pro" class="headerlink" title="1、Ant Design Pro"></a>1、Ant Design Pro</h2><hr>
<p>快速开始使用，可以查看<a target="_blank" rel="noopener" href="https://pro.ant.design/zh-CN/docs/getting-started">官方教程</a>   <strong>初始化</strong>  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 使用 npm</span><br><span class="line">npm i @ant-design/pro-cli -g</span><br></pre></td></tr></table></figure>

<p>  打开将要存放项目的文件夹  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pro create  项目名称</span><br></pre></td></tr></table></figure>

<p>  <strong>选择umi版本</strong>  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">? 🐂 使用 umi@4 还是 umi@3 ? (Use arrow keys)</span><br><span class="line">❯ umi@4</span><br><span class="line">  umi@3</span><br></pre></td></tr></table></figure>

<p>  选择4版的   <strong>安装依赖</strong>  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn 或者  npm install</span><br></pre></td></tr></table></figure>

<p>  <strong>启动</strong>   在<strong>package.json</strong>里面      点击<strong>start</strong>   这里我遇到了一个坑，登录页面无法登录 状态码404   在GitHub issue里找到了解决方案：<a target="_blank" rel="noopener" href="https://github.com/ant-design/ant-design-pro/issues/10446">https://github.com/ant-design/ant-design-pro/issues/10446</a>   <img src="http://halo-ctc.qiniu.ctcnb.cn/markdown/api/image-20230112105451611.png">   <strong>删除不必要的东西</strong>  </p>
<ol>
<li>移除国际化 先跳过 有BUG 运行package.json中的i18n-remove 然后发现又报错了..</li>
</ol>
<p>解决方法：执行   yarn add eslint-config-prettier   yarn add eslint-plugin-unicorn   然后修改node_modules&#x2F;@umijs&#x2F;lint&#x2F;dist&#x2F;config&#x2F;eslint&#x2F;index.js   &#x2F;&#x2F; es2022: true把这个注释掉就可以解决问题 <img src="http://halo-ctc.qiniu.ctcnb.cn/markdown/api/image-20230112110408577.png"> 然后删除src&#x2F;locales目录</p>
<ol start="2">
<li>删除tests测试</li>
</ol>
<p> </p>
<h2 id="2、后端"><a href="#2、后端" class="headerlink" title="2、后端"></a>2、后端</h2><hr>
<h3 id="1、初始化"><a href="#1、初始化" class="headerlink" title="1、初始化"></a>1、初始化</h3><p>  <strong>使用SpringBoot 项目初始模板</strong>   Java SpringBoot 项目初始模板，整合了常用框架和示例代码，大家可以在此基础上快速开发自己的项目。(springboot-init)   <strong>模板功能</strong>  </p>
<ul>
<li><p>Spring Boot 2.7.0（贼新）</p>
</li>
<li><p>Spring MVC</p>
</li>
<li><p>MySQL 驱动</p>
</li>
<li><p>MyBatis</p>
</li>
<li><p>MyBatis Plus</p>
</li>
<li><p>Spring Session Redis 分布式登录</p>
</li>
<li><p>Spring AOP</p>
</li>
<li><p>Apache Commons Lang3 工具类</p>
</li>
<li><p>Lombok 注解</p>
</li>
<li><p>Swagger + Knife4j 接口文档</p>
</li>
<li><p>Spring Boot 调试工具和项目处理器</p>
</li>
<li><p>全局请求响应拦截器（记录日志）</p>
</li>
<li><p>全局异常处理器</p>
</li>
<li><p>自定义错误码</p>
</li>
<li><p>封装通用响应类</p>
</li>
<li><p>示例用户注册、登录、搜索功能</p>
</li>
<li><p>示例单元测试类</p>
</li>
<li><p>示例 SQL（用户表）</p>
</li>
</ul>
<p>  需要更改yaml文件中的MySQL、Redis的配置   访问 localhost:7529&#x2F;api&#x2F;doc.html 就能在线调试接口了，不需要前端配合啦~   <img src="http://halo-ctc.qiniu.ctcnb.cn/markdown/api/image-20230112141458799.png">  </p>
<h3 id="2、数据库设计"><a href="#2、数据库设计" class="headerlink" title="2、数据库设计"></a>2、数据库设计</h3><hr>
<p><strong>基本结构</strong>  </p>
<ul>
<li><p>id 用户id</p>
</li>
<li><p>name 名称</p>
</li>
<li><p>description 描述</p>
</li>
<li><p>url 接口地址</p>
</li>
<li><p>request_header 请求头</p>
</li>
<li><p>reponse_header 响应头</p>
</li>
<li><p>status 接口状态（0-关闭 1-开启）</p>
</li>
<li><p>method 请求类型</p>
</li>
<li><p>user_id 创建人</p>
</li>
<li><p>create_time 创建时间</p>
</li>
<li><p>update_time 更新时间</p>
</li>
<li><p>is_delete  逻辑删除 （0-未删 ，1-已删）</p>
</li>
</ul>
<p>  <strong>代码</strong>   可以用鱼皮写的sql生成工具生成一下代码   <a target="_blank" rel="noopener" href="https://www.sqlfather.com/">SQL之父</a>   <img src="http://halo-ctc.qiniu.ctcnb.cn/markdown/api/image-20230112153403987.png">   填对应的数据，一键生成即可  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">create database if not exists api_platform;</span><br><span class="line"></span><br><span class="line">use api_platform;</span><br><span class="line"></span><br><span class="line">-- 接口信息</span><br><span class="line">create table if not exists api_platform.`interface_info`</span><br><span class="line">(</span><br><span class="line">`id` bigint not null auto_increment comment &#x27;主键&#x27; primary key,</span><br><span class="line">`name` varchar(256) not null comment &#x27;名称&#x27;,</span><br><span class="line">`description` varchar(256) null comment &#x27;描述&#x27;,</span><br><span class="line">`url` varchar(512) not null comment &#x27;接口地址&#x27;,</span><br><span class="line">`request_header` text null comment &#x27;请求头&#x27;,</span><br><span class="line">`response_header` text null comment &#x27;响应头&#x27;,</span><br><span class="line">`status` int default 0 not null comment &#x27;接口状态（0-关闭，1-开启）&#x27;,</span><br><span class="line">`method` varchar(256) not null comment &#x27;请求类型&#x27;,</span><br><span class="line">`user_id` bigint not null comment &#x27;创建人&#x27;,</span><br><span class="line">`create_time` datetime default CURRENT_TIMESTAMP not null comment &#x27;创建时间&#x27;,</span><br><span class="line">`update_time` datetime default CURRENT_TIMESTAMP not null on update CURRENT_TIMESTAMP comment &#x27;更新时间&#x27;,</span><br><span class="line">`is_deleted` tinyint default 0 not null comment &#x27;是否删除(0-未删, 1-已删)&#x27;</span><br><span class="line">) comment &#x27;接口信息&#x27;;</span><br><span class="line"></span><br><span class="line">insert into api_platform.`interface_info` (`name`, `description`, `url`, `request_header`, `response_header`, `status`, `method`, `user_id`) values (&#x27;廖立轩&#x27;, &#x27;脱颖而出&#x27;, &#x27;www.foster-larkin.co&#x27;, &#x27;龙嘉懿&#x27;, &#x27;秦天磊&#x27;, 0, &#x27;GET&#x27;, 1718083101);</span><br><span class="line">insert into api_platform.`interface_info` (`name`, `description`, `url`, `request_header`, `response_header`, `status`, `method`, `user_id`) values (&#x27;曹明辉&#x27;, &#x27;举一反三&#x27;, &#x27;www.tony-kiehn.com&#x27;, &#x27;任擎苍&#x27;, &#x27;陈凯瑞&#x27;, 0, &#x27;GET&#x27;, 28978);</span><br><span class="line">insert into api_platform.`interface_info` (`name`, `description`, `url`, `request_header`, `response_header`, `status`, `method`, `user_id`) values (&#x27;金乐驹&#x27;, &#x27;首当其冲&#x27;, &#x27;www.coleen-prosacco.net&#x27;, &#x27;毛浩&#x27;, &#x27;陆致远&#x27;, 0, &#x27;GET&#x27;, 208);</span><br><span class="line">insert into api_platform.`interface_info` (`name`, `description`, `url`, `request_header`, `response_header`, `status`, `method`, `user_id`) values (&#x27;廖思&#x27;, &#x27;来之不易&#x27;, &#x27;www.don-sipes.net&#x27;, &#x27;梁彬&#x27;, &#x27;白君浩&#x27;, 0, &#x27;GET&#x27;, 470);</span><br><span class="line">insert into api_platform.`interface_info` (`name`, `description`, `url`, `request_header`, `response_header`, `status`, `method`, `user_id`) values (&#x27;董煜祺&#x27;, &#x27;长治久安&#x27;, &#x27;www.terry-turner.co&#x27;, &#x27;覃绍齐&#x27;, &#x27;胡雪松&#x27;, 0, &#x27;GET&#x27;, 611007);</span><br><span class="line">insert into api_platform.`interface_info` (`name`, `description`, `url`, `request_header`, `response_header`, `status`, `method`, `user_id`) values (&#x27;侯聪健&#x27;, &#x27;精心设计&#x27;, &#x27;www.augustus-yost.info&#x27;, &#x27;傅鸿煊&#x27;, &#x27;潘鹏飞&#x27;, 0, &#x27;GET&#x27;, 0);</span><br><span class="line">insert into api_platform.`interface_info` (`name`, `description`, `url`, `request_header`, `response_header`, `status`, `method`, `user_id`) values (&#x27;魏弘文&#x27;, &#x27;玩忽职守&#x27;, &#x27;www.guadalupe-beatty.biz&#x27;, &#x27;江梓晨&#x27;, &#x27;魏思淼&#x27;, 0, &#x27;GET&#x27;, 1162536022);</span><br><span class="line">insert into api_platform.`interface_info` (`name`, `description`, `url`, `request_header`, `response_header`, `status`, `method`, `user_id`) values (&#x27;于苑博&#x27;, &#x27;各式各样&#x27;, &#x27;www.nolan-metz.net&#x27;, &#x27;韦果&#x27;, &#x27;金胤祥&#x27;, 0, &#x27;GET&#x27;, 0);</span><br><span class="line">insert into api_platform.`interface_info` (`name`, `description`, `url`, `request_header`, `response_header`, `status`, `method`, `user_id`) values (&#x27;姚炫明&#x27;, &#x27;翻天覆地&#x27;, &#x27;www.jodie-schultz.info&#x27;, &#x27;许越彬&#x27;, &#x27;毛晋鹏&#x27;, 0, &#x27;GET&#x27;, 973);</span><br><span class="line">insert into api_platform.`interface_info` (`name`, `description`, `url`, `request_header`, `response_header`, `status`, `method`, `user_id`) values (&#x27;孙鑫鹏&#x27;, &#x27;络绎不绝&#x27;, &#x27;www.liza-sporer.co&#x27;, &#x27;孙彬&#x27;, &#x27;傅鸿煊&#x27;, 0, &#x27;GET&#x27;, 30308);</span><br><span class="line">insert into api_platform.`interface_info` (`name`, `description`, `url`, `request_header`, `response_header`, `status`, `method`, `user_id`) values (&#x27;唐展鹏&#x27;, &#x27;铤而走险&#x27;, &#x27;www.hayden-purdy.co&#x27;, &#x27;杨哲瀚&#x27;, &#x27;陆凯瑞&#x27;, 0, &#x27;GET&#x27;, 473462835);</span><br><span class="line">insert into api_platform.`interface_info` (`name`, `description`, `url`, `request_header`, `response_header`, `status`, `method`, `user_id`) values (&#x27;曹擎苍&#x27;, &#x27;赞不绝口&#x27;, &#x27;www.phung-glover.org&#x27;, &#x27;邱志泽&#x27;, &#x27;张健雄&#x27;, 0, &#x27;GET&#x27;, 32155653);</span><br><span class="line">insert into api_platform.`interface_info` (`name`, `description`, `url`, `request_header`, `response_header`, `status`, `method`, `user_id`) values (&#x27;夏烨霖&#x27;, &#x27;哭笑不得&#x27;, &#x27;www.augustine-funk.org&#x27;, &#x27;宋聪健&#x27;, &#x27;郝鹏涛&#x27;, 0, &#x27;GET&#x27;, 3964);</span><br><span class="line">insert into api_platform.`interface_info` (`name`, `description`, `url`, `request_header`, `response_header`, `status`, `method`, `user_id`) values (&#x27;董浩&#x27;, &#x27;对症下药&#x27;, &#x27;www.erik-hamill.biz&#x27;, &#x27;黎立果&#x27;, &#x27;廖鹤轩&#x27;, 0, &#x27;GET&#x27;, 2275);</span><br><span class="line">insert into api_platform.`interface_info` (`name`, `description`, `url`, `request_header`, `response_header`, `status`, `method`, `user_id`) values (&#x27;罗荣轩&#x27;, &#x27;喜闻乐见&#x27;, &#x27;www.gia-hermann.biz&#x27;, &#x27;韩煜城&#x27;, &#x27;阎耀杰&#x27;, 0, &#x27;GET&#x27;, 847);</span><br><span class="line">insert into api_platform.`interface_info` (`name`, `description`, `url`, `request_header`, `response_header`, `status`, `method`, `user_id`) values (&#x27;沈正豪&#x27;, &#x27;统筹兼顾&#x27;, &#x27;www.isabella-reinger.io&#x27;, &#x27;邓子轩&#x27;, &#x27;廖伟诚&#x27;, 0, &#x27;GET&#x27;, 997378602);</span><br><span class="line">insert into api_platform.`interface_info` (`name`, `description`, `url`, `request_header`, `response_header`, `status`, `method`, `user_id`) values (&#x27;任立果&#x27;, &#x27;出人意料&#x27;, &#x27;www.geoffrey-koss.name&#x27;, &#x27;覃浩然&#x27;, &#x27;萧雨泽&#x27;, 0, &#x27;GET&#x27;, 403);</span><br><span class="line">insert into api_platform.`interface_info` (`name`, `description`, `url`, `request_header`, `response_header`, `status`, `method`, `user_id`) values (&#x27;张炫明&#x27;, &#x27;名不虚传&#x27;, &#x27;www.ellan-gleason.com&#x27;, &#x27;黎正豪&#x27;, &#x27;韦炎彬&#x27;, 0, &#x27;GET&#x27;, 35127293);</span><br><span class="line">insert into api_platform.`interface_info` (`name`, `description`, `url`, `request_header`, `response_header`, `status`, `method`, `user_id`) values (&#x27;方雨泽&#x27;, &#x27;衣食住行&#x27;, &#x27;www.wilton-walsh.biz&#x27;, &#x27;黎越泽&#x27;, &#x27;白远航&#x27;, 0, &#x27;GET&#x27;, 62264);</span><br><span class="line">insert into api_platform.`interface_info` (`name`, `description`, `url`, `request_header`, `response_header`, `status`, `method`, `user_id`) values (&#x27;袁天翊&#x27;, &#x27;卷土重来&#x27;, &#x27;www.lynetta-mclaughlin.info&#x27;, &#x27;邹熠彤&#x27;, &#x27;叶潇然&#x27;, 0, &#x27;GET&#x27;, 9884455);</span><br></pre></td></tr></table></figure>

<p>  运行即可  </p>
<h3 id="3、使用MabatisX插件"><a href="#3、使用MabatisX插件" class="headerlink" title="3、使用MabatisX插件"></a>3、使用MabatisX插件</h3><p>  生成domain、mapper、service   打开新建的表，右击选择MybatisX-Generator   勾上驼峰   <img src="http://halo-ctc.qiniu.ctcnb.cn/markdown/api/image-20230112155202934.png">   根据<strong>版本跟需要打勾</strong>，点击完成   <img src="http://halo-ctc.qiniu.ctcnb.cn/markdown/api/image-20230112161220300.png">   查看目录   <img src="http://halo-ctc.qiniu.ctcnb.cn/markdown/api/image-20230112161257033.png">   然后将它们放到我自己的路径下  </p>
<h3 id="4、Controller"><a href="#4、Controller" class="headerlink" title="4、Controller"></a>4、Controller</h3><p>  接下来到controller层   我们只需要将<strong>PostController</strong>复制一份改名为<strong>InterfaceInfoController</strong>即可,因为逻辑是差不多，都是进行增删改查   然后将post改成interfaceInfo、Post改成InterfaceInfo   根据报错信息我们来补充信息  </p>
<h3 id="5、DTO"><a href="#5、DTO" class="headerlink" title="5、DTO"></a>5、DTO</h3><p>  首先先增加DTO，在InterfaceInfo类从拿我们需要的信息做成三个DTO类（分别是新增、查询、更新）删除的请求我们封装在common包下   <img src="http://halo-ctc.qiniu.ctcnb.cn/markdown/api/image-20230112184904561.png">  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">package com.xuan.project.model.dto.interfaceinfo;</span><br><span class="line"></span><br><span class="line">import lombok.Data;</span><br><span class="line"></span><br><span class="line">import java.io.Serializable;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 创建请求</span><br><span class="line"> *</span><br><span class="line"> * @author xuan</span><br><span class="line"> */</span><br><span class="line">@Data</span><br><span class="line">public class InterfaceInfoAddRequest implements Serializable &#123;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 名称</span><br><span class="line"> */</span><br><span class="line">private String name;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 描述</span><br><span class="line"> */</span><br><span class="line">private String description;</span><br><span class="line"></span><br><span class="line">  // ...</span><br><span class="line">  // ...</span><br><span class="line">  // ...</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> </p>
<h3 id="6、Service"><a href="#6、Service" class="headerlink" title="6、Service"></a>6、Service</h3><p>  根据报错可知 service层缺少一个方法validInterfaceInfo  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * @author xuan</span><br><span class="line"> * @description 针对表【interface_info(接口信息)】的数据库操作Service实现</span><br><span class="line"> * @createDate 2023-01-12 16:11:19</span><br><span class="line"> */</span><br><span class="line">@Service</span><br><span class="line">public class InterfaceInfoServiceImpl extends ServiceImpl&lt;InterfaceInfoMapper, InterfaceInfo&gt;</span><br><span class="line">implements InterfaceInfoService &#123;</span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line">public void validInterfaceInfo(InterfaceInfo interfaceInfo, boolean add) &#123;</span><br><span class="line">if (interfaceInfo == null) &#123;</span><br><span class="line">throw new BusinessException(ErrorCode.PARAMS_ERROR);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">String name = interfaceInfo.getName();</span><br><span class="line">String description = interfaceInfo.getDescription();</span><br><span class="line">String url = interfaceInfo.getUrl();</span><br><span class="line">String requestHeader = interfaceInfo.getRequestHeader();</span><br><span class="line">String responseHeader = interfaceInfo.getResponseHeader();</span><br><span class="line">Integer status = interfaceInfo.getStatus();</span><br><span class="line">String method = interfaceInfo.getMethod();</span><br><span class="line">Long userId = interfaceInfo.getUserId();</span><br><span class="line"></span><br><span class="line">// 创建时，所有参数必须非空</span><br><span class="line">if (add) &#123;</span><br><span class="line">if (StringUtils.isAnyBlank(name, description, url, requestHeader, responseHeader, method)  ObjectUtils.anyNull(userId, status)) &#123;</span><br><span class="line">throw new BusinessException(ErrorCode.PARAMS_ERROR);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">if (StringUtils.isNotBlank(name) &amp;&amp; name.length() &gt; 256) &#123;</span><br><span class="line">throw new BusinessException(ErrorCode.PARAMS_ERROR, &quot;名字过长&quot;);</span><br><span class="line">&#125;</span><br><span class="line">if (StringUtils.isNotBlank(description) &amp;&amp; description.length() &gt; 512) &#123;</span><br><span class="line">throw new BusinessException(ErrorCode.PARAMS_ERROR, &quot;描述过长&quot;);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>  这里的大量getter 是使用插件 <strong>GenerateAllSetter</strong> 生成 macOS在变量上摁住 option + Enter  即可  </p>
<h2 id="3、前端"><a href="#3、前端" class="headerlink" title="3、前端"></a>3、前端</h2><hr>
<h3 id="1、配置插件"><a href="#1、配置插件" class="headerlink" title="1、配置插件"></a>1、配置插件</h3><p>  为了项目更加规范   搜索 <strong>eslint</strong> 选上自动识别   <img src="http://halo-ctc.qiniu.ctcnb.cn/markdown/api/image-20230112193957977.png">   搜索<strong>prettier</strong> 打√  美化代码   <img src="http://halo-ctc.qiniu.ctcnb.cn/markdown/api/image-20230112194107217.png">  </p>
<h3 id="2、接口调用"><a href="#2、接口调用" class="headerlink" title="2、接口调用"></a>2、接口调用</h3><p>  使用 <strong>oneapi</strong> 插件自动生成   如果要前端自动生成，需要将后端的遵循<strong>openapi</strong>规范的<strong>json</strong>文档   后端的遵循<strong>openapi</strong>规范的<strong>json</strong>文档   找到我们起的后端主页   <img src="http://halo-ctc.qiniu.ctcnb.cn/markdown/api/image-20230112195321863.png">   在地址栏输入<a target="_blank" rel="noopener" href="http://localhost:7529/api/v3/api-docs">http://localhost:7529/api/v3/api-docs</a>   发现如下所示   <img src="http://halo-ctc.qiniu.ctcnb.cn/markdown/api/image-20230112195351679.png">   那么我们就可以使用这个url了   打开config目录下<strong>config.ts</strong> 找到<strong>openApi</strong> 修改如下  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">openAPI: [</span><br><span class="line">  // &#123;</span><br><span class="line">  //   requestLibPath: &quot;import &#123; request &#125; from &#x27;@umijs/max&#x27;&quot;,</span><br><span class="line">  //   // 或者使用在线的版本</span><br><span class="line">  //   // schemaPath: &quot;https://gw.alipayobjects.com/os/antfincdn/M%24jrzTTYJN/oneapi.json&quot;</span><br><span class="line">  //   schemaPath: join(__dirname, &#x27;oneapi.json&#x27;),</span><br><span class="line">  //   mock: false,</span><br><span class="line">  // &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    requestLibPath: &quot;import &#123; request &#125; from &#x27;@umijs/max&#x27;&quot;,</span><br><span class="line">    schemaPath: &#x27;http://localhost:7529/api/v3/api-docs&#x27;,</span><br><span class="line">    projectName: &#x27;api-platform-backend&#x27;,</span><br><span class="line">  &#125;,</span><br><span class="line">],</span><br></pre></td></tr></table></figure>

<p>  测试一下是否能用   找到<strong>package.json</strong>,执行<strong>openapi</strong>命令   执行成功，我们去<strong>service</strong>看一下   <img src="http://halo-ctc.qiniu.ctcnb.cn/markdown/api/image-20230112195813202.png">   由于我们有后端 ，应请求真实环境，所以直接用<strong>dev模式</strong>运行  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm run start:dev</span><br></pre></td></tr></table></figure>

<p>  可以将项目中的<strong>requestErrorConfig.ts</strong>改为<strong>requestConfig.ts</strong>   然后在<strong>app.tsx</strong> 找到 request配置，将其修改成我们改的   再打开<strong>requestConfig.ts</strong>   修改名字，并设置一下后端地址   <img src="http://halo-ctc.qiniu.ctcnb.cn/markdown/api/image-20230112200749537.png">   <strong>测试一下</strong>   使用它提示账户密码登录，失败了   我们查看一下发现是<strong>前后端接口定义不一致</strong>   <img src="http://halo-ctc.qiniu.ctcnb.cn/markdown/api/image-20230112201646377.png">  </p>
<h3 id="3、修改登录的接口"><a href="#3、修改登录的接口" class="headerlink" title="3、修改登录的接口"></a>3、修改登录的接口</h3><p>  找到<strong>src&#x2F;pages&#x2F;User&#x2F;Login&#x2F;index.tsx</strong>下的<strong>handleSubmit</strong>  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">const handleSubmit = async (values: API.UserLoginRequest) =&gt; &#123;</span><br><span class="line">  try &#123;</span><br><span class="line">    // 登录</span><br><span class="line">    const res = await userLoginUsingPOST(&#123; ...values &#125;);</span><br><span class="line">    if (res.data) &#123;</span><br><span class="line">      const urlParams = new URL(window.location.href).searchParams;</span><br><span class="line">      history.push(urlParams.get(&#x27;redirect&#x27;)  &#x27;/&#x27;);</span><br><span class="line">      return;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; catch (error) &#123;</span><br><span class="line">    const defaultLoginFailureMessage = intl.formatMessage(&#123;</span><br><span class="line">      id: &#x27;pages.login.failure&#x27;,</span><br><span class="line">      defaultMessage: &#x27;登录失败，请重试！&#x27;,</span><br><span class="line">    &#125;);</span><br><span class="line">    console.log(error);</span><br><span class="line">    message.error(defaultLoginFailureMessage);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>  修改用户名和密码的字段和我们后端一样  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;ProFormText</span><br><span class="line">  name=&quot;userAccount&quot;</span><br><span class="line">  fieldProps=&#123;&#123;</span><br><span class="line">    size: &#x27;large&#x27;,</span><br><span class="line">      prefix: &lt;UserOutlined /&gt;,</span><br><span class="line">  &#125;&#125;</span><br><span class="line">  placeholder=&#123;intl.formatMessage(&#123;</span><br><span class="line">    id: &#x27;pages.login.username.placeholder&#x27;,</span><br><span class="line">    defaultMessage: &#x27;用户名: admin or user&#x27;,</span><br><span class="line">  &#125;)&#125;</span><br><span class="line">  rules=&#123;[</span><br><span class="line">    &#123;</span><br><span class="line">      required: true,</span><br><span class="line">      message: (</span><br><span class="line">        &lt;FormattedMessage</span><br><span class="line">          id=&quot;pages.login.username.required&quot;</span><br><span class="line">          defaultMessage=&quot;请输入用户名!&quot;</span><br><span class="line">          /&gt;</span><br><span class="line">      ),</span><br><span class="line">    &#125;,</span><br><span class="line">  ]&#125;</span><br><span class="line">  /&gt;</span><br></pre></td></tr></table></figure>

<p>  返回登录页面，进行登录   <img src="http://halo-ctc.qiniu.ctcnb.cn/markdown/api/image-20230112202314036.png">   请求成功但是没跳转   为什么没跳转？因为我们没有记录用户的<strong>登录态</strong>，不知道它是否登录成功   <strong>设置用户的登录态</strong>   回到<strong>app.tsx</strong>   找到<strong>getInitialState()<strong>这个方法   这个方法当我们首次访问页面的时候，获取用户的信息，获取当前全局的一些状态，可以把它当成全局变量   我们先找到</strong>typings.d.ts</strong>  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// 最后面添加</span><br><span class="line">/**</span><br><span class="line"> * 全局状态类型</span><br><span class="line"> */</span><br><span class="line">interface InitialState &#123;</span><br><span class="line">  loginUser?: API.UserVO;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>  返回**getInitialState()**将它改为  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">export async function getInitialState(): Promise&lt;InitialState&gt; &#123;</span><br><span class="line">  // 当页面首次加载时，获取要全局保存的信息比如用户信息</span><br><span class="line">  const state: InitialState = &#123;</span><br><span class="line">    loginUser: undefined,</span><br><span class="line">  &#125;;</span><br><span class="line">  try &#123;</span><br><span class="line">    const res = await getLoginUserUsingGET();</span><br><span class="line">    if (res.data) &#123;</span><br><span class="line">      state.loginUser = res.data;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; catch (error) &#123;</span><br><span class="line">    history.push(loginPath);</span><br><span class="line">  &#125;</span><br><span class="line">  return state;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>  返回<strong>src&#x2F;pages&#x2F;User&#x2F;Login&#x2F;index.tsx</strong>下的<strong>handleSubmit</strong>   设置登录状态  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">const handleSubmit = async (values: API.UserLoginRequest) =&gt; &#123;</span><br><span class="line">  try &#123;</span><br><span class="line">    // 登录</span><br><span class="line">    const res = await userLoginUsingPOST(&#123; ...values &#125;);</span><br><span class="line">    if (res.data) &#123;</span><br><span class="line">      const urlParams = new URL(window.location.href).searchParams;</span><br><span class="line">      history.push(urlParams.get(&#x27;redirect&#x27;)  &#x27;/&#x27;);</span><br><span class="line">      setInitialState(&#123;</span><br><span class="line">        loginUser: res.data</span><br><span class="line">      &#125;);</span><br><span class="line">      return;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; catch (error) &#123;</span><br><span class="line">    const defaultLoginFailureMessage = intl.formatMessage(&#123;</span><br><span class="line">      id: &#x27;pages.login.failure&#x27;,</span><br><span class="line">      defaultMessage: &#x27;登录失败，请重试！&#x27;,</span><br><span class="line">    &#125;);</span><br><span class="line">    console.log(error);</span><br><span class="line">    message.error(defaultLoginFailureMessage);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>  测试   <img src="http://halo-ctc.qiniu.ctcnb.cn/markdown/api/image-20230113103454564.png">   成功进入   <strong>But， 有bug，我们刷新一下发现又要重新登录，这是为什么呢？</strong>   我们推测是前端向后端发送请求的时候没有带上<strong>cookie</strong>！！！   找到<strong>requestConfig.ts</strong>   添加  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">withCredentials: true,</span><br></pre></td></tr></table></figure>

<p> </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">export const requestConfig: RequestConfig = &#123;</span><br><span class="line">  baseURL: &#x27;http://localhost:7529&#x27;,</span><br><span class="line">  withCredentials: true,</span><br><span class="line">  // ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>  刷新测试一下 问题解决  </p>
<h3 id="4、注销"><a href="#4、注销" class="headerlink" title="4、注销"></a>4、注销</h3><p>  和登录差不多，同理   全局搜索logout   发现在<strong>src&#x2F;components&#x2F;RightContent&#x2F;AvatarDropdown.tsx</strong>中有loginOut() 将其改成我们的后端方法  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">const onMenuClick = useCallback(</span><br><span class="line">  (event: MenuInfo) =&gt; &#123;</span><br><span class="line">    const &#123; key &#125; = event;</span><br><span class="line">    if (key === &#x27;logout&#x27;) &#123;</span><br><span class="line">      flushSync(() =&gt; &#123;</span><br><span class="line">        setInitialState((s) =&gt; (&#123; ...s, currentUser: undefined &#125;));</span><br><span class="line">      &#125;);</span><br><span class="line">      userLogoutUsingPOST()</span><br><span class="line">      return;</span><br><span class="line">    &#125;</span><br><span class="line">    history.push(`/account/$&#123;key&#125;`);</span><br><span class="line">  &#125;,</span><br><span class="line">  [setInitialState],</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>  <strong>自动生成的好处</strong>   如果我们后端的实体类修改了,我们可以直接运行 <strong>openapi</strong> 来直接更新  </p>
<h3 id="5、管理权限"><a href="#5、管理权限" class="headerlink" title="5、管理权限"></a>5、管理权限</h3><p>  是否为管理员   打开<strong>access.ts</strong>  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * @see https://umijs.org/zh-CN/plugins/plugin-access</span><br><span class="line"> * */</span><br><span class="line">export default function access(initialState: &#123; currentUser?: API.CurrentUser &#125;  undefined) &#123;</span><br><span class="line">  const &#123; currentUser &#125; = initialState ?? &#123;&#125;;</span><br><span class="line">  return &#123;</span><br><span class="line">    canAdmin: currentUser &amp;&amp; currentUser.access === &#x27;admin&#x27;,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">将canAdmin改成</span><br><span class="line">canAdmin: true,</span><br></pre></td></tr></table></figure>

<p>  发现前端管理界面出来了，所以逻辑就是在这里控制的   <img src="http://halo-ctc.qiniu.ctcnb.cn/markdown/api/image-20230113104939414.png">   所以代码修改如下  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">export default function access(initialState: InitialState  undefined) &#123;</span><br><span class="line">  const &#123; loginUser &#125; = initialState ?? &#123;&#125;;</span><br><span class="line">  return &#123;</span><br><span class="line">    canUser: loginUser,</span><br><span class="line">    canAdmin: loginUser?.userRole === &#x27;admin&#x27;,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> </p>
<h3 id="6、表格页面"><a href="#6、表格页面" class="headerlink" title="6、表格页面"></a>6、表格页面</h3><p>  找到<strong>src&#x2F;pages&#x2F;TableList&#x2F;index.tsx</strong>   找到<strong>columns</strong>   <img src="http://halo-ctc.qiniu.ctcnb.cn/markdown/api/image-20230113112228199.png">   换成我们自己的  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">const columns: ProColumns&lt;API.InterfaceInfo&gt;[] = [</span><br><span class="line">    &#123;</span><br><span class="line">      title: &#x27;id&#x27;,</span><br><span class="line">      dataIndex: &#x27;id&#x27;,</span><br><span class="line">      valueType: &#x27;index&#x27;,</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">      title: &#x27;接口名称&#x27;,</span><br><span class="line">      dataIndex: &#x27;name&#x27;,</span><br><span class="line">      valueType: &#x27;text&#x27;,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      title: &#x27;描述&#x27;,</span><br><span class="line">      dataIndex: &#x27;description&#x27;,</span><br><span class="line">      valueType: &#x27;textarea&#x27;,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      title: &#x27;请求方法&#x27;,</span><br><span class="line">      dataIndex: &#x27;method&#x27;,</span><br><span class="line">      valueType: &#x27;text&#x27;,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      title: &#x27;url&#x27;,</span><br><span class="line">      dataIndex: &#x27;url&#x27;,</span><br><span class="line">      valueType: &#x27;text&#x27;,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      title: &#x27;请求头&#x27;,</span><br><span class="line">      dataIndex: &#x27;requestHeader&#x27;,</span><br><span class="line">      valueType: &#x27;textarea&#x27;,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      title: &#x27;响应头&#x27;,</span><br><span class="line">      dataIndex: &#x27;responseHeader&#x27;,</span><br><span class="line">      valueType: &#x27;textarea&#x27;,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      title: &#x27;状态&#x27;,</span><br><span class="line">      dataIndex: &#x27;status&#x27;,</span><br><span class="line">      hideInForm: true,</span><br><span class="line">      valueEnum: &#123;</span><br><span class="line">        0: &#123;</span><br><span class="line">          text: &#x27;关闭&#x27;,</span><br><span class="line">          status: &#x27;Default&#x27;,</span><br><span class="line">        &#125;,</span><br><span class="line">        1: &#123;</span><br><span class="line">          text: &#x27;开启&#x27;,</span><br><span class="line">          status: &#x27;Processing&#x27;,</span><br><span class="line">        &#125;,</span><br><span class="line"></span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      title: &#x27;创建时间&#x27;,</span><br><span class="line">      dataIndex: &#x27;createTime&#x27;,</span><br><span class="line">      valueType: &#x27;dateTime&#x27;,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      title: &#x27;更新时间&#x27;,</span><br><span class="line">      dataIndex: &#x27;updateTime&#x27;,</span><br><span class="line">      valueType: &#x27;dateTime&#x27;,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      title: &#x27;操作&#x27;,</span><br><span class="line">      dataIndex: &#x27;option&#x27;,</span><br><span class="line">      valueType: &#x27;option&#x27;,</span><br><span class="line">      render: (_, record) =&gt; [</span><br><span class="line">        &lt;a</span><br><span class="line">          key=&quot;config&quot;</span><br><span class="line">          onClick=&#123;() =&gt; &#123;</span><br><span class="line">            handleUpdateModalVisible(true);</span><br><span class="line">            setCurrentRow(record);</span><br><span class="line">          &#125;&#125;</span><br><span class="line">        &gt;</span><br><span class="line">          配置</span><br><span class="line">        &lt;/a&gt;,</span><br><span class="line">        &lt;a key=&quot;subscribeAlert&quot; href=&quot;https://procomponents.ant.design/&quot;&gt;</span><br><span class="line">          订阅警报</span><br><span class="line">        &lt;/a&gt;,</span><br><span class="line">      ],</span><br><span class="line">    &#125;,</span><br><span class="line">  ];</span><br></pre></td></tr></table></figure>

<p>  加载出来了   <img src="http://halo-ctc.qiniu.ctcnb.cn/markdown/api/image-20230113113509859.png">   但是没有数据，我们需要让它有数据   向下找，发现有一个<strong>request</strong>我们需要将他改成自己的listInterfaceInfoByPageUsingGET 这样就有数据了   <img src="http://halo-ctc.qiniu.ctcnb.cn/markdown/api/image-20230113113932612.png">   刷新查看页面   <img src="http://halo-ctc.qiniu.ctcnb.cn/markdown/api/image-20230113114748766.png">   无法加载，但是我们发现数据已经有了   对于这种错误，我们需要检查  </p>
<ul>
<li><p>你的请求参数和他的请求参数是否一致</p>
</li>
<li><p>你的响应值和他要求的响应值是否一致</p>
</li>
</ul>
<p>  所以我们不能完全替换   查看<strong>request</strong>的请求参数  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">request?: (params: U &amp; &#123;</span><br><span class="line">  pageSize?: number;</span><br><span class="line">  current?: number;</span><br><span class="line">  keyword?: string;</span><br><span class="line">&#125;, sort: Record&lt;string, SortOrder&gt;, filter: Record&lt;string, React.ReactText[]  null&gt;) =&gt; Promise&lt;Partial&lt;RequestData&lt;T&gt;&gt;&gt;;</span><br></pre></td></tr></table></figure>

<p>  在<strong>request</strong>在点击<strong>RequestData</strong> 查看响应参数  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">export type RequestData&lt;T&gt; = &#123;</span><br><span class="line">    data: T[]  undefined;</span><br><span class="line">    success?: boolean;</span><br><span class="line">    total?: number;</span><br><span class="line">&#125; &amp; Record&lt;string, any&gt;;</span><br></pre></td></tr></table></figure>

<p>  所以刚刚简单替换请求方法的代码我们重新写  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">request=&#123;async (</span><br><span class="line">         params: &#123;</span><br><span class="line">         pageSize?: number;</span><br><span class="line">         current?: number;</span><br><span class="line">         keyword?: string;</span><br><span class="line">        &#125;, sort: Record&lt;string, SortOrder&gt;,  filter: Record&lt;string, React.ReactText[]  null&gt;,) =&gt; &#123;</span><br><span class="line">          const res = await listInterfaceInfoByPageUsingGET(&#123; ...params &#125;);</span><br><span class="line">          if (res.data) &#123;</span><br><span class="line">            return &#123;</span><br><span class="line">              data: res.data.records  [],</span><br><span class="line">              success: true,</span><br><span class="line">              total: res.data.total,</span><br><span class="line">            &#125;;</span><br><span class="line">          &#125; else &#123;</span><br><span class="line">            return &#123;</span><br><span class="line">              data: [],</span><br><span class="line">              success: false,</span><br><span class="line">              total: 0,</span><br><span class="line">            &#125;;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>  刷新页面，显示成功   <img src="http://halo-ctc.qiniu.ctcnb.cn/markdown/api/image-20230113121556718.png">  </p>
<h1 id="二、基础增删改查"><a href="#二、基础增删改查" class="headerlink" title="二、基础增删改查"></a>二、基础增删改查</h1><hr>
<h2 id="1、修改路由"><a href="#1、修改路由" class="headerlink" title="1、修改路由"></a>1、修改路由</h2><hr>
<p>打开<strong>config</strong>包找到 <strong>routes.ts</strong>   将原来pages下的<strong>TableList</strong>表单名称改为我们的<strong>interfaceInfo</strong>，再把接口管理页面配置到管理员页面下  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  name: &#x27;接口管理&#x27;,</span><br><span class="line">  icon: &#x27;table&#x27;,</span><br><span class="line">  path: &#x27;/admin/interface_info&#x27;,</span><br><span class="line">  component: &#x27;./InterfaceInfo&#x27;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">export default [</span><br><span class="line">  &#123;</span><br><span class="line">    path: &#x27;/user&#x27;,</span><br><span class="line">    layout: false,</span><br><span class="line">    routes: [</span><br><span class="line">      &#123;</span><br><span class="line">        name: &#x27;login&#x27;,</span><br><span class="line">        path: &#x27;/user/login&#x27;,</span><br><span class="line">        component: &#x27;./User/Login&#x27;,</span><br><span class="line">      &#125;,</span><br><span class="line">    ],</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    path: &#x27;/welcome&#x27;,</span><br><span class="line">    name: &#x27;welcome&#x27;,</span><br><span class="line">    icon: &#x27;smile&#x27;,</span><br><span class="line">    component: &#x27;./Welcome&#x27;,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    path: &#x27;/admin&#x27;,</span><br><span class="line">    name: &#x27;admin&#x27;,</span><br><span class="line">    icon: &#x27;crown&#x27;,</span><br><span class="line">    access: &#x27;canAdmin&#x27;,</span><br><span class="line">    routes: [</span><br><span class="line">      &#123;</span><br><span class="line">        path: &#x27;/admin&#x27;,</span><br><span class="line">        redirect: &#x27;/admin/sub-page&#x27;,</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        path: &#x27;/admin/sub-page&#x27;,</span><br><span class="line">        name: &#x27;sub-page&#x27;,</span><br><span class="line">        component: &#x27;./Admin&#x27;,</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        name: &#x27;接口管理&#x27;,</span><br><span class="line">        icon: &#x27;table&#x27;,</span><br><span class="line">        path: &#x27;/admin/interface_info&#x27;,</span><br><span class="line">        component: &#x27;./InterfaceInfo&#x27;,</span><br><span class="line">      &#125;,</span><br><span class="line">    ],</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    path: &#x27;/&#x27;,</span><br><span class="line">    redirect: &#x27;/welcome&#x27;,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    path: &#x27;*&#x27;,</span><br><span class="line">    layout: false,</span><br><span class="line">    component: &#x27;./404&#x27;,</span><br><span class="line">  &#125;,</span><br><span class="line">];</span><br></pre></td></tr></table></figure>

<p>  效果如下   <img src="http://halo-ctc.qiniu.ctcnb.cn/markdown/api/image-20230113145422228.png">  </p>
<h2 id="2、新增接口信息"><a href="#2、新增接口信息" class="headerlink" title="2、新增接口信息"></a>2、新增接口信息</h2><hr>
<h3 id="1）表单模块"><a href="#1）表单模块" class="headerlink" title="1）表单模块"></a>1）表单模块</h3><p>  <strong>interfaceInfo</strong>中的<strong>index.tsx</strong>找到新建的Button   <img src="http://halo-ctc.qiniu.ctcnb.cn/markdown/api/image-20230113153334776.png">   我们点击新建的时候，他会打开一个模态框。往下找，发现它已经给我们提供了这个组件。但是我们需要重新写   <img src="http://halo-ctc.qiniu.ctcnb.cn/markdown/api/image-20230113153512970.png">   我们可以就像更新模态框一样新建一个CreateModal.tsx   <img src="http://halo-ctc.qiniu.ctcnb.cn/markdown/api/image-20230113153639726.png">   接下来修改从UpdateForm中粘贴的<strong>CreateModal.tsx</strong>的代码  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">import &#123; Modal &#125; from &#x27;antd&#x27;;</span><br><span class="line">import React from &#x27;react&#x27;;</span><br><span class="line">import &#123; ProColumns, ProTable &#125; from &#x27;@ant-design/pro-components&#x27;;</span><br><span class="line">import &#x27;@umijs/max&#x27;;</span><br><span class="line"></span><br><span class="line">export type Props = &#123;</span><br><span class="line">  columns: ProColumns&lt;API.InterfaceInfo&gt;[];</span><br><span class="line">  onCancel: () =&gt; void;</span><br><span class="line">  onSubmit: (values: API.InterfaceInfo) =&gt; Promise&lt;boolean&gt;;</span><br><span class="line">  open: boolean;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">const CreateModal: React.FC&lt;Props&gt; = (props) =&gt; &#123;</span><br><span class="line">  const &#123; columns, open, onCancel &#125; = props;</span><br><span class="line">  return (</span><br><span class="line">    &lt;Modal open=&#123;open&#125; onCancel=&#123;() =&gt; onCancel?.()&#125;&gt;</span><br><span class="line">      &lt;ProTable columns=&#123;columns&#125; /&gt;</span><br><span class="line">    &lt;/Modal&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">export default CreateModal;</span><br></pre></td></tr></table></figure>

<p>  <strong>这里我们复用了index中的columns</strong>  这里我顺便把取消也写了   在<strong>index.tsx</strong>中使用  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">  /**</span><br><span class="line">   * @en-US Pop-up window of new window</span><br><span class="line">   * @zh-CN 新建窗口的弹窗</span><br><span class="line">   *  */</span><br><span class="line">  const [createModalOpen, handleModalOpen] = useState&lt;boolean&gt;(false);</span><br><span class="line"></span><br><span class="line"> const columns: ProColumns&lt;API.InterfaceInfo&gt;[] = [</span><br><span class="line">    &#123;</span><br><span class="line">      title: &#x27;id&#x27;,</span><br><span class="line">      dataIndex: &#x27;id&#x27;,</span><br><span class="line">      valueType: &#x27;index&#x27;,</span><br><span class="line">    &#125;,</span><br><span class="line">   // ...</span><br><span class="line">  ]</span><br><span class="line"></span><br><span class="line">// ...</span><br><span class="line">&lt;CreateModal</span><br><span class="line">    columns=&#123;columns&#125;</span><br><span class="line">    onCancel=&#123;() =&gt; handleModalOpen(false)&#125;</span><br><span class="line">    onSubmit=&#123;() =&gt; &#123;&#125;&#125;</span><br><span class="line">    open=&#123;createModalOpen&#125;</span><br><span class="line">  /&gt;</span><br></pre></td></tr></table></figure>

<p>  测试一下   <img src="http://halo-ctc.qiniu.ctcnb.cn/markdown/api/image-20230113164234500.png">   emmmm… 这是什么玩意??   查询官方文档可知，这是ProTable的默认type 所以我们需要给它指定一个form的type  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">const CreateModal: React.FC&lt;Props&gt; = (props) =&gt; &#123;</span><br><span class="line">  const &#123; columns, open, onCancel &#125; = props;</span><br><span class="line">  return (</span><br><span class="line">    &lt;Modal open=&#123;open&#125; onCancel=&#123;() =&gt; onCancel?.()&#125;&gt;</span><br><span class="line">      &lt;ProTable columns=&#123;columns&#125; type=&#123;&#x27;form&#x27;&#125; /&gt;</span><br><span class="line">    &lt;/Modal&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>  再测试一下就正常啦~   <img src="http://halo-ctc.qiniu.ctcnb.cn/markdown/api/image-20230113164846052.png">   发现创建时间、更新时间我们并不需要。增加hideInForm属性  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  title: &#x27;创建时间&#x27;,</span><br><span class="line">  dataIndex: &#x27;createTime&#x27;,</span><br><span class="line">  valueType: &#x27;dateTime&#x27;,</span><br><span class="line">  hideInForm: true,</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">  title: &#x27;更新时间&#x27;,</span><br><span class="line">  dataIndex: &#x27;updateTime&#x27;,</span><br><span class="line">  valueType: &#x27;dateTime&#x27;,</span><br><span class="line">  hideInForm: true,</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<p> </p>
<h3 id="2）请求后端"><a href="#2）请求后端" class="headerlink" title="2）请求后端"></a>2）请求后端</h3><p>  <strong>先简单处理一下请求报错的情况</strong>   找到src&#x2F;requestConfig.ts 修改一下响应拦截器  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">// 响应拦截器</span><br><span class="line">responseInterceptors: [</span><br><span class="line">  (response) =&gt; &#123;</span><br><span class="line">    // 拦截响应数据，进行个性化处理</span><br><span class="line">    const &#123; data &#125; = response as unknown as ResponseStructure;</span><br><span class="line">    console.log(&#x27;data&#x27;, data);</span><br><span class="line">    if (data.code !== 0) &#123;</span><br><span class="line">      throw new Error(data.message);</span><br><span class="line">    &#125;</span><br><span class="line">    return response;</span><br><span class="line">  &#125;,</span><br><span class="line">],</span><br></pre></td></tr></table></figure>

<p>  再在interfaceinfo&#x2F;index.tsx中新增请求后端的方法  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">  const handleAddInterfaceInfo = async (fields: API.InterfaceInfoAddRequest) =&gt; &#123;</span><br><span class="line">    const hide = message.loading(&#x27;正在添加&#x27;);</span><br><span class="line">    try &#123;</span><br><span class="line">      await addInterfaceInfoUsingPOST(&#123; ...fields &#125;);</span><br><span class="line">      hide();</span><br><span class="line">      message.success(&#x27;创建成功!&#x27;);</span><br><span class="line">      // 关闭Modal</span><br><span class="line">      handleModalOpen(false);</span><br><span class="line">      return true;</span><br><span class="line">    &#125; catch (error: any) &#123;</span><br><span class="line">      hide();</span><br><span class="line">      console.log(error);</span><br><span class="line">      message.error(&#x27;创建失败!&#x27; + error.message);</span><br><span class="line">      return false;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">// ...</span><br><span class="line"></span><br><span class="line">&lt;CreateModal</span><br><span class="line">  columns=&#123;columns&#125;</span><br><span class="line">  onCancel=&#123;() =&gt; handleModalOpen(false)&#125;</span><br><span class="line">  onSubmit=&#123;(values) =&gt; handleAddInterfaceInfo(values)&#125;</span><br><span class="line">  open=&#123;createModalOpen&#125;</span><br><span class="line">  /&gt;</span><br></pre></td></tr></table></figure>

<p>  再修改CreateModal.tsx  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">const CreateModal: React.FC&lt;Props&gt; = (props) =&gt; &#123;</span><br><span class="line">  const &#123; columns, open, onCancel, onSubmit &#125; = props;</span><br><span class="line">  return (</span><br><span class="line">    &lt;Modal title=&#123;&#x27;新建接口&#x27;&#125; open=&#123;open&#125; onCancel=&#123;() =&gt; onCancel?.()&#125;&gt;</span><br><span class="line">      &lt;ProTable columns=&#123;columns&#125; type=&#123;&#x27;form&#x27;&#125; onSubmit=&#123;async (value) =&gt; onSubmit?.(value)&#125; /&gt;</span><br><span class="line">    &lt;/Modal&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>  测试添加成功   <img src="http://halo-ctc.qiniu.ctcnb.cn/markdown/api/image-20230113183349785.png">  </p>
<h2 id="3、编辑接口信息"><a href="#3、编辑接口信息" class="headerlink" title="3、编辑接口信息"></a>3、编辑接口信息</h2><hr>
<p>先把Modal的footer干掉   footer&#x3D;{null}  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;Modal title=&#123;&#x27;更新接口&#x27;&#125; footer=&#123;null&#125; open=&#123;open&#125; onCancel=&#123;() =&gt; onCancel?.()&#125;&gt;</span><br><span class="line">  // ...</span><br><span class="line">  );</span><br></pre></td></tr></table></figure>

<p> </p>
<h3 id="1）表单模块-1"><a href="#1）表单模块-1" class="headerlink" title="1）表单模块"></a>1）表单模块</h3><p>  新建文件src&#x2F;pages&#x2F;InterfaceInfo&#x2F;components&#x2F;UpdateModal.tsx   这里使用的useRef、formRef参考了<a target="_blank" rel="noopener" href="https://procomponents.ant.design/components/table#%E9%80%9A%E8%BF%87-formref-%E6%9D%A5%E6%93%8D%E4%BD%9C%E6%9F%A5%E8%AF%A2%E8%A1%A8%E5%8D%95">官方文档</a>  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">import &#123; Modal &#125; from &#x27;antd&#x27;;</span><br><span class="line">import React, &#123;useEffect, useRef&#125; from &#x27;react&#x27;;</span><br><span class="line">import &#123; ProColumns, ProFormInstance, ProTable &#125; from &#x27;@ant-design/pro-components&#x27;;</span><br><span class="line">import &#x27;@umijs/max&#x27;;</span><br><span class="line"></span><br><span class="line">export type Props = &#123;</span><br><span class="line">  value: API.InterfaceInfo;</span><br><span class="line">  columns: ProColumns&lt;API.InterfaceInfoUpdateRequest&gt;[];</span><br><span class="line">  onCancel: () =&gt; void;</span><br><span class="line">  onSubmit: (values: API.InterfaceInfoUpdateRequest) =&gt; Promise&lt;void&gt;;</span><br><span class="line">  open: boolean;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">const UpdateModal: React.FC&lt;Props&gt; = (props) =&gt; &#123;</span><br><span class="line">  const &#123; value, columns, open, onCancel, onSubmit &#125; = props;</span><br><span class="line"></span><br><span class="line">  const formRef = useRef&lt;ProFormInstance&gt;();</span><br><span class="line"></span><br><span class="line">  useEffect(() =&gt; &#123;</span><br><span class="line">    if (formRef) &#123;</span><br><span class="line">      formRef.current?.setFieldsValue(value);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, [value]);</span><br><span class="line"></span><br><span class="line">  return (</span><br><span class="line">    &lt;Modal title=&#123;&#x27;更新接口&#x27;&#125; footer=&#123;null&#125; open=&#123;open&#125; onCancel=&#123;() =&gt; onCancel?.()&#125;&gt;</span><br><span class="line">      &lt;ProTable</span><br><span class="line">        columns=&#123;columns&#125;</span><br><span class="line">        formRef=&#123;formRef&#125;</span><br><span class="line">        type=&#123;&#x27;form&#x27;&#125;</span><br><span class="line">        onSubmit=&#123;async (value) =&gt; onSubmit?.(value)&#125;</span><br><span class="line">        // 设置默认值</span><br><span class="line">        form=&#123;&#123; initialValues: value &#125;&#125;</span><br><span class="line">      /&gt;</span><br><span class="line">    &lt;/Modal&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">export default UpdateModal;</span><br></pre></td></tr></table></figure>

<p> </p>
<h3 id="2）请求后端-1"><a href="#2）请求后端-1" class="headerlink" title="2）请求后端"></a>2）请求后端</h3><p>  在interfaceinfo&#x2F;index.tsx中新增请求后端的方法  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">  /**</span><br><span class="line">   * @en-US Update InterfaceInfo</span><br><span class="line">   * @zh-CN 更新接口信息</span><br><span class="line">   *</span><br><span class="line">   * @param updateValue</span><br><span class="line">   */</span><br><span class="line">  const handleUpdateInterfaceInfo = async (updateValue: API.InterfaceInfoUpdateRequest) =&gt; &#123;</span><br><span class="line">    const hide = message.loading(&#x27;正在更新&#x27;);</span><br><span class="line">    try &#123;</span><br><span class="line">      let res = await updateInterfaceInfoUsingPOST(&#123; ...updateValue &#125;);</span><br><span class="line">      if (res.data) &#123;</span><br><span class="line">        hide();</span><br><span class="line">        handleUpdateModalOpen(false);</span><br><span class="line">        message.success(&#x27;更新成功!&#x27;);</span><br><span class="line">        return true;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; catch (error: any) &#123;</span><br><span class="line">      hide();</span><br><span class="line">      message.error(&#x27;更新失败!&#x27; + error.message);</span><br><span class="line">      return false;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;      </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// 这里的&lt;UpdateModal/&gt;代码是在原有的 &lt;UpdateForm/&gt; 基础上面改的</span><br><span class="line">&lt;UpdateModal</span><br><span class="line">        value=&#123;currentRow  &#123;&#125;&#125;</span><br><span class="line">        columns=&#123;columns&#125;</span><br><span class="line">        open=&#123;updateModalOpen&#125;</span><br><span class="line">        onSubmit=&#123;async (value) =&gt; &#123;</span><br><span class="line">          const success = await handleUpdateInterfaceInfo(value);</span><br><span class="line">          if (success) &#123;</span><br><span class="line">            handleUpdateModalOpen(false);</span><br><span class="line">            setCurrentRow(undefined);</span><br><span class="line">            if (actionRef.current) &#123;</span><br><span class="line">              actionRef.current.reload();</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;&#125;</span><br><span class="line">        onCancel=&#123;() =&gt; &#123;</span><br><span class="line">          handleUpdateModalOpen(false);</span><br><span class="line">          if (!showDetail) &#123;</span><br><span class="line">            setCurrentRow(undefined);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;&#125;</span><br><span class="line">      /&gt;</span><br></pre></td></tr></table></figure>

<p>  出错了，猜测是Ant Design Pro的问题，猜错了，其实是columns中的id的type为index的原因。并没有id字段，所以我手动给一下   <img src="http://halo-ctc.qiniu.ctcnb.cn/markdown/api/image-20230113222955554.png">   修改代码如下  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">   * @en-US Update InterfaceInfo</span><br><span class="line">   * @zh-CN 更新接口信息</span><br><span class="line">   *</span><br><span class="line">   * @param fields</span><br><span class="line">   */</span><br><span class="line">  const handleUpdateInterfaceInfo = async (fields: API.InterfaceInfoUpdateRequest) =&gt; &#123;</span><br><span class="line">    const hide = message.loading(&#x27;正在更新&#x27;);</span><br><span class="line">    try &#123;</span><br><span class="line">      if(!currentRow)&#123;</span><br><span class="line">        return false;</span><br><span class="line">      &#125;</span><br><span class="line">      let res = await updateInterfaceInfoUsingPOST(&#123;</span><br><span class="line">        // 因为columns中的id valueType为index 不会传递 所以我们需要手动赋值id</span><br><span class="line">        id: currentRow.id,</span><br><span class="line">        ...fields,</span><br><span class="line">      &#125;);</span><br><span class="line">      if (res.data) &#123;</span><br><span class="line">        hide();</span><br><span class="line">        handleUpdateModalOpen(false);</span><br><span class="line">        message.success(&#x27;更新成功!&#x27;);</span><br><span class="line">        // 刷新页面</span><br><span class="line">        actionRef.current?.reload();</span><br><span class="line">        return true;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; catch (error: any) &#123;</span><br><span class="line">      hide();</span><br><span class="line">      message.error(&#x27;更新失败!&#x27; + error.message);</span><br><span class="line">      return false;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>

<p>  测试更新成功~  </p>
<h2 id="4、删除接口信息"><a href="#4、删除接口信息" class="headerlink" title="4、删除接口信息"></a>4、删除接口信息</h2><hr>
<p><strong>删除按钮</strong>  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">// 在columns中添加删除按钮</span><br><span class="line">&#123;</span><br><span class="line">      title: &#x27;操作&#x27;,</span><br><span class="line">      dataIndex: &#x27;option&#x27;,</span><br><span class="line">      valueType: &#x27;option&#x27;,</span><br><span class="line">      render: (_, record) =&gt; [</span><br><span class="line">        &lt;a</span><br><span class="line">          key=&quot;config&quot;</span><br><span class="line">          onClick=&#123;() =&gt; &#123;</span><br><span class="line">            handleUpdateModalOpen(true);</span><br><span class="line">            setCurrentRow(record);</span><br><span class="line">          &#125;&#125;</span><br><span class="line">        &gt;</span><br><span class="line">          编辑</span><br><span class="line">        &lt;/a&gt;,</span><br><span class="line">        &lt;a</span><br><span class="line">          key=&quot;delete&quot;</span><br><span class="line">          onClick=&#123;() =&gt; &#123;</span><br><span class="line">            handleRemoveInterfaceInfo(record);</span><br><span class="line">          &#125;&#125;</span><br><span class="line">        &gt;</span><br><span class="line">          删除</span><br><span class="line">        &lt;/a&gt;,</span><br><span class="line">      ],</span><br><span class="line">    &#125;,</span><br></pre></td></tr></table></figure>

<p>  <strong>调用方法</strong>  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">const handleRemoveInterfaceInfo = async (record: API.InterfaceInfo) =&gt; &#123;</span><br><span class="line">  const hide = message.loading(&#x27;正在删除&#x27;);</span><br><span class="line">  if (!record) return true;</span><br><span class="line">  try &#123;</span><br><span class="line">    await deleteInterfaceInfoUsingPOST(&#123;</span><br><span class="line">      id: record.id,</span><br><span class="line">    &#125;);</span><br><span class="line">    hide();</span><br><span class="line">    message.success(&#x27;删除成功!&#x27;);</span><br><span class="line">    // 刷新页面</span><br><span class="line">    actionRef.current?.reload();</span><br><span class="line">    return true;</span><br><span class="line">  &#125; catch (error: any) &#123;</span><br><span class="line">    hide();</span><br><span class="line">    message.error(&#x27;删除失败!&#x27; + error.message);</span><br><span class="line">    return false;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>  测试删除成功~   <img src="http://halo-ctc.qiniu.ctcnb.cn/markdown/api/image-20230114154218713.png">  </p>
<h1 id="三、API开发"><a href="#三、API开发" class="headerlink" title="三、API开发"></a>三、API开发</h1><hr>
<h2 id="1、模拟接口"><a href="#1、模拟接口" class="headerlink" title="1、模拟接口"></a>1、模拟接口</h2><hr>
<p><strong>创建项目</strong>   快速创建一个spring Boot项目 勾选SpringWeb、Lombok、Spring Boot DevTools   <strong>提供三个模拟接口</strong>   接口大体内容  </p>
<ol>
<li><p>GET 接口</p>
</li>
<li><p>POST 接口（url传参）</p>
</li>
<li><p>POST接口（Restful）</p>
</li>
</ol>
<p>  简单的项目结构   <img src="http://halo-ctc.qiniu.ctcnb.cn/markdown/api/image-20230114233348076.png">  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">package com.xuan.controller;</span><br><span class="line"></span><br><span class="line">import com.xuan.model.User;</span><br><span class="line">import org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 模拟接口</span><br><span class="line"> * </span><br><span class="line"> * @version 1.0</span><br><span class="line"> * @author: 玄</span><br><span class="line"> * @date: 2023/1/14</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">@RestController</span><br><span class="line">@RequestMapping(&quot;/name&quot;)</span><br><span class="line">public class NameController &#123;</span><br><span class="line"></span><br><span class="line">@GetMapping(&quot;/&#123;name&#125;&quot;)</span><br><span class="line">public String getNameByGet(@PathVariable(value = &quot;name&quot;) String name) &#123;</span><br><span class="line">return &quot;发送GET请求 你的名字是：&quot; + name;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@PostMapping()</span><br><span class="line">public String getNameByPost(@RequestParam(value = &quot;name&quot;) String name) &#123;</span><br><span class="line">return &quot;发送POST请求 你的名字是：&quot; + name;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@PostMapping(&quot;/user&quot;)</span><br><span class="line">public String getNameByPostWithJson(@RequestBody User user) &#123;</span><br><span class="line">return &quot;发送POST请求 JSON中你的名字是：&quot; + user.getName();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>  application.yml配置一下端口、然后指定一下全局接口的地址  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">server:</span><br><span class="line">  port: 8123</span><br><span class="line">  servlet:</span><br><span class="line">    context-path: /api</span><br></pre></td></tr></table></figure>

<p> </p>
<h2 id="2、调用接口"><a href="#2、调用接口" class="headerlink" title="2、调用接口"></a>2、调用接口</h2><hr>
<p><strong>几种HTTP的调用方式：</strong>  </p>
<ol>
<li><p>HttpClient</p>
</li>
<li><p>RestTemplate</p>
</li>
<li><p>第三方库（OKHttp，Hutool）</p>
</li>
</ol>
<p>  这里我使用了<strong>Hutool</strong>调用 <a target="_blank" rel="noopener" href="https://hutool.cn/docs/#/">hutool文档</a>   maven中添加  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;cn.hutool&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;hutool-all&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;5.8.11&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<p>  查看文档中的Http请求相关用法 编写XuanApiClient类  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">package com.xuan.client;</span><br><span class="line"></span><br><span class="line">import cn.hutool.http.HttpRequest;</span><br><span class="line">import cn.hutool.http.HttpResponse;</span><br><span class="line">import cn.hutool.http.HttpUtil;</span><br><span class="line">import cn.hutool.json.JSONUtil;</span><br><span class="line">import com.xuan.model.User;</span><br><span class="line"></span><br><span class="line">import java.util.HashMap;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 调用API使用</span><br><span class="line"> *</span><br><span class="line"> * @version 1.0</span><br><span class="line"> * @author: 玄</span><br><span class="line"> * @date: 2023/1/15</span><br><span class="line"> */</span><br><span class="line">public class XuanApiClient &#123;</span><br><span class="line">public String getNameByGet(String name) &#123;</span><br><span class="line">return HttpUtil.get(&quot;http://localhost:8123/api/name/&quot; + name);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public String getNameByPost(String name) &#123;</span><br><span class="line">// 可以单独传入http参数，这样参数会自动做URL编码，拼接在URL中</span><br><span class="line">HashMap&lt;String, Object&gt; paramMap = new HashMap&lt;&gt;();</span><br><span class="line">paramMap.put(&quot;name&quot;, name);</span><br><span class="line">return HttpUtil.post(&quot;http://localhost:8123/api/name&quot;, paramMap);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public String getNameByPostWithJson(User user) &#123;</span><br><span class="line">String json = JSONUtil.toJsonStr(user);</span><br><span class="line">HttpResponse response = HttpRequest.post(&quot;http://localhost:8123/api/name/user&quot;)</span><br><span class="line">.body(json)</span><br><span class="line">.execute();</span><br><span class="line">System.out.println(&quot;response = &quot; + response);</span><br><span class="line">System.out.println(&quot;status = &quot; + response.getStatus());</span><br><span class="line">if (response.isOk()) &#123;</span><br><span class="line">return response.body();</span><br><span class="line">&#125;</span><br><span class="line">return &quot;fail&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>  创建测试类调用测试   <img src="http://halo-ctc.qiniu.ctcnb.cn/markdown/api/image-20230115162508894.png">  </p>
<h1 id="四、API签名认证"><a href="#四、API签名认证" class="headerlink" title="四、API签名认证"></a>四、API签名认证</h1><hr>
<p><strong>本质：</strong>  </p>
<ol>
<li><p>签发签名</p>
</li>
<li><p>使用签名（校验签名）</p>
</li>
</ol>
<p>  <strong>为什么需要</strong>   保证安全性，不能随便一个人就可以调用   <strong>怎么实现</strong>  </p>
<ul>
<li><p><strong>accessKey</strong> 调用的标识（复杂，无序，无规律）</p>
</li>
<li><p><strong>secretKey</strong> 密钥 （复杂，无序，无规律）</p>
</li>
</ul>
<p>  类似<strong>用户名</strong>和<strong>密码</strong>，区别：accessKey、secretKey是<strong>无状态</strong>的   千万不能把密钥直接在服务器间进行传递，有可能被拦截   加密看第二点  </p>
<h2 id="1、修改数据库"><a href="#1、修改数据库" class="headerlink" title="1、修改数据库"></a>1、修改数据库</h2><hr>
<p>由于我们的<strong>user表</strong>里面没有access_key、secret_key 所以我们要修改数据库表  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">create table if not exists user</span><br><span class="line">(</span><br><span class="line">    id            bigint auto_increment comment &#x27;id&#x27; primary key,</span><br><span class="line">    user_name     varchar(256)                           null comment &#x27;用户昵称&#x27;,</span><br><span class="line">    user_account  varchar(256)                           not null comment &#x27;账号&#x27;,</span><br><span class="line">    user_avatar   varchar(1024)                          null comment &#x27;用户头像&#x27;,</span><br><span class="line">    gender        tinyint                                null comment &#x27;性别&#x27;,</span><br><span class="line">    user_role     varchar(256) default &#x27;user&#x27;            not null comment &#x27;用户角色：user / admin&#x27;,</span><br><span class="line">    user_password varchar(512)                           not null comment &#x27;密码&#x27;,</span><br><span class="line">    access_key    varchar(256)                           null comment &#x27;access_key&#x27;,</span><br><span class="line">    secret_key    varchar(256)                           null comment &#x27;secret_key&#x27;,</span><br><span class="line">    create_time   datetime     default CURRENT_TIMESTAMP not null comment &#x27;创建时间&#x27;,</span><br><span class="line">    update_time   datetime     default CURRENT_TIMESTAMP not null on update CURRENT_TIMESTAMP comment &#x27;更新时间&#x27;,</span><br><span class="line">    is_delete     tinyint      default 0                 not null comment &#x27;是否删除&#x27;,</span><br><span class="line">    constraint uni_user_account</span><br><span class="line">        unique (user_account)</span><br><span class="line">) comment &#x27;用户&#x27;;</span><br></pre></td></tr></table></figure>

<p>  直接drop掉之前的table重新建表，插入一条测试数据。   标准的话 应该新建一个表 主要字段为接口id、使用用户id、access_key、secret_key等等  </p>
<h2 id="2、加密"><a href="#2、加密" class="headerlink" title="2、加密"></a>2、加密</h2><hr>
<h3 id="1、加密方式"><a href="#1、加密方式" class="headerlink" title="1、加密方式"></a>1、加密方式</h3><p>  将accessKey、secretKey放在Header里明文传递安全吗   答案是否定的，因为我们的<strong>请求可能被人拦截</strong>，而我们把密码放进请求头里面，可能会被别人获取   一般是根据密钥，生成<strong>签名sign</strong>   <strong>加密方式</strong>  </p>
<ol>
<li><p>对称加密</p>
</li>
<li><p>非对称加密</p>
</li>
<li><p>md5 签名（不可解密）</p>
</li>
</ol>
<p>  <strong>签名的做法</strong>   假如 ，我们有用户参数，我们用密钥与他拼接，用签名算法得到一个不可解密的值   <strong>用户参数 + 密钥 &#x3D;&gt; 签名生成算法（MD5,HMac,Sha1) &#x3D;&gt; 不可解密的值</strong>   例子： xuan + abc &#x3D;&gt; 7e7b9583aa0bc3e834fe8bcaebda38b5（这里是我随便输的，得到的值是随机的）   怎么知道签名对不对？   服务端用一模一样的参数和算法去生成签名，只要和用户传的一致，就表示密钥一致   <strong>怎么防重放？</strong>   加nonce随机数 只能用一次   服务端要保存用过的随机数   加timestamp 时间戳，校验它的有效期   综上所属   <strong>传递的参数</strong>  </p>
<ol>
<li><p>accessKey</p>
</li>
<li><p>sign （由accessKey(或者使用用户请求参数body等)、secretKey加密而来）</p>
</li>
<li><p>nonce随机数</p>
</li>
<li><p>timestamp</p>
</li>
<li><p>body（用户请求参数 可要可不要）</p>
</li>
</ol>
<p>  <strong>API签名认证是一个很灵活的设计，具体要有哪些参数，尽量服务端调用，参数名如何要根据场景来。</strong>  </p>
<h3 id="2、加密代码"><a href="#2、加密代码" class="headerlink" title="2、加密代码"></a>2、加密代码</h3><p>  我这里直接使用了body、和secretKey进行加密   先创建一个加密签名类SignUtil.java  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">package com.xuan.util;</span><br><span class="line"></span><br><span class="line">import cn.hutool.crypto.digest.DigestUtil;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 签名工具类</span><br><span class="line"> *</span><br><span class="line"> * @version 1.0</span><br><span class="line"> * @author: 玄</span><br><span class="line"> * @date: 2023/1/15</span><br><span class="line"> */</span><br><span class="line">public class SignUtil &#123;</span><br><span class="line">public static String getSign(String body, String secretKey) &#123;</span><br><span class="line">String content = body + &quot;.&quot; + secretKey;</span><br><span class="line">return DigestUtil.md5Hex(content);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>  在Client类中新增构造Header的方法  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">public class XuanApiClient &#123;</span><br><span class="line"></span><br><span class="line">private final String accessKey;</span><br><span class="line">private final String secretKey;</span><br><span class="line"></span><br><span class="line">public XuanApiClient(String accessKey, String secretKey) &#123;</span><br><span class="line">this.accessKey = accessKey;</span><br><span class="line">this.secretKey = secretKey;</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">// ...</span><br><span class="line"></span><br><span class="line">public String getNameByPostWithJson(User user) &#123;</span><br><span class="line">String json = JSONUtil.toJsonStr(user);</span><br><span class="line">HttpResponse response = HttpRequest.post(&quot;http://localhost:8123/api/name/user&quot;)</span><br><span class="line">.addHeaders(getHeaders(json))</span><br><span class="line">.body(json)</span><br><span class="line">.execute();</span><br><span class="line">System.out.println(&quot;response = &quot; + response);</span><br><span class="line">System.out.println(&quot;status = &quot; + response.getStatus());</span><br><span class="line">if (response.isOk()) &#123;</span><br><span class="line">return response.body();</span><br><span class="line">&#125;</span><br><span class="line">return &quot;fail&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private Map&lt;String, String&gt; getHeaders(String body) throws UnsupportedEncodingException &#123;</span><br><span class="line">Map&lt;String, String&gt; header = new HashMap&lt;&gt;();</span><br><span class="line">header.put(&quot;accessKey&quot;, accessKey);</span><br><span class="line">header.put(&quot;sign&quot;, SignUtil.getSign(body, secretKey));</span><br><span class="line">// 防止中文乱码</span><br><span class="line">header.put(&quot;body&quot;, URLEncoder.encode(body, StandardCharsets.UTF_8.name()));</span><br><span class="line">header.put(&quot;nonce&quot;, RandomUtil.randomNumbers(5));</span><br><span class="line">header.put(&quot;timestamp&quot;, String.valueOf(System.currentTimeMillis()));</span><br><span class="line">return header;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>  调用API的时候加密代码已经写好了，显然我们在API中需要用同样的方法来验证加密。这里以携带JSON body的POST请求为例  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">package com.xuan.controller;</span><br><span class="line"></span><br><span class="line">import cn.hutool.core.util.NumberUtil;</span><br><span class="line">import cn.hutool.core.util.StrUtil;</span><br><span class="line">import com.xuan.model.User;</span><br><span class="line">import com.xuan.util.SignUtil;</span><br><span class="line">import org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line">import javax.servlet.http.HttpServletRequest;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 模拟接口</span><br><span class="line"> *</span><br><span class="line"> * @version 1.0</span><br><span class="line"> * @author: 玄</span><br><span class="line"> * @date: 2023/1/14</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">@RestController</span><br><span class="line">@RequestMapping(&quot;/name&quot;)</span><br><span class="line">public class NameController &#123;</span><br><span class="line"></span><br><span class="line">@PostMapping(&quot;/user&quot;)</span><br><span class="line">public String getNameByPostWithJson(@RequestBody User user, HttpServletRequest request) throws UnsupportedEncodingException &#123;</span><br><span class="line">String accessKey = request.getHeader(&quot;accessKey&quot;);</span><br><span class="line">// 防止中文乱码</span><br><span class="line">String body = URLDecoder.decode(request.getHeader(&quot;body&quot;), StandardCharsets.UTF_8.name());</span><br><span class="line">String sign = request.getHeader(&quot;sign&quot;);</span><br><span class="line">String nonce = request.getHeader(&quot;nonce&quot;);</span><br><span class="line">String timestamp = request.getHeader(&quot;timestamp&quot;);</span><br><span class="line">boolean hasBlank = StrUtil.hasBlank(accessKey, body, sign, nonce, timestamp);</span><br><span class="line">// 判断是否有空</span><br><span class="line">if (hasBlank) &#123;</span><br><span class="line">return &quot;无权限&quot;;</span><br><span class="line">&#125;</span><br><span class="line">// TODO 使用accessKey去数据库查询secretKey</span><br><span class="line">// 假设查到的secret是abc 进行加密得到sign</span><br><span class="line">String secretKey = &quot;abc&quot;;</span><br><span class="line">String sign1 = SignUtil.getSign(body, secretKey);</span><br><span class="line">if (!StrUtil.equals(sign, sign1)) &#123;</span><br><span class="line">return &quot;无权限&quot;;</span><br><span class="line">&#125;</span><br><span class="line">// TODO 判断随机数nonce</span><br><span class="line">// 时间戳是否为数字</span><br><span class="line">if (!NumberUtil.isNumber(timestamp)) &#123;</span><br><span class="line">return &quot;无权限&quot;;</span><br><span class="line">&#125;</span><br><span class="line">// 五分钟内的请求有效</span><br><span class="line">if (System.currentTimeMillis() - Long.parseLong(timestamp) &gt; 5 * 60 * 1000) &#123;</span><br><span class="line">return &quot;无权限&quot;;</span><br><span class="line">&#125;</span><br><span class="line">return &quot;发送POST请求 JSON中你的名字是：&quot; + user.getName();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>  进行测试secretKey &#x3D; “abc” 可以正确访问，当secret错误时返回无权限～      </p>
<h1 id="五、开发一个SDK（starter）"><a href="#五、开发一个SDK（starter）" class="headerlink" title="五、开发一个SDK（starter）"></a>五、开发一个SDK（starter）</h1><hr>
<p>理想情况：开发者只需要关心调用哪些接口、传递哪些参数。就跟调用自己写的代码一样简单。   开发starter的好处：开发者引入之后，可以直接在application.yml中写配置，自动创建客户端  </p>
<h2 id="1、新建项目"><a href="#1、新建项目" class="headerlink" title="1、新建项目"></a>1、新建项目</h2><p>  创建一个xuanapi-client-sdk的springboot项目 勾选lombok、Spring Configuration Processor（作用：自动生成配置的代码提示）   然后处理pom.xml   这个一定需要删除因为这个是maven的构建项目成可运行jar包。现在是制作starter依赖包   <img src="http://halo-ctc.qiniu.ctcnb.cn/markdown/api/image-20230116142827466.png">  </p>
<h2 id="2、编写配置类"><a href="#2、编写配置类" class="headerlink" title="2、编写配置类"></a>2、编写配置类</h2><p>  我们不需要spring boot启动类，将其删去。   然后将之前编写好的client、util、model粘贴过来   <img src="http://halo-ctc.qiniu.ctcnb.cn/markdown/api/image-20230116153646366.png">   再新建配置类  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">@Data</span><br><span class="line">@ComponentScan</span><br><span class="line">@Configuration</span><br><span class="line">@ConfigurationProperties(prefix = &quot;xuan.api.client&quot;)</span><br><span class="line">public class XuanApiClientConfig &#123;</span><br><span class="line">private String accessKey;</span><br><span class="line">private String secretKey;</span><br><span class="line"></span><br><span class="line">@Bean</span><br><span class="line">public XuanApiClient xuanApiClient() &#123;</span><br><span class="line">return new XuanApiClient(accessKey, secretKey);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> </p>
<h2 id="3、指定配置类"><a href="#3、指定配置类" class="headerlink" title="3、指定配置类"></a>3、指定配置类</h2><p>  新建resources&#x2F;META-INF&#x2F;spring.factories并指定  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># spring boot starter</span><br><span class="line">org.springframework.boot.autoconfigure.EnableAutoConfiguration=com.xuan.XuanApiClientConfig</span><br></pre></td></tr></table></figure>

<p>  <img src="http://halo-ctc.qiniu.ctcnb.cn/markdown/api/image-20230116153954227.png">  </p>
<h2 id="4、发布starter"><a href="#4、发布starter" class="headerlink" title="4、发布starter"></a>4、发布starter</h2><p>  双击Maven lifecycle下的install或者命令行mvn install   <img src="http://halo-ctc.qiniu.ctcnb.cn/markdown/api/image-20230116154259164.png">  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[INFO] Installing /Users/xuan/Desktop/project/api-platform/xuanapi-client-sdk/target/xuanapi-client-sdk-0.0.1.jar to /Users/xuan/.m2/repository/com/xuan/xuanapi-client-sdk/0.0.1/xuanapi-client-sdk-0.0.1.jar</span><br><span class="line">[INFO] Installing /Users/xuan/Desktop/project/api-platform/xuanapi-client-sdk/pom.xml to /Users/xuan/.m2/repository/com/xuan/xuanapi-client-sdk/0.0.1/xuanapi-client-sdk-0.0.1.pom</span><br></pre></td></tr></table></figure>

<p> </p>
<h2 id="5、测试"><a href="#5、测试" class="headerlink" title="5、测试"></a>5、测试</h2><p>  <strong>引入依赖</strong>   回到xuan-Interface项目，把之前的client、util、model全部删掉。然后在pom中引入我们刚刚制作好的starter   注意：这里能直接引入，是因为刚刚我们install的stater在我们的本地，可以发布到Maven仓库或者提供jar包供大家使用。  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--自己制作的starter--&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.xuan&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;xuanapi-client-sdk&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;0.0.1&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<p>  <strong>配置信息</strong>   <img src="http://halo-ctc.qiniu.ctcnb.cn/markdown/api/image-20230116155915000.png">   我们在yml文件中配置的时候有提示就是之前引入的Spring Configuration Processor发挥的作用。打开依赖源码分析可得是这个json文件的作用   <img src="http://halo-ctc.qiniu.ctcnb.cn/markdown/api/image-20230116160142141.png">   在测试类使用@Resource注入XuanApiClient进行测试   <img src="http://halo-ctc.qiniu.ctcnb.cn/markdown/api/image-20230116160643683.png">   yml中secret不正确也会返回 “无权限”  </p>
<h1 id="六、接口发布-下线"><a href="#六、接口发布-下线" class="headerlink" title="六、接口发布&#x2F;下线"></a>六、接口发布&#x2F;下线</h1><hr>
<p>这个功能首先是仅管理员使用的   <strong>发布接口</strong>  </p>
<ol>
<li><p>校验该接口是否存在</p>
</li>
<li><p>判断接口是否可以被调用</p>
</li>
<li><p>修改数据库接口字段为1</p>
</li>
</ol>
<p>  <strong>下线接口</strong>  </p>
<ol>
<li><p>校验该接口是否存在</p>
</li>
<li><p>修改数据库接口字段为 0</p>
</li>
</ol>
<p> </p>
<h2 id="1、后端"><a href="#1、后端" class="headerlink" title="1、后端"></a>1、后端</h2><hr>
<ol>
<li><strong>通用请求类</strong> 上下线都是通过id来控制的</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 通过id发送请求</span><br><span class="line"> *</span><br><span class="line"> * @author xuan</span><br><span class="line"> */</span><br><span class="line">@Data</span><br><span class="line">public class IdRequest implements Serializable &#123;</span><br><span class="line">    /**</span><br><span class="line">     * id</span><br><span class="line">     */</span><br><span class="line">    private Long id;</span><br><span class="line"></span><br><span class="line">    private static final long serialVersionUID = 1L;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> </p>
<ol start="2">
<li><strong>枚举类</strong> 使用枚举类来表示上线&#x2F;下线状态</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">package com.xuan.project.model.enums;</span><br><span class="line"></span><br><span class="line">import java.util.Arrays;</span><br><span class="line">import java.util.List;</span><br><span class="line">import java.util.stream.Collectors;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 接口状态枚举</span><br><span class="line"> *</span><br><span class="line"> * @author xuan</span><br><span class="line"> */</span><br><span class="line">public enum InterfaceInfoStatusEnum &#123;</span><br><span class="line"></span><br><span class="line">    OFFLINE(&quot;下线&quot;, 0),</span><br><span class="line">    ONLINE(&quot;上线&quot;, 1);</span><br><span class="line"></span><br><span class="line">    private final String text;</span><br><span class="line"></span><br><span class="line">    private final int value;</span><br><span class="line"></span><br><span class="line">    InterfaceInfoStatusEnum(String text, int value) &#123;</span><br><span class="line">        this.text = text;</span><br><span class="line">        this.value = value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     *</span><br><span class="line">     * @return 获取值列表</span><br><span class="line">     */</span><br><span class="line">    public static List&lt;Integer&gt; getValues() &#123;</span><br><span class="line">        return Arrays.stream(values()).map(item -&gt; item.value).collect(Collectors.toList());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public int getValue() &#123;</span><br><span class="line">        return value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getText() &#123;</span><br><span class="line">        return text;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> </p>
<ol start="3">
<li><strong>在controller里编写上下线代码</strong> 这里有个TODO 判断该接口是否可以调用时，由XuanApiClient固定方法名改为根据测试地址来调用</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * API信息接口</span><br><span class="line"> *</span><br><span class="line"> * @author xuan</span><br><span class="line"> */</span><br><span class="line">@RestController</span><br><span class="line">@RequestMapping(&quot;/interfaceInfo&quot;)</span><br><span class="line">@Slf4j</span><br><span class="line">public class InterfaceInfoController &#123;</span><br><span class="line"></span><br><span class="line">@Resource</span><br><span class="line">private InterfaceInfoService interfaceInfoService;</span><br><span class="line"></span><br><span class="line">@Resource</span><br><span class="line">private UserService userService;</span><br><span class="line"></span><br><span class="line">@Resource</span><br><span class="line">private XuanApiClient xuanApiClient;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 上线接口</span><br><span class="line"> *</span><br><span class="line"> * @param idRequest 携带id</span><br><span class="line"> * @return 是否上线成功</span><br><span class="line"> */</span><br><span class="line">@PostMapping(&quot;/online&quot;)</span><br><span class="line">@AuthCheck(mustRole = &quot;admin&quot;)</span><br><span class="line">public BaseResponse&lt;Boolean&gt; onlineInterfaceInfo(@RequestBody IdRequest idRequest) throws UnsupportedEncodingException &#123;</span><br><span class="line">if (idRequest == null  idRequest.getId() &lt; 0) &#123;</span><br><span class="line">throw new BusinessException(ErrorCode.PARAMS_ERROR);</span><br><span class="line">&#125;</span><br><span class="line">// 判断接口是否存在</span><br><span class="line">long id = idRequest.getId();</span><br><span class="line">InterfaceInfo oldInterfaceInfo = interfaceInfoService.getById(id);</span><br><span class="line">if (oldInterfaceInfo == null) &#123;</span><br><span class="line">throw new BusinessException(ErrorCode.NOT_FOUND_ERROR);</span><br><span class="line">&#125;</span><br><span class="line">// 判断接口是否能使用</span><br><span class="line">// TODO 根据测试地址来调用</span><br><span class="line">// 这里我先用固定的方法进行测试，后面来改</span><br><span class="line">com.xuan.model.User user = new com.xuan.model.User();</span><br><span class="line">user.setName(&quot;MARS&quot;);</span><br><span class="line">String name = xuanApiClient.getNameByPostWithJson(user);</span><br><span class="line">if (StrUtil.isBlank(name)) &#123;</span><br><span class="line">throw new BusinessException(ErrorCode.SYSTEM_ERROR, &quot;接口验证失败&quot;);</span><br><span class="line">&#125;</span><br><span class="line">// 更新数据库</span><br><span class="line">InterfaceInfo interfaceInfo = new InterfaceInfo();</span><br><span class="line">interfaceInfo.setId(id);</span><br><span class="line">interfaceInfo.setStatus(InterfaceInfoStatusEnum.ONLINE.getValue());</span><br><span class="line">boolean isSuccessful = interfaceInfoService.updateById(interfaceInfo);</span><br><span class="line">return ResultUtils.success(isSuccessful);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 下线接口</span><br><span class="line"> *</span><br><span class="line"> * @param idRequest 携带id</span><br><span class="line"> * @return 是否下线成功</span><br><span class="line"> */</span><br><span class="line">@PostMapping(&quot;/offline&quot;)</span><br><span class="line">@AuthCheck(mustRole = &quot;admin&quot;)</span><br><span class="line">public BaseResponse&lt;Boolean&gt; offlineInterfaceInfo(@RequestBody IdRequest idRequest) &#123;</span><br><span class="line">if (idRequest == null  idRequest.getId() &lt; 0) &#123;</span><br><span class="line">throw new BusinessException(ErrorCode.PARAMS_ERROR);</span><br><span class="line">&#125;</span><br><span class="line">// 判断接口是否存在</span><br><span class="line">long id = idRequest.getId();</span><br><span class="line">InterfaceInfo oldInterfaceInfo = interfaceInfoService.getById(id);</span><br><span class="line">if (oldInterfaceInfo == null) &#123;</span><br><span class="line">throw new BusinessException(ErrorCode.NOT_FOUND_ERROR);</span><br><span class="line">&#125;</span><br><span class="line">// 更新数据库</span><br><span class="line">InterfaceInfo interfaceInfo = new InterfaceInfo();</span><br><span class="line">interfaceInfo.setId(id);</span><br><span class="line">interfaceInfo.setStatus(InterfaceInfoStatusEnum.OFFLINE.getValue());</span><br><span class="line">boolean isSuccessful = interfaceInfoService.updateById(interfaceInfo);</span><br><span class="line">return ResultUtils.success(isSuccessful);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> </p>
<ol start="4">
<li><strong>权限控制</strong> 这里添加权限校验，这里用到<a href="/AuthCheck(mustRole"><strong>@AuthCheck(mustRole</strong></a> <strong>= “admin”)</strong> 的切面注解，对应的实现方法在aop&#x2F;AuthInterceptor</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">package com.xuan.project.annotation;</span><br><span class="line"></span><br><span class="line">import java.lang.annotation.ElementType;</span><br><span class="line">import java.lang.annotation.Retention;</span><br><span class="line">import java.lang.annotation.RetentionPolicy;</span><br><span class="line">import java.lang.annotation.Target;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 权限校验</span><br><span class="line"> *</span><br><span class="line"> * @author xuan</span><br><span class="line"> */</span><br><span class="line">@Target(ElementType.METHOD)</span><br><span class="line">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="line">public @interface AuthCheck &#123;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 有任何一个角色</span><br><span class="line">     *</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    String[] anyRole() default &quot;&quot;;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 必须有某个角色</span><br><span class="line">     *</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    String mustRole() default &quot;&quot;;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>aop&#x2F;AuthInterceptor.java</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">package com.xuan.project.aop;</span><br><span class="line"></span><br><span class="line">import com.baomidou.mybatisplus.core.toolkit.CollectionUtils;</span><br><span class="line">import com.xuan.project.common.ErrorCode;</span><br><span class="line">import com.xuan.project.exception.BusinessException;</span><br><span class="line">import com.xuan.project.model.entity.User;</span><br><span class="line">import com.xuan.project.service.UserService;</span><br><span class="line">import com.xuan.project.annotation.AuthCheck;</span><br><span class="line">import org.apache.commons.lang3.StringUtils;</span><br><span class="line">import org.aspectj.lang.ProceedingJoinPoint;</span><br><span class="line">import org.aspectj.lang.annotation.Around;</span><br><span class="line">import org.aspectj.lang.annotation.Aspect;</span><br><span class="line">import org.springframework.stereotype.Component;</span><br><span class="line">import org.springframework.web.context.request.RequestAttributes;</span><br><span class="line">import org.springframework.web.context.request.RequestContextHolder;</span><br><span class="line">import org.springframework.web.context.request.ServletRequestAttributes;</span><br><span class="line"></span><br><span class="line">import javax.annotation.Resource;</span><br><span class="line">import javax.servlet.http.HttpServletRequest;</span><br><span class="line">import java.util.Arrays;</span><br><span class="line">import java.util.List;</span><br><span class="line">import java.util.stream.Collectors;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 权限校验 AOP</span><br><span class="line"> *</span><br><span class="line"> * @author xuan</span><br><span class="line"> */</span><br><span class="line">@Aspect</span><br><span class="line">@Component</span><br><span class="line">public class AuthInterceptor &#123;</span><br><span class="line"></span><br><span class="line">    @Resource</span><br><span class="line">    private UserService userService;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 执行拦截</span><br><span class="line">     *</span><br><span class="line">     * @param joinPoint</span><br><span class="line">     * @param authCheck</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    @Around(&quot;@annotation(authCheck)&quot;)</span><br><span class="line">    public Object doInterceptor(ProceedingJoinPoint joinPoint, AuthCheck authCheck) throws Throwable &#123;</span><br><span class="line">        List&lt;String&gt; anyRole = Arrays.stream(authCheck.anyRole()).filter(StringUtils::isNotBlank).collect(Collectors.toList());</span><br><span class="line">        String mustRole = authCheck.mustRole();</span><br><span class="line">        RequestAttributes requestAttributes = RequestContextHolder.currentRequestAttributes();</span><br><span class="line">        HttpServletRequest request = ((ServletRequestAttributes) requestAttributes).getRequest();</span><br><span class="line">        // 当前登录用户</span><br><span class="line">        User user = userService.getLoginUser(request);</span><br><span class="line">        // 拥有任意权限即通过</span><br><span class="line">        if (CollectionUtils.isNotEmpty(anyRole)) &#123;</span><br><span class="line">            String userRole = user.getUserRole();</span><br><span class="line">            if (!anyRole.contains(userRole)) &#123;</span><br><span class="line">                throw new BusinessException(ErrorCode.NO_AUTH_ERROR);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        // 必须有所有权限才通过</span><br><span class="line">        if (StringUtils.isNotBlank(mustRole)) &#123;</span><br><span class="line">            String userRole = user.getUserRole();</span><br><span class="line">            if (!mustRole.equals(userRole)) &#123;</span><br><span class="line">                throw new BusinessException(ErrorCode.NO_AUTH_ERROR);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        // 通过权限校验，放行</span><br><span class="line">        return joinPoint.proceed();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>userService.getLoginUser(request)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 获取当前登录用户</span><br><span class="line"> *</span><br><span class="line"> * @param request</span><br><span class="line"> * @return</span><br><span class="line"> */</span><br><span class="line">@Override</span><br><span class="line">public User getLoginUser(HttpServletRequest request) &#123;</span><br><span class="line">// 先判断是否已登录</span><br><span class="line">Object userObj = request.getSession().getAttribute(USER_LOGIN_STATE);</span><br><span class="line">User currentUser = (User) userObj;</span><br><span class="line">if (currentUser == null  currentUser.getId() == null) &#123;</span><br><span class="line">throw new BusinessException(ErrorCode.NOT_LOGIN_ERROR);</span><br><span class="line">&#125;</span><br><span class="line">// 从数据库查询（追求性能的话可以注释，直接走缓存）</span><br><span class="line">long userId = currentUser.getId();</span><br><span class="line">currentUser = this.getById(userId);</span><br><span class="line">if (currentUser == null) &#123;</span><br><span class="line">throw new BusinessException(ErrorCode.NOT_LOGIN_ERROR);</span><br><span class="line">&#125;</span><br><span class="line">return currentUser;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>   </p>
<h2 id="2、前端"><a href="#2、前端" class="headerlink" title="2、前端"></a>2、前端</h2><hr>
<h3 id="1、添加发布按钮和下线按钮"><a href="#1、添加发布按钮和下线按钮" class="headerlink" title="1、添加发布按钮和下线按钮"></a>1、添加发布按钮和下线按钮</h3><p>  查看了Ant Design <a target="_blank" rel="noopener" href="https://ant.design/components/button-cn">Button的官方文档</a>   发布&#x2F;下线做成一个按钮。通过status来动态判断  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">      title: &#x27;操作&#x27;,</span><br><span class="line">      dataIndex: &#x27;option&#x27;,</span><br><span class="line">      valueType: &#x27;option&#x27;,</span><br><span class="line">      render: (_, record) =&gt; [</span><br><span class="line">        &lt;Button</span><br><span class="line">          key=&quot;config&quot;</span><br><span class="line">          type=&#123;&quot;link&quot;&#125;</span><br><span class="line">          onClick=&#123;() =&gt; &#123;</span><br><span class="line">            handleUpdateModalOpen(true);</span><br><span class="line">            setCurrentRow(record);</span><br><span class="line">          &#125;&#125;</span><br><span class="line">        &gt;</span><br><span class="line">          编辑</span><br><span class="line">        &lt;/Button&gt;,</span><br><span class="line">        record.status === 0 ? (</span><br><span class="line">          &lt;Button</span><br><span class="line">            key=&quot;online&quot;</span><br><span class="line">            type=&#123;&#x27;link&#x27;&#125;</span><br><span class="line">            onClick=&#123;() =&gt; &#123;</span><br><span class="line">              handleOnlineInterface(record);</span><br><span class="line">            &#125;&#125;</span><br><span class="line">          &gt;</span><br><span class="line">            发布</span><br><span class="line">          &lt;/Button&gt;</span><br><span class="line">        ) : (</span><br><span class="line">          &lt;Button</span><br><span class="line">            key=&quot;offline&quot;</span><br><span class="line">            type=&#123;&#x27;text&#x27;&#125;</span><br><span class="line">            // danger=&#123;true&#125;</span><br><span class="line">            onClick=&#123;() =&gt; &#123;</span><br><span class="line">              handleOfflineInterface(record);</span><br><span class="line">            &#125;&#125;</span><br><span class="line">          &gt;</span><br><span class="line">            下线</span><br><span class="line">          &lt;/Button&gt;</span><br><span class="line">        ),</span><br><span class="line">        &lt;Button</span><br><span class="line">          key=&quot;delete&quot;</span><br><span class="line">          type=&#123;&#x27;text&#x27;&#125;</span><br><span class="line">          danger=&#123;true&#125;</span><br><span class="line">          onClick=&#123;() =&gt; &#123;</span><br><span class="line">            handleRemoveInterfaceInfo(record);</span><br><span class="line">          &#125;&#125;</span><br><span class="line">        &gt;</span><br><span class="line">          删除</span><br><span class="line">        &lt;/Button&gt;,</span><br><span class="line">      ],</span><br><span class="line">    &#125;,</span><br></pre></td></tr></table></figure>

<p>  效果如下   <img src="http://halo-ctc.qiniu.ctcnb.cn/markdown/api/image-20230117142012585.png">  </p>
<h3 id="2、编写发布-下线的方法"><a href="#2、编写发布-下线的方法" class="headerlink" title="2、编写发布&#x2F;下线的方法"></a>2、编写发布&#x2F;下线的方法</h3><p>  因为后端新增了代码，所以还是使用openapi自动生成前端方法   跟之前操作一样，去<a target="_blank" rel="noopener" href="http://localhost:7529/api/v3/api-docs%E5%A4%8D%E5%88%B6json%E5%88%B0config/oneapi.json">http://localhost:7529/api/v3/api-docs复制json到config/oneapi.json</a> 然后运行openapi   <img src="http://halo-ctc.qiniu.ctcnb.cn/markdown/api/image-20230117121821846.png">   新增方法  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">   * @en-US Online Interface</span><br><span class="line">   * @zh-CN 发布接口</span><br><span class="line">   *</span><br><span class="line">   * @param fields</span><br><span class="line">   */</span><br><span class="line">  const handleOnlineInterface = async (fields: API.IdRequest) =&gt; &#123;</span><br><span class="line">    const hide = message.loading(&#x27;正在发布&#x27;);</span><br><span class="line">    try &#123;</span><br><span class="line">      let res = await onlineInterfaceInfoUsingPOST(&#123; ...fields &#125;);</span><br><span class="line">      if (res.data) &#123;</span><br><span class="line">        hide();</span><br><span class="line">        message.success(&#x27;发布成功!&#x27;);</span><br><span class="line">        // 刷新页面</span><br><span class="line">        actionRef.current?.reload();</span><br><span class="line">        return true;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; catch (error: any) &#123;</span><br><span class="line">      hide();</span><br><span class="line">      message.error(&#x27;发布失败!&#x27; + error.message);</span><br><span class="line">      return false;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * @en-US Offline Interface</span><br><span class="line">   * @zh-CN 下线接口</span><br><span class="line">   *</span><br><span class="line">   * @param fields</span><br><span class="line">   */</span><br><span class="line">  const handleOfflineInterface = async (fields: API.IdRequest) =&gt; &#123;</span><br><span class="line">    const hide = message.loading(&#x27;正在下线&#x27;);</span><br><span class="line">    try &#123;</span><br><span class="line">      let res = await offlineInterfaceInfoUsingPOST(&#123; ...fields &#125;);</span><br><span class="line">      if (res.data) &#123;</span><br><span class="line">        hide();</span><br><span class="line">        message.success(&#x27;下线成功!&#x27;);</span><br><span class="line">        // 刷新页面</span><br><span class="line">        actionRef.current?.reload();</span><br><span class="line">        return true;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; catch (error: any) &#123;</span><br><span class="line">      hide();</span><br><span class="line">      message.error(&#x27;下线失败!&#x27; + error.message);</span><br><span class="line">      return false;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>

<p>  网页进行测试没有问题~  </p>
<h1 id="七、用户主页"><a href="#七、用户主页" class="headerlink" title="七、用户主页"></a>七、用户主页</h1><hr>
<p>前端浏览接口，查看接口文档，申请签名（注册）  </p>
<h3 id="1、浏览接口"><a href="#1、浏览接口" class="headerlink" title="1、浏览接口"></a>1、浏览接口</h3><hr>
<p>在src&#x2F;pages目录下新建Index目录并把Welcome.tsx拖入其中改名为index.tsx   <strong>配置路由</strong>   <img src="http://halo-ctc.qiniu.ctcnb.cn/markdown/api/image-20230118113613886.png">   测试一下 主页能够正常访问，接下来再来编写页面   <strong>编写页面</strong>   这里参考了 <a target="_blank" rel="noopener" href="https://ant.design/components/list-cn">Ant Design List组件</a>  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">import &#123; PageContainer &#125; from &#x27;@ant-design/pro-components&#x27;;</span><br><span class="line">import &#123; List, message &#125; from &#x27;antd&#x27;;</span><br><span class="line">import React, &#123; useEffect, useState &#125; from &#x27;react&#x27;;</span><br><span class="line">import &#123; listInterfaceInfoByPageUsingGET &#125; from &#x27;@/services/api-platform-backend/interfaceInfoController&#x27;;</span><br><span class="line"></span><br><span class="line">const Index: React.FC = () =&gt; &#123;</span><br><span class="line">  const [loading, setLoading] = useState(false);</span><br><span class="line">  const [list, setList] = useState&lt;API.InterfaceInfo[]&gt;([]);</span><br><span class="line">  const [total, setTotal] = useState&lt;number&gt;(0);</span><br><span class="line"></span><br><span class="line">  const loadData = async (current = 1, pageSize = 10) =&gt; &#123;</span><br><span class="line">    setLoading(true);</span><br><span class="line">    try &#123;</span><br><span class="line">      const res = await listInterfaceInfoByPageUsingGET(&#123;</span><br><span class="line">        current,</span><br><span class="line">        pageSize,</span><br><span class="line">      &#125;);</span><br><span class="line">      setList(res?.data?.records ?? []);</span><br><span class="line">      setTotal(res?.data?.total ?? 0);</span><br><span class="line">      setLoading(false);</span><br><span class="line">    &#125; catch (error: any) &#123;</span><br><span class="line">      setLoading(false);</span><br><span class="line">      message.error(&#x27;请求失败,&#x27; + error.message);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  useEffect(() =&gt; &#123;</span><br><span class="line">    loadData();</span><br><span class="line">  &#125;, []);</span><br><span class="line"></span><br><span class="line">  return (</span><br><span class="line">    &lt;PageContainer title=&#123;&#x27;主页&#x27;&#125;&gt;</span><br><span class="line">      &lt;List</span><br><span class="line">        className=&quot;interfaceInfo-list&quot;</span><br><span class="line">        loading=&#123;loading&#125;</span><br><span class="line">        itemLayout=&quot;horizontal&quot;</span><br><span class="line">        dataSource=&#123;list&#125;</span><br><span class="line">        pagination=&#123;&#123;</span><br><span class="line">          showSizeChanger: true,</span><br><span class="line">          total: total,</span><br><span class="line">          showTotal(total, range) &#123;</span><br><span class="line">            return `$&#123;range[0]&#125;-$&#123;range[1]&#125; / $&#123;total&#125;`;</span><br><span class="line">          &#125;,</span><br><span class="line">          onChange(page, pageSize) &#123;</span><br><span class="line">            loadData(page, pageSize);</span><br><span class="line">          &#125;,</span><br><span class="line">        &#125;&#125;</span><br><span class="line">        renderItem=&#123;(item) =&gt; (</span><br><span class="line">          &lt;List.Item actions=&#123;[&lt;a key=&quot;list-more&quot;&gt;查看详情&lt;/a&gt;]&#125;&gt;</span><br><span class="line">            &lt;List.Item.Meta</span><br><span class="line">              title=&#123;&lt;a href=&quot;https://ant.design&quot;&gt;&#123;item.name&#125;&lt;/a&gt;&#125;</span><br><span class="line">              description=&#123;item.description&#125;</span><br><span class="line">            /&gt;</span><br><span class="line">            &lt;div&gt;&#123;item.method&#125;&lt;/div&gt;</span><br><span class="line">          &lt;/List.Item&gt;</span><br><span class="line">        )&#125;</span><br><span class="line">      /&gt;</span><br><span class="line">    &lt;/PageContainer&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">export default Index;</span><br></pre></td></tr></table></figure>

<p>  效果如下   <img src="http://halo-ctc.qiniu.ctcnb.cn/markdown/api/image-20230118140557053.png">  </p>
<h3 id="2、查看接口文档"><a href="#2、查看接口文档" class="headerlink" title="2、查看接口文档"></a>2、查看接口文档</h3><hr>
<ol>
<li><p><strong>新建文件</strong> 在pages下新建 InterfaceInfo&#x2F;index.tsx</p>
</li>
<li><p><strong>配置动态路由</strong> 这里需要查看 <a target="_blank" rel="noopener" href="https://umijs.org/docs/guides/routes">umi文档</a></p>
</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  // 动态路由</span><br><span class="line">  path: &#x27;/interface_info/:id&#x27;,</span><br><span class="line">  name: &#x27;interface info&#x27;,</span><br><span class="line">  component: &#x27;./InterfaceInfo&#x27;,</span><br><span class="line">  // 不在菜单页显示</span><br><span class="line">  hideInMenu: true</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="http://halo-ctc.qiniu.ctcnb.cn/markdown/api/image-20230118152720709.png"></p>
<ol start="3">
<li><strong>修改跳转</strong> 点击页面即可查看详情 <img src="http://halo-ctc.qiniu.ctcnb.cn/markdown/api/image-20230118152832702.png"> 主页代码片段修改</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">return (</span><br><span class="line">    &lt;PageContainer title=&#123;&#x27;接口开放平台&#x27;&#125;&gt;</span><br><span class="line">      &lt;List</span><br><span class="line">        className=&quot;interfaceInfo-list&quot;</span><br><span class="line">        loading=&#123;loading&#125;</span><br><span class="line">        itemLayout=&quot;horizontal&quot;</span><br><span class="line">        dataSource=&#123;list&#125;</span><br><span class="line">        pagination=&#123;&#123;</span><br><span class="line">          showSizeChanger: true,</span><br><span class="line">          total: total,</span><br><span class="line">          showTotal(total, range) &#123;</span><br><span class="line">            return `$&#123;range[0]&#125;-$&#123;range[1]&#125; / $&#123;total&#125;`;</span><br><span class="line">          &#125;,</span><br><span class="line">          onChange(page, pageSize) &#123;</span><br><span class="line">            loadData(page, pageSize);</span><br><span class="line">          &#125;,</span><br><span class="line">        &#125;&#125;</span><br><span class="line">        // 修改的地方</span><br><span class="line">        renderItem=&#123;(item) =&gt; &#123;</span><br><span class="line">          const infoLink = `/interface_info/$&#123;item.id&#125;`;</span><br><span class="line">          return (</span><br><span class="line">            &lt;List.Item</span><br><span class="line">              actions=&#123;[</span><br><span class="line">                &lt;a key=&quot;list-more&quot; href=&#123;infoLink&#125;&gt;</span><br><span class="line">                  查看详情</span><br><span class="line">                &lt;/a&gt;,</span><br><span class="line">              ]&#125;</span><br><span class="line">            &gt;</span><br><span class="line">              &lt;List.Item.Meta</span><br><span class="line">                title=&#123;&lt;a href=&#123;infoLink&#125;&gt;&#123;item.name&#125;&lt;/a&gt;&#125;</span><br><span class="line">                description=&#123;item.description&#125;</span><br><span class="line">              /&gt;</span><br><span class="line">              &lt;div&gt;&#123;item.method&#125;&lt;/div&gt;</span><br><span class="line">            &lt;/List.Item&gt;</span><br><span class="line">          );</span><br><span class="line">        &#125;&#125;</span><br><span class="line">      /&gt;</span><br><span class="line">    &lt;/PageContainer&gt;</span><br><span class="line">  );</span><br></pre></td></tr></table></figure>

<p> </p>
<ol start="4">
<li><strong>编写InterfaceInfo&#x2F;index.tsx</strong> 这里需要查看Ant Design中的Card 和 Descriptions 组件 已经umi中动态路由如何获取路径中的id <img src="http://halo-ctc.qiniu.ctcnb.cn/markdown/api/image-20230118153556403.png"> 如官方文档所示，这里我们使用useParams()</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">import &#123; PageContainer &#125; from &#x27;@ant-design/pro-components&#x27;;</span><br><span class="line">import &#123; Badge, Card, Descriptions, message &#125; from &#x27;antd&#x27;;</span><br><span class="line">import React, &#123; useEffect, useState &#125; from &#x27;react&#x27;;</span><br><span class="line">import &#123; getInterfaceInfoByIdUsingGET &#125; from &#x27;@/services/api-platform-backend/interfaceInfoController&#x27;;</span><br><span class="line">import &#123; useParams &#125; from &#x27;react-router&#x27;;</span><br><span class="line">import moment from &quot;moment&quot;;</span><br><span class="line"></span><br><span class="line">const InterfaceInfo: React.FC = () =&gt; &#123;</span><br><span class="line">  const [loading, setLoading] = useState(false);</span><br><span class="line">  const [data, setData] = useState&lt;API.InterfaceInfo&gt;();</span><br><span class="line"></span><br><span class="line">  const params = useParams();</span><br><span class="line"></span><br><span class="line">  const loadData = async () =&gt; &#123;</span><br><span class="line">    if (!params.id) &#123;</span><br><span class="line">      message.error(&#x27;无数据，请重试&#x27;);</span><br><span class="line">    &#125;</span><br><span class="line">    setLoading(true);</span><br><span class="line">    try &#123;</span><br><span class="line">      const res = await getInterfaceInfoByIdUsingGET(&#123;</span><br><span class="line">        id: Number(params.id),</span><br><span class="line">      &#125;);</span><br><span class="line">      setData(res?.data);</span><br><span class="line">      setLoading(false);</span><br><span class="line">    &#125; catch (error: any) &#123;</span><br><span class="line">      setLoading(false);</span><br><span class="line">      message.error(&#x27;请求失败,&#x27; + error.message);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  useEffect(() =&gt; &#123;</span><br><span class="line">    loadData();</span><br><span class="line">  &#125;, []);</span><br><span class="line"></span><br><span class="line">  return (</span><br><span class="line">    &lt;PageContainer title=&#123;&#x27;接口详情&#x27;&#125;&gt;</span><br><span class="line">      &lt;Card loading=&#123;loading&#125;&gt;</span><br><span class="line">        &#123;data ? (</span><br><span class="line">          &lt;Descriptions title=&#123;data.name&#125; column=&#123;2&#125; layout=&quot;vertical&quot; bordered=&#123;true&#125;&gt;</span><br><span class="line">            &lt;Descriptions.Item label=&quot;描述&quot;&gt;&#123;data.description&#125;&lt;/Descriptions.Item&gt;</span><br><span class="line">            &lt;Descriptions.Item label=&quot;接口状态&quot;&gt;</span><br><span class="line">              &#123;data.status === 0 ? (</span><br><span class="line">                &lt;Badge text=&#123;&#x27;关闭&#x27;&#125; status=&#123;&#x27;default&#x27;&#125; /&gt;</span><br><span class="line">              ) : (</span><br><span class="line">                &lt;Badge text=&#123;&#x27;启用&#x27;&#125; status=&#123;&#x27;processing&#x27;&#125; /&gt;</span><br><span class="line">              )&#125;</span><br><span class="line">            &lt;/Descriptions.Item&gt;</span><br><span class="line">            &lt;Descriptions.Item label=&quot;请求地址&quot;&gt;&#123;data.url&#125;&lt;/Descriptions.Item&gt;</span><br><span class="line">            &lt;Descriptions.Item label=&quot;请求方法&quot;&gt;&#123;data.method&#125;&lt;/Descriptions.Item&gt;</span><br><span class="line">            &lt;Descriptions.Item label=&quot;请求头&quot;&gt;&#123;data.requestHeader&#125;&lt;/Descriptions.Item&gt;</span><br><span class="line">            &lt;Descriptions.Item label=&quot;响应头&quot;&gt;&#123;data.responseHeader&#125;&lt;/Descriptions.Item&gt;</span><br><span class="line">            &lt;Descriptions.Item label=&quot;创建时间&quot;&gt;&#123;moment(data.createTime).format(&#x27;yyyy-MM-DD HH:mm:ss&#x27;)&#125;&lt;/Descriptions.Item&gt;</span><br><span class="line">            &lt;Descriptions.Item label=&quot;更新时间&quot;&gt;&#123;moment(data.updateTime).format(&#x27;yyyy-MM-DD HH:mm:ss&#x27;)&#125;&lt;/Descriptions.Item&gt;</span><br><span class="line">          &lt;/Descriptions&gt;</span><br><span class="line">        ) : (</span><br><span class="line">          &lt;&gt;接口不存在&lt;/&gt;</span><br><span class="line">        )&#125;</span><br><span class="line">      &lt;/Card&gt;</span><br><span class="line">    &lt;/PageContainer&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">export default InterfaceInfo;</span><br></pre></td></tr></table></figure>

<p> </p>
<ol start="5">
<li><strong>效果如下</strong> 点击后跳转详情 <img src="http://halo-ctc.qiniu.ctcnb.cn/markdown/api/image-20230118153729873.png"></li>
</ol>
<p> </p>
<h3 id="3、申请签名"><a href="#3、申请签名" class="headerlink" title="3、申请签名"></a>3、申请签名</h3><hr>
<p><strong>注册用户的时候就给他分配一个签名</strong>   先在User类和UserMapper.xml中加一下accessKey、secretKey的字段   更新注册方法  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public long userRegister(String userAccount, String userPassword, String checkPassword) &#123;</span><br><span class="line">// 1. 校验</span><br><span class="line">if (StringUtils.isAnyBlank(userAccount, userPassword, checkPassword)) &#123;</span><br><span class="line">throw new BusinessException(ErrorCode.PARAMS_ERROR, &quot;参数为空&quot;);</span><br><span class="line">&#125;</span><br><span class="line">if (userAccount.length() &lt; 4) &#123;</span><br><span class="line">throw new BusinessException(ErrorCode.PARAMS_ERROR, &quot;用户账号过短&quot;);</span><br><span class="line">&#125;</span><br><span class="line">if (userPassword.length() &lt; 8  checkPassword.length() &lt; 8) &#123;</span><br><span class="line">throw new BusinessException(ErrorCode.PARAMS_ERROR, &quot;用户密码过短&quot;);</span><br><span class="line">&#125;</span><br><span class="line">// 密码和校验密码相同</span><br><span class="line">if (!userPassword.equals(checkPassword)) &#123;</span><br><span class="line">throw new BusinessException(ErrorCode.PARAMS_ERROR, &quot;两次输入的密码不一致&quot;);</span><br><span class="line">&#125;</span><br><span class="line">synchronized (userAccount.intern()) &#123;</span><br><span class="line">// 账户不能重复</span><br><span class="line">LambdaQueryWrapper&lt;User&gt; lambdaQueryWrapper = new LambdaQueryWrapper&lt;&gt;();</span><br><span class="line">lambdaQueryWrapper.eq(User::getUserAccount, userAccount);</span><br><span class="line">long count = userMapper.selectCount(lambdaQueryWrapper);</span><br><span class="line">if (count &gt; 0) &#123;</span><br><span class="line">throw new BusinessException(ErrorCode.PARAMS_ERROR, &quot;账号重复&quot;);</span><br><span class="line">&#125;</span><br><span class="line">// 2. 加密</span><br><span class="line">String encryptPassword = DigestUtils.md5DigestAsHex((SALT + userPassword).getBytes());</span><br><span class="line">// 3. 分配accessKey、secretKey</span><br><span class="line">String accessKey = &quot;cli_&quot; + DigestUtil.md5Hex(SALT + userAccount + RandomUtil.randomNumbers(4));</span><br><span class="line">String secretKey = DigestUtil.md5Hex(SALT + userAccount + RandomUtil.randomNumbers(8));</span><br><span class="line">// 4. 插入数据</span><br><span class="line">User user = new User();</span><br><span class="line">user.setUserAccount(userAccount);</span><br><span class="line">user.setUserPassword(encryptPassword);</span><br><span class="line">user.setAccessKey(accessKey);</span><br><span class="line">user.setSecretKey(secretKey);</span><br><span class="line">boolean saveResult = this.save(user);</span><br><span class="line">if (!saveResult) &#123;</span><br><span class="line">throw new BusinessException(ErrorCode.SYSTEM_ERROR, &quot;注册失败，数据库错误&quot;);</span><br><span class="line">&#125;</span><br><span class="line">return user.getId();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>  前往<a target="_blank" rel="noopener" href="http://localhost:7529/api/doc.html%E6%B3%A8%E5%86%8C%E3%80%82">http://localhost:7529/api/doc.html注册。</a> 分配成功~   <img src="http://halo-ctc.qiniu.ctcnb.cn/markdown/api/image-20230118174821662.png">   <strong>更换签名</strong>   扩展：用户可以申请更换签名  </p>
<h1 id="八、在线调用"><a href="#八、在线调用" class="headerlink" title="八、在线调用"></a>八、在线调用</h1><hr>
<p>发现少了一个「请求参数」字段…现在给补上   数据库、后端、前端都需要补上。 不做过多阐述   这里设计的其实不太完美，只是跑通了。后续做优化  </p>
<h2 id="1、前端简单样式"><a href="#1、前端简单样式" class="headerlink" title="1、前端简单样式"></a>1、前端简单样式</h2><hr>
<p>这里我拿了Ant Design官网例子改了一下  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;Card title=&#123;&#x27;在线调用&#x27;&#125;&gt;</span><br><span class="line">  &lt;Form</span><br><span class="line">    name=&quot;basic&quot;</span><br><span class="line">    layout=&#123;&#x27;vertical&#x27;&#125;</span><br><span class="line">    onFinish=&#123;onFinish&#125;</span><br><span class="line">    &gt;</span><br><span class="line">    &lt;Form.Item</span><br><span class="line">      label=&quot;请求参数&quot;</span><br><span class="line">      name=&quot;requestParams&quot;</span><br><span class="line">      &gt;</span><br><span class="line">      &lt;Input.TextArea /&gt;</span><br><span class="line">    &lt;/Form.Item&gt;</span><br><span class="line">    &lt;Form.Item &gt;</span><br><span class="line">      &lt;Button type=&quot;primary&quot; htmlType=&quot;submit&quot;&gt;</span><br><span class="line">        调用</span><br><span class="line">      &lt;/Button&gt;</span><br><span class="line">    &lt;/Form.Item&gt;</span><br><span class="line">  &lt;/Form&gt;</span><br><span class="line">&lt;/Card&gt;</span><br></pre></td></tr></table></figure>

<p>  <img src="http://halo-ctc.qiniu.ctcnb.cn/markdown/api/image-20230119102254234.png">  </p>
<h2 id="2、修改后端"><a href="#2、修改后端" class="headerlink" title="2、修改后端"></a>2、修改后端</h2><hr>
<p>这里我们其实有两种方案  </p>
<ul>
<li><p>走后端调用</p>
</li>
<li><p>直接请求模拟接口</p>
</li>
</ul>
<p>  <img src="http://halo-ctc.qiniu.ctcnb.cn/markdown/api/image-20230119102921966.png">   这里用第一种流方案，更安全更规范。模拟接口的地址就不用暴露出来   大概流程如下  </p>
<ol>
<li><p>前端将用户输入的请求参数和要测试的接口 id发给平台后端</p>
</li>
<li><p>调用前校验</p>
</li>
<li><p>平台后端去调用模拟接口</p>
</li>
</ol>
<p>  <strong>新增DTO类</strong>  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">package com.xuan.project.model.dto.interfaceinfo;</span><br><span class="line"></span><br><span class="line">import lombok.Data;</span><br><span class="line"></span><br><span class="line">import java.io.Serializable;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 调用接口参数</span><br><span class="line"> *</span><br><span class="line"> * @author xuan</span><br><span class="line"> */</span><br><span class="line">@Data</span><br><span class="line">public class InvokeInterfaceRequest implements Serializable &#123;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 主键</span><br><span class="line"> */</span><br><span class="line">private Long id;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 请求参数</span><br><span class="line"> */</span><br><span class="line">private String requestParams;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>  controller类新增方法  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 在线调用接口</span><br><span class="line"> *</span><br><span class="line"> * @param invokeInterfaceRequest 携带id、请求参数</span><br><span class="line"> * @return data</span><br><span class="line"> */</span><br><span class="line">@PostMapping(&quot;/invoke&quot;)</span><br><span class="line">public BaseResponse&lt;Object&gt; invokeInterface(@RequestBody InvokeInterfaceRequest invokeInterfaceRequest, HttpServletRequest request) throws UnsupportedEncodingException &#123;</span><br><span class="line">if (invokeInterfaceRequest == null  invokeInterfaceRequest.getId() &lt; 0) &#123;</span><br><span class="line">throw new BusinessException(ErrorCode.PARAMS_ERROR);</span><br><span class="line">&#125;</span><br><span class="line">// 判断接口是否存在</span><br><span class="line">long id = invokeInterfaceRequest.getId();</span><br><span class="line">InterfaceInfo interfaceInfo = interfaceInfoService.getById(id);</span><br><span class="line">if (interfaceInfo == null) &#123;</span><br><span class="line">throw new BusinessException(ErrorCode.NOT_FOUND_ERROR);</span><br><span class="line">&#125;</span><br><span class="line">if (interfaceInfo.getStatus() != InterfaceInfoStatusEnum.ONLINE.getValue()) &#123;</span><br><span class="line">throw new BusinessException(ErrorCode.SYSTEM_ERROR, &quot;接口未上线&quot;);</span><br><span class="line">&#125;</span><br><span class="line">// 得到当前用户</span><br><span class="line">User loginUser = userService.getLoginUser(request);</span><br><span class="line">String accessKey = loginUser.getAccessKey();</span><br><span class="line">String secretKey = loginUser.getSecretKey();</span><br><span class="line">XuanApiClient client = new XuanApiClient(accessKey, secretKey);</span><br><span class="line">// 先写死请求</span><br><span class="line">String userRequestParams = invokeInterfaceRequest.getRequestParams();</span><br><span class="line">com.xuan.model.User user = JSONUtil.toBean(userRequestParams, com.xuan.model.User.class);</span><br><span class="line">String result = client.getNameByPostWithJson(user);</span><br><span class="line">return ResultUtils.success(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> </p>
<h2 id="3、修改前端"><a href="#3、修改前端" class="headerlink" title="3、修改前端"></a>3、修改前端</h2><hr>
<p>Ant Design中 Form组件 onFinish： 提交表单且数据验证成功后回调事件   所以我们来编写onFinish方法  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">const onFinish = async (requestData: API.InvokeInterfaceRequest) =&gt; &#123;</span><br><span class="line">  if (!params.id) &#123;</span><br><span class="line">    message.error(&#x27;无数据，请重试&#x27;);</span><br><span class="line">  &#125;</span><br><span class="line">  try &#123;</span><br><span class="line">    const res = await invokeInterfaceUsingPOST(&#123;</span><br><span class="line">      id: Number(params.id),</span><br><span class="line">      ...requestData,</span><br><span class="line">    &#125;);</span><br><span class="line">    setResData(res.data);</span><br><span class="line">    message.success(&#x27;调用成功!&#x27;);</span><br><span class="line">  &#125; catch (error: any) &#123;</span><br><span class="line">    message.error(&#x27;请求失败,&#x27; + error.message);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>  再修改一下样式  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line">import &#123; PageContainer &#125; from &#x27;@ant-design/pro-components&#x27;;</span><br><span class="line">import &#123; Badge, Card, Descriptions, message, Form, Input, Button, Divider &#125; from &#x27;antd&#x27;;</span><br><span class="line">import React, &#123; useEffect, useState &#125; from &#x27;react&#x27;;</span><br><span class="line">import &#123;</span><br><span class="line">  getInterfaceInfoByIdUsingGET,</span><br><span class="line">  invokeInterfaceUsingPOST,</span><br><span class="line">&#125; from &#x27;@/services/api-platform-backend/interfaceInfoController&#x27;;</span><br><span class="line">import &#123; useParams &#125; from &#x27;react-router&#x27;;</span><br><span class="line">import moment from &#x27;moment&#x27;;</span><br><span class="line"></span><br><span class="line">const InterfaceInfo: React.FC = () =&gt; &#123;</span><br><span class="line">  const [loading, setLoading] = useState(false);</span><br><span class="line">  const [data, setData] = useState&lt;API.InterfaceInfo&gt;();</span><br><span class="line">  const [resData, setResData] = useState&lt;any&gt;();</span><br><span class="line"></span><br><span class="line">  const params = useParams();</span><br><span class="line"></span><br><span class="line">  const loadData = async () =&gt; &#123;</span><br><span class="line">    if (!params.id) &#123;</span><br><span class="line">      message.error(&#x27;无数据，请重试&#x27;);</span><br><span class="line">    &#125;</span><br><span class="line">    setLoading(true);</span><br><span class="line">    try &#123;</span><br><span class="line">      const res = await getInterfaceInfoByIdUsingGET(&#123;</span><br><span class="line">        id: Number(params.id),</span><br><span class="line">      &#125;);</span><br><span class="line">      setData(res?.data);</span><br><span class="line">      setLoading(false);</span><br><span class="line">    &#125; catch (error: any) &#123;</span><br><span class="line">      setLoading(false);</span><br><span class="line">      message.error(&#x27;请求失败,&#x27; + error.message);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  useEffect(() =&gt; &#123;</span><br><span class="line">    loadData();</span><br><span class="line">  &#125;, []);</span><br><span class="line"></span><br><span class="line">  const onFinish = async (requestData: API.InvokeInterfaceRequest) =&gt; &#123;</span><br><span class="line">    if (!params.id) &#123;</span><br><span class="line">      message.error(&#x27;无数据，请重试&#x27;);</span><br><span class="line">    &#125;</span><br><span class="line">    try &#123;</span><br><span class="line">      const res = await invokeInterfaceUsingPOST(&#123;</span><br><span class="line">        id: Number(params.id),</span><br><span class="line">        ...requestData,</span><br><span class="line">      &#125;);</span><br><span class="line">      setResData(res.data);</span><br><span class="line">      message.success(&#x27;调用成功!&#x27;);</span><br><span class="line">    &#125; catch (error: any) &#123;</span><br><span class="line">      message.error(&#x27;请求失败,&#x27; + error.message);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  return (</span><br><span class="line">    &lt;PageContainer title=&#123;&#x27;接口详情&#x27;&#125;&gt;</span><br><span class="line">      &#123;data ? (</span><br><span class="line">        &lt;&gt;</span><br><span class="line">          &lt;Card loading=&#123;loading&#125;&gt;</span><br><span class="line">            &lt;Descriptions title=&#123;data.name&#125; column=&#123;2&#125; layout=&quot;vertical&quot; bordered=&#123;true&#125;&gt;</span><br><span class="line">              &lt;Descriptions.Item label=&quot;描述&quot;&gt;&#123;data.description&#125;&lt;/Descriptions.Item&gt;</span><br><span class="line">              &lt;Descriptions.Item label=&quot;接口状态&quot;&gt;</span><br><span class="line">                &#123;data.status === 0 ? (</span><br><span class="line">                  &lt;Badge text=&#123;&#x27;关闭&#x27;&#125; status=&#123;&#x27;default&#x27;&#125; /&gt;</span><br><span class="line">                ) : (</span><br><span class="line">                  &lt;Badge text=&#123;&#x27;启用&#x27;&#125; status=&#123;&#x27;processing&#x27;&#125; /&gt;</span><br><span class="line">                )&#125;</span><br><span class="line">              &lt;/Descriptions.Item&gt;</span><br><span class="line">              &lt;Descriptions.Item label=&quot;请求地址&quot;&gt;&#123;data.url&#125;&lt;/Descriptions.Item&gt;</span><br><span class="line">              &lt;Descriptions.Item label=&quot;请求方法&quot;&gt;&#123;data.method&#125;&lt;/Descriptions.Item&gt;</span><br><span class="line">              &lt;Descriptions.Item label=&quot;请求头&quot;&gt;&#123;data.requestHeader&#125;&lt;/Descriptions.Item&gt;</span><br><span class="line">              &lt;Descriptions.Item label=&quot;请求参数&quot;&gt;&#123;data.requestParams&#125;&lt;/Descriptions.Item&gt;</span><br><span class="line">              &lt;Descriptions.Item label=&quot;响应头&quot;&gt;&#123;data.responseHeader&#125;&lt;/Descriptions.Item&gt;</span><br><span class="line">              &lt;Descriptions.Item label=&quot;创建时间&quot;&gt;</span><br><span class="line">                &#123;moment(data.createTime).format(&#x27;yyyy-MM-DD HH:mm:ss&#x27;)&#125;</span><br><span class="line">              &lt;/Descriptions.Item&gt;</span><br><span class="line">              &lt;Descriptions.Item label=&quot;更新时间&quot;&gt;</span><br><span class="line">                &#123;moment(data.updateTime).format(&#x27;yyyy-MM-DD HH:mm:ss&#x27;)&#125;</span><br><span class="line">              &lt;/Descriptions.Item&gt;</span><br><span class="line">            &lt;/Descriptions&gt;</span><br><span class="line">          &lt;/Card&gt;</span><br><span class="line">          &lt;Divider /&gt;</span><br><span class="line">          &lt;Card title=&#123;&#x27;在线调用&#x27;&#125;&gt;</span><br><span class="line">            &lt;Form name=&quot;basic&quot; layout=&#123;&#x27;vertical&#x27;&#125; onFinish=&#123;onFinish&#125;&gt;</span><br><span class="line">              &lt;Form.Item label=&quot;请求参数&quot; name=&quot;requestParams&quot;&gt;</span><br><span class="line">                &lt;Input.TextArea /&gt;</span><br><span class="line">              &lt;/Form.Item&gt;</span><br><span class="line">              &lt;Form.Item&gt;</span><br><span class="line">                &lt;Button type=&quot;primary&quot; htmlType=&quot;submit&quot;&gt;</span><br><span class="line">                  调用</span><br><span class="line">                &lt;/Button&gt;</span><br><span class="line">              &lt;/Form.Item&gt;</span><br><span class="line">            &lt;/Form&gt;</span><br><span class="line">          &lt;/Card&gt;</span><br><span class="line">          &#123;resData ? &lt;Card title=&#123;&#x27;调用结果&#x27;&#125;&gt;&#123;resData&#125;&lt;/Card&gt; : null&#125;</span><br><span class="line">        &lt;/&gt;</span><br><span class="line">      ) : (</span><br><span class="line">        &#x27;接口不存在&#x27;</span><br><span class="line">      )&#125;</span><br><span class="line">    &lt;/PageContainer&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">export default InterfaceInfo;</span><br></pre></td></tr></table></figure>

<p>  测试如下   <img src="http://halo-ctc.qiniu.ctcnb.cn/markdown/api/image-20230119113714929.png">  </p>
<h2 id="4、TODO"><a href="#4、TODO" class="headerlink" title="4、TODO"></a>4、TODO</h2><hr>
<ul>
<li><p>判断该接口是否可以调用时由固定方法名改为根据测试地址来调用</p>
</li>
<li><p>用户测试接口固定方法名改为根据测试地址来调用</p>
</li>
<li><p>模拟接囗改为从数据库校验accessKey、secretKey</p>
</li>
</ul>
<p> </p>
<h1 id="九、接口调用次数统计"><a href="#九、接口调用次数统计" class="headerlink" title="九、接口调用次数统计"></a>九、接口调用次数统计</h1><hr>
<p><strong>需求</strong>  </p>
<ol>
<li><p>用户每次调用接口成功，次数+1</p>
</li>
<li><p>给用户分配或者用户自主申请调用次数</p>
</li>
</ol>
<p>  <strong>业务流程</strong>  </p>
<ol>
<li><p>用户调用接口（之前已完成）</p>
</li>
<li><p>修改数据库，调用次数+1</p>
</li>
</ol>
<p> </p>
<h2 id="1、设计库表"><a href="#1、设计库表" class="headerlink" title="1、设计库表"></a>1、设计库表</h2><p>  哪个用户？哪个接口？ 用户&#x3D;&gt;接口（多对多）   <strong>用户调用接口关系表</strong>  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">create table if not exists api_platform.`user_interface_info`</span><br><span class="line">(</span><br><span class="line">    `id` bigint not null auto_increment comment &#x27;主键&#x27; primary key,</span><br><span class="line">    `user_id` bigint not null comment &#x27;调用用户Id&#x27;,</span><br><span class="line">    `interface_info_id` bigint not null comment &#x27;接口Id&#x27;,</span><br><span class="line">    `total_num` int default 0 not null comment &#x27;总调用次数&#x27;,</span><br><span class="line">  `left_num` int default 0 not null comment &#x27;剩余调用次数&#x27;,</span><br><span class="line">    `status` int default 0 not null comment &#x27;0-正常 ，1-禁用&#x27;,</span><br><span class="line">    `create_time` datetime default CURRENT_TIMESTAMP not null comment &#x27;创建时间&#x27;,</span><br><span class="line">    `update_time` datetime default CURRENT_TIMESTAMP not null on update CURRENT_TIMESTAMP comment &#x27;更新时间&#x27;,</span><br><span class="line">    `is_delete` tinyint default 0 not null comment &#x27;是否删除(0-未删, 1-已删)&#x27;</span><br><span class="line">) comment &#x27;用户调用接口关系表&#x27;;</span><br></pre></td></tr></table></figure>

<p>  执行sql语句   <strong>使用MybatisX插件</strong>   生成user_interface_info表的代码   在isDelete上增加<a href="/TableLogic">@TableLogic</a> 注释 代表逻辑删除  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 用户调用接口关系表</span><br><span class="line"> * @TableName user_interface_info</span><br><span class="line"> */</span><br><span class="line">@TableName(value =&quot;user_interface_info&quot;)</span><br><span class="line">@Data</span><br><span class="line">public class UserInterfaceInfo implements Serializable &#123;</span><br><span class="line">    /**</span><br><span class="line">     * 主键</span><br><span class="line">     */</span><br><span class="line">    @TableId(type = IdType.AUTO)</span><br><span class="line">    private Long id;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 是否删除(0-未删, 1-已删)</span><br><span class="line">     */</span><br><span class="line">    @TableLogic</span><br><span class="line">    private Integer isDelete;</span><br><span class="line"></span><br><span class="line">    @TableField(exist = false)</span><br><span class="line">    private static final long serialVersionUID = 1L;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> </p>
<h2 id="2、基础增删改查"><a href="#2、基础增删改查" class="headerlink" title="2、基础增删改查"></a>2、基础增删改查</h2><p>  先需要在dto中创建类   <img src="http://halo-ctc.qiniu.ctcnb.cn/markdown/api/image-20230123172908757.png">   再复制之前的controller改名替换  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br></pre></td><td class="code"><pre><span class="line">package com.xuan.project.controller;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * API信息接口</span><br><span class="line"> *</span><br><span class="line"> * @author xuan</span><br><span class="line"> */</span><br><span class="line">@RestController</span><br><span class="line">@RequestMapping(&quot;/userInterfaceInfo&quot;)</span><br><span class="line">@Slf4j</span><br><span class="line">public class UserInterfaceInfoController &#123;</span><br><span class="line"></span><br><span class="line">@Resource</span><br><span class="line">private UserInterfaceInfoService userInterfaceInfoService;</span><br><span class="line"></span><br><span class="line">@Resource</span><br><span class="line">private UserService userService;</span><br><span class="line"></span><br><span class="line">// region 增删改查</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 创建</span><br><span class="line"> *</span><br><span class="line"> * @param userInterfaceInfoAddRequest</span><br><span class="line"> * @param request</span><br><span class="line"> * @return</span><br><span class="line"> */</span><br><span class="line">@PostMapping(&quot;/add&quot;)</span><br><span class="line">@AuthCheck(mustRole = UserConstant.ADMIN_ROLE)</span><br><span class="line">public BaseResponse&lt;Long&gt; addUserInterfaceInfo(@RequestBody UserInterfaceInfoAddRequest userInterfaceInfoAddRequest, HttpServletRequest request) &#123;</span><br><span class="line">if (userInterfaceInfoAddRequest == null) &#123;</span><br><span class="line">throw new BusinessException(ErrorCode.PARAMS_ERROR);</span><br><span class="line">&#125;</span><br><span class="line">UserInterfaceInfo userInterfaceInfo = new UserInterfaceInfo();</span><br><span class="line">BeanUtils.copyProperties(userInterfaceInfoAddRequest, userInterfaceInfo);</span><br><span class="line">// 校验</span><br><span class="line">userInterfaceInfoService.validUserInterfaceInfo(userInterfaceInfo, true);</span><br><span class="line">// 设置当前用户id</span><br><span class="line">User loginUser = userService.getLoginUser(request);</span><br><span class="line">userInterfaceInfo.setUserId(loginUser.getId());</span><br><span class="line">boolean result = userInterfaceInfoService.save(userInterfaceInfo);</span><br><span class="line">if (!result) &#123;</span><br><span class="line">throw new BusinessException(ErrorCode.OPERATION_ERROR);</span><br><span class="line">&#125;</span><br><span class="line">long newUserInterfaceInfoId = userInterfaceInfo.getId();</span><br><span class="line">return ResultUtils.success(newUserInterfaceInfoId);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 删除</span><br><span class="line"> *</span><br><span class="line"> * @param deleteRequest</span><br><span class="line"> * @param request</span><br><span class="line"> * @return</span><br><span class="line"> */</span><br><span class="line">@PostMapping(&quot;/delete&quot;)</span><br><span class="line">public BaseResponse&lt;Boolean&gt; deleteUserInterfaceInfo(@RequestBody DeleteRequest deleteRequest, HttpServletRequest request) &#123;</span><br><span class="line">if (deleteRequest == null  deleteRequest.getId() &lt;= 0) &#123;</span><br><span class="line">throw new BusinessException(ErrorCode.PARAMS_ERROR);</span><br><span class="line">&#125;</span><br><span class="line">User user = userService.getLoginUser(request);</span><br><span class="line">long id = deleteRequest.getId();</span><br><span class="line">// 判断是否存在</span><br><span class="line">UserInterfaceInfo oldUserInterfaceInfo = userInterfaceInfoService.getById(id);</span><br><span class="line">if (oldUserInterfaceInfo == null) &#123;</span><br><span class="line">throw new BusinessException(ErrorCode.NOT_FOUND_ERROR);</span><br><span class="line">&#125;</span><br><span class="line">// 仅本人或管理员可删除</span><br><span class="line">if (!oldUserInterfaceInfo.getUserId().equals(user.getId()) &amp;&amp; !userService.isAdmin(request)) &#123;</span><br><span class="line">throw new BusinessException(ErrorCode.NO_AUTH_ERROR);</span><br><span class="line">&#125;</span><br><span class="line">boolean b = userInterfaceInfoService.removeById(id);</span><br><span class="line">return ResultUtils.success(b);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 更新</span><br><span class="line"> *</span><br><span class="line"> * @param userInterfaceInfoUpdateRequest</span><br><span class="line"> * @param request</span><br><span class="line"> * @return</span><br><span class="line"> */</span><br><span class="line">@PostMapping(&quot;/update&quot;)</span><br><span class="line">public BaseResponse&lt;Boolean&gt; updateUserInterfaceInfo(@RequestBody UserInterfaceInfoUpdateRequest userInterfaceInfoUpdateRequest,</span><br><span class="line">                                                     HttpServletRequest request) &#123;</span><br><span class="line">if (userInterfaceInfoUpdateRequest == null  userInterfaceInfoUpdateRequest.getId() &lt;= 0) &#123;</span><br><span class="line">throw new BusinessException(ErrorCode.PARAMS_ERROR);</span><br><span class="line">&#125;</span><br><span class="line">UserInterfaceInfo userInterfaceInfo = new UserInterfaceInfo();</span><br><span class="line">BeanUtils.copyProperties(userInterfaceInfoUpdateRequest, userInterfaceInfo);</span><br><span class="line">// 参数校验</span><br><span class="line">userInterfaceInfoService.validUserInterfaceInfo(userInterfaceInfo, false);</span><br><span class="line">User user = userService.getLoginUser(request);</span><br><span class="line">System.out.println(user);</span><br><span class="line">long id = userInterfaceInfoUpdateRequest.getId();</span><br><span class="line">// 判断是否存在</span><br><span class="line">UserInterfaceInfo oldUserInterfaceInfo = userInterfaceInfoService.getById(id);</span><br><span class="line">if (oldUserInterfaceInfo == null) &#123;</span><br><span class="line">throw new BusinessException(ErrorCode.NOT_FOUND_ERROR);</span><br><span class="line">&#125;</span><br><span class="line">// 仅本人或管理员可修改</span><br><span class="line">userService.isAdmin(request);</span><br><span class="line">if (!oldUserInterfaceInfo.getUserId().equals(user.getId()) &amp;&amp; !userService.isAdmin(request)) &#123;</span><br><span class="line">throw new BusinessException(ErrorCode.NO_AUTH_ERROR);</span><br><span class="line">&#125;</span><br><span class="line">boolean result = userInterfaceInfoService.updateById(userInterfaceInfo);</span><br><span class="line">return ResultUtils.success(result);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 根据 id 获取</span><br><span class="line"> *</span><br><span class="line"> * @param id</span><br><span class="line"> * @return</span><br><span class="line"> */</span><br><span class="line">@GetMapping(&quot;/get&quot;)</span><br><span class="line">public BaseResponse&lt;UserInterfaceInfo&gt; getUserInterfaceInfoById(long id) &#123;</span><br><span class="line">if (id &lt;= 0) &#123;</span><br><span class="line">throw new BusinessException(ErrorCode.PARAMS_ERROR);</span><br><span class="line">&#125;</span><br><span class="line">UserInterfaceInfo userInterfaceInfo = userInterfaceInfoService.getById(id);</span><br><span class="line">return ResultUtils.success(userInterfaceInfo);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 获取列表（仅管理员可使用）</span><br><span class="line"> *</span><br><span class="line"> * @param userInterfaceInfoQueryRequest</span><br><span class="line"> * @return</span><br><span class="line"> */</span><br><span class="line">@AuthCheck(mustRole = &quot;admin&quot;)</span><br><span class="line">@GetMapping(&quot;/list&quot;)</span><br><span class="line">public BaseResponse&lt;List&lt;UserInterfaceInfo&gt;&gt; listUserInterfaceInfo(UserInterfaceInfoQueryRequest userInterfaceInfoQueryRequest) &#123;</span><br><span class="line">UserInterfaceInfo userInterfaceInfoQuery = new UserInterfaceInfo();</span><br><span class="line">if (userInterfaceInfoQueryRequest != null) &#123;</span><br><span class="line">BeanUtils.copyProperties(userInterfaceInfoQueryRequest, userInterfaceInfoQuery);</span><br><span class="line">&#125;</span><br><span class="line">QueryWrapper&lt;UserInterfaceInfo&gt; queryWrapper = new QueryWrapper&lt;&gt;(userInterfaceInfoQuery);</span><br><span class="line">List&lt;UserInterfaceInfo&gt; userInterfaceInfoList = userInterfaceInfoService.list(queryWrapper);</span><br><span class="line">return ResultUtils.success(userInterfaceInfoList);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 分页获取列表</span><br><span class="line"> *</span><br><span class="line"> * @param userInterfaceInfoQueryRequest</span><br><span class="line"> * @param request</span><br><span class="line"> * @return</span><br><span class="line"> */</span><br><span class="line">@GetMapping(&quot;/list/page&quot;)</span><br><span class="line">public BaseResponse&lt;Page&lt;UserInterfaceInfo&gt;&gt; listUserInterfaceInfoByPage(UserInterfaceInfoQueryRequest userInterfaceInfoQueryRequest, HttpServletRequest request) &#123;</span><br><span class="line">if (userInterfaceInfoQueryRequest == null) &#123;</span><br><span class="line">throw new BusinessException(ErrorCode.PARAMS_ERROR);</span><br><span class="line">&#125;</span><br><span class="line">UserInterfaceInfo userInterfaceInfoQuery = new UserInterfaceInfo();</span><br><span class="line">BeanUtils.copyProperties(userInterfaceInfoQueryRequest, userInterfaceInfoQuery);</span><br><span class="line">long current = userInterfaceInfoQueryRequest.getCurrent();</span><br><span class="line">long size = userInterfaceInfoQueryRequest.getPageSize();</span><br><span class="line">String sortField = userInterfaceInfoQueryRequest.getSortField();</span><br><span class="line">String sortOrder = userInterfaceInfoQueryRequest.getSortOrder();</span><br><span class="line">// 限制爬虫</span><br><span class="line">if (size &gt; 50) &#123;</span><br><span class="line">throw new BusinessException(ErrorCode.PARAMS_ERROR);</span><br><span class="line">&#125;</span><br><span class="line">QueryWrapper&lt;UserInterfaceInfo&gt; queryWrapper = new QueryWrapper&lt;&gt;(userInterfaceInfoQuery);</span><br><span class="line">queryWrapper.orderBy(StringUtils.isNotBlank(sortField),</span><br><span class="line">sortOrder.equals(CommonConstant.SORT_ORDER_ASC), sortField);</span><br><span class="line">Page&lt;UserInterfaceInfo&gt; userInterfaceInfoPage = userInterfaceInfoService.page(new Page&lt;&gt;(current, size), queryWrapper);</span><br><span class="line">return ResultUtils.success(userInterfaceInfoPage);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> </p>
<h2 id="3、调用次数统计"><a href="#3、调用次数统计" class="headerlink" title="3、调用次数统计"></a>3、调用次数统计</h2><p>  用户每次调用接口成功，次数+1（service)   <strong>编写方法</strong>   在<strong>service</strong>层的<strong>UserInterfaceInfoService</strong>编写方法   这里只是过流程，实际应该多校验  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public boolean invokeInterfaceCount(long userId, long interfaceInfoId) &#123;</span><br><span class="line">if (userId &lt;= 0  interfaceInfoId &lt;= 0) &#123;</span><br><span class="line">throw new BusinessException(ErrorCode.NOT_FOUND_ERROR);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">LambdaUpdateWrapper&lt;UserInterfaceInfo&gt; updateWrapper = new LambdaUpdateWrapper&lt;&gt;();</span><br><span class="line">updateWrapper.eq(UserInterfaceInfo::getUserId, userId)</span><br><span class="line">.eq(UserInterfaceInfo::getInterfaceInfoId, interfaceInfoId)</span><br><span class="line">.gt(UserInterfaceInfo::getLeftNum, 0)</span><br><span class="line">.setSql(&quot;left_num = left_num -1, total_num = total_num + 1&quot;);</span><br><span class="line"></span><br><span class="line">return update(updateWrapper);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>  注意：其实这里应该添加事务，添加锁   接口测试成功  </p>
<h2 id="4、问题"><a href="#4、问题" class="headerlink" title="4、问题"></a>4、问题</h2><p>  如果每个接口的方法都写调用次数+1，是不是比较麻烦？   致命问题：接口开发者需要自己去添加统计代码   就想到可以使用AOP、网关   <strong>逻辑图</strong>   <img src="http://halo-ctc.qiniu.ctcnb.cn/markdown/api/image-20230126112301389.png">   <strong>AOP切面的优点</strong>：独立于接口，在每个接口调用后统计次数+1 <strong>AOP切面的缺点</strong>：只存在于单个项目中，如果每个团队都要开发自己的模拟接口，那么都要写一个切面   所以最终我们在这个项目选择使用<strong>网关</strong>  </p>
<h1 id="十、网关"><a href="#十、网关" class="headerlink" title="十、网关"></a>十、网关</h1><hr>
<p>什么是网关？理解成火车站的检票口，<strong>统一</strong> 检票   <strong>网关优点</strong>： 统一进行操作，去处理一些问题  </p>
<h2 id="1、网关作用"><a href="#1、网关作用" class="headerlink" title="1、网关作用"></a>1、网关作用</h2><hr>
<ol>
<li><p>路由</p>
</li>
<li><p>负载均衡</p>
</li>
<li><p>统一鉴权</p>
</li>
<li><p>统一处理跨域</p>
</li>
<li><p>统一业务处理（缓存）</p>
</li>
<li><p>访问控制</p>
</li>
<li><p>发布控制</p>
</li>
<li><p>流量染色</p>
</li>
<li><p>统一接口保护</p>
</li>
<li><p>限制请求</p>
</li>
<li><p>信息脱敏</p>
</li>
<li><p>降级（熔断）</p>
</li>
<li><p>限流 学习令牌桶算法，学习露桶算法，学习一下RedislimitHandler</p>
</li>
<li><p>超时时间</p>
</li>
<li><p>重试（业务保护）</p>
</li>
<li><p>统一日志</p>
</li>
<li><p>统一文档</p>
</li>
</ol>
<p> </p>
<h2 id="2、具体作用"><a href="#2、具体作用" class="headerlink" title="2、具体作用"></a>2、具体作用</h2><hr>
<p><strong>路由</strong>   起到转发的作用，比如有接口A和接口B,网关会记录这些信息，根据用户访问的地址和参数，转发请求到对应的接口（服务器&#x2F;集群）   用户a调用接口A   &#x2F;a &#x3D;&gt; 接口A &#x2F;b &#x3D;&gt; 接口B   <a target="_blank" rel="noopener" href="https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#gateway-request-predicates-factories">https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#gateway-request-predicates-factories</a>   <strong>负载均衡</strong>   在路由的基础上可以转发到某一个服务器   &#x2F;c &#x3D;&gt; 服务A&#x2F; 集群A（随机转发到其中的某一个机器）   uri从固定地址改成b:xx   <strong>统一鉴权</strong>   判断用户是否有权限进行操作，无论访问什么接口，我都统一去判断权限，不用重复写   <strong>统一处理跨域</strong>   网关统一处理跨域，不用在每个项目单独处理   <a target="_blank" rel="noopener" href="https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#cors-configuration">https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#cors-configuration</a>   <strong>统一业务处理</strong>   把每个项目中都要做的通用逻辑放到上层（网关），统一处理，比如本项目的次数统计   <strong>访问控制</strong>   黑白名单，比如限制DDOS IP   <strong>发布控制</strong>   灰度发布，比如上线新接口，先给新接口分配 20%流量，老接口80% ,再慢慢调整比例   <a target="_blank" rel="noopener" href="https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#the-weight-route-predicate-factory">https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#the-weight-route-predicate-factory</a>   <strong>流量染色</strong>   区分用户来源   给请求（流量）添加一些标识，一般是设置请求头中，添加新的请求头 <a target="_blank" rel="noopener" href="https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#the-addrequestheader-gatewayfilter-factory">https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#the-addrequestheader-gatewayfilter-factory</a>   <strong>全局染色</strong>：<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#default-filters">https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#default-filters</a>   <strong>接口保护</strong>  </p>
<ol>
<li><p>限制请求 <a target="_blank" rel="noopener" href="https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#requestheadersiz-gatewayfilter-factory">https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#requestheadersiz-gatewayfilter-factory</a></p>
</li>
<li><p>信息脱敏 <a target="_blank" rel="noopener" href="https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#the-removerequestheader-gatewayfilter-factory">https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#the-removerequestheader-gatewayfilter-factory</a></p>
</li>
<li><p>降级（熔断） 进行兜底 <a target="_blank" rel="noopener" href="https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#fallback-headers">https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#fallback-headers</a></p>
</li>
<li><p>限流 <a target="_blank" rel="noopener" href="https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#the-requestratelimiter-gatewayfilter-factory">https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#the-requestratelimiter-gatewayfilter-factory</a></p>
</li>
<li><p>超时时间    超时就中断 <a target="_blank" rel="noopener" href="https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#http-timeouts-configuration">https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#http-timeouts-configuration</a></p>
</li>
<li><p>重试（业务保护）： <a target="_blank" rel="noopener" href="https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#the-retry-gatewayfilter-factory">https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#the-retry-gatewayfilter-factory</a></p>
</li>
</ol>
<p>  <strong>统一日志</strong>   统一的请求，响应信息记录   <strong>统一文档</strong>   将下游项目的文档进行聚合，在一个页面统一查看   建议用：<a target="_blank" rel="noopener" href="https://doc.xiaominfo.com/docs/middleware-sources/aggregation-introduction">https://doc.xiaominfo.com/docs/middleware-sources/aggregation-introduction</a>   <strong>网关的分类</strong>  </p>
<ul>
<li><p><strong>全局网关（接入层网关）</strong>作用是负载均衡、请求日志等，不和业务逻辑绑定</p>
</li>
<li><p><strong>业务网关（微服务网关）</strong>会有一些业务逻辑，作用是将请求转发到不同的业务&#x2F;项目&#x2F;接口&#x2F;服务</p>
</li>
</ul>
<p>  参考文章：<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_21040559/article/details/122961395">https://blog.csdn.net/qq_21040559&#x2F;article&#x2F;details&#x2F;122961395</a>   <strong>实现</strong>  </p>
<ol>
<li><p><strong>Nginx</strong> （全局网关），<strong>Kong网关</strong>（API网关），  <strong>编程成本相对较高</strong></p>
</li>
<li><p><strong>Spring Cloud Gateway</strong>（取代了Zuul）性能高 可以用java代码来写逻辑  适于学习</p>
</li>
</ol>
<p>  网关技术选型：<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/500587132">https://zhuanlan.zhihu.com/p/500587132</a>  </p>
<h1 id="十一、Spring-Cloud-Gateway"><a href="#十一、Spring-Cloud-Gateway" class="headerlink" title="十一、Spring Cloud Gateway"></a>十一、Spring Cloud Gateway</h1><hr>
<p>全部内容基本来自官网   官网：<a target="_blank" rel="noopener" href="https://spring.io/projects/spring-cloud-gateway">https://spring.io/projects/spring-cloud-gateway</a>   官方文档：<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-cloud-gateway/docs/current/reference//html/">https://docs.spring.io/spring-cloud-gateway/docs/current/reference//html/</a>   <strong>新建项目</strong>   在IDEA中新建项目 勾选Gateway、Lombok   参考官网get started中的实例代码  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">@SpringBootApplication</span><br><span class="line">public class DemogatewayApplication &#123;</span><br><span class="line">@Bean</span><br><span class="line">public RouteLocator customRouteLocator(RouteLocatorBuilder builder) &#123;</span><br><span class="line">return builder.routes()</span><br><span class="line">.route(&quot;path_route&quot;, r -&gt; r.path(&quot;/get&quot;)</span><br><span class="line">.uri(&quot;http://httpbin.org&quot;))</span><br><span class="line">.route(&quot;host_route&quot;, r -&gt; r.host(&quot;*.myhost.org&quot;)</span><br><span class="line">.uri(&quot;http://httpbin.org&quot;))</span><br><span class="line">.route(&quot;rewrite_route&quot;, r -&gt; r.host(&quot;*.rewrite.org&quot;)</span><br><span class="line">.filters(f -&gt; f.rewritePath(&quot;/foo/(?&lt;segment&gt;.*)&quot;, &quot;/$&#123;segment&#125;&quot;))</span><br><span class="line">.uri(&quot;http://httpbin.org&quot;))</span><br><span class="line">.route(&quot;hystrix_route&quot;, r -&gt; r.host(&quot;*.hystrix.org&quot;)</span><br><span class="line">.filters(f -&gt; f.hystrix(c -&gt; c.setName(&quot;slowcmd&quot;)))</span><br><span class="line">.uri(&quot;http://httpbin.org&quot;))</span><br><span class="line">.route(&quot;hystrix_fallback_route&quot;, r -&gt; r.host(&quot;*.hystrixfallback.org&quot;)</span><br><span class="line">.filters(f -&gt; f.hystrix(c -&gt; c.setName(&quot;slowcmd&quot;).setFallbackUri(&quot;forward:/hystrixfallback&quot;)))</span><br><span class="line">.uri(&quot;http://httpbin.org&quot;))</span><br><span class="line">.route(&quot;limit_route&quot;, r -&gt; r</span><br><span class="line">.host(&quot;*.limited.org&quot;).and().path(&quot;/anything/**&quot;)</span><br><span class="line">.filters(f -&gt; f.requestRateLimiter(c -&gt; c.setRateLimiter(redisRateLimiter())))</span><br><span class="line">.uri(&quot;http://httpbin.org&quot;))</span><br><span class="line">.build();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>  编写代码：  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">package com.xuan;</span><br><span class="line"></span><br><span class="line">import org.springframework.boot.SpringApplication;</span><br><span class="line">import org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line">import org.springframework.cloud.gateway.route.RouteLocator;</span><br><span class="line">import org.springframework.cloud.gateway.route.builder.RouteLocatorBuilder;</span><br><span class="line">import org.springframework.context.annotation.Bean;</span><br><span class="line"></span><br><span class="line">@SpringBootApplication</span><br><span class="line">public class XuanapiGatewayApplication &#123;</span><br><span class="line"></span><br><span class="line">public static void main(String[] args) &#123;</span><br><span class="line">SpringApplication.run(XuanapiGatewayApplication.class, args);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@Bean</span><br><span class="line">public RouteLocator customRouteLocator(RouteLocatorBuilder builder) &#123;</span><br><span class="line">return builder.routes()</span><br><span class="line">.route(&quot;to_baidu&quot;, r -&gt; r.path(&quot;/baidu&quot;)</span><br><span class="line">.uri(&quot;http://www.baidu.com/&quot;))</span><br><span class="line">.build();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>  测试百度成功  </p>
<h2 id="1、核心概念"><a href="#1、核心概念" class="headerlink" title="1、核心概念"></a>1、核心概念</h2><hr>
<h3 id="1、Glossary"><a href="#1、Glossary" class="headerlink" title="1、Glossary"></a>1、<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#glossary">Glossary</a></h3><p>  官方文档如下  </p>
<ul>
<li><p><strong>Route</strong>: The basic building block of the gateway. It is defined by an ID, a destination URI, a collection of predicates, and a collection of filters. A route is matched if the aggregate predicate is true.</p>
</li>
<li><p><strong>Predicate</strong>: This is a <a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/8/docs/api/java/util/function/Predicate.html">Java 8 Function Predicate</a>. The input type is a <a target="_blank" rel="noopener" href="https://docs.spring.io/spring/docs/5.0.x/javadoc-api/org/springframework/web/server/ServerWebExchange.html">Spring Framework</a> <code>ServerWebExchange</code>. This lets you match on anything from the HTTP request, such as headers or parameters.</p>
</li>
<li><p><strong>Filter</strong>: These are instances of <code>GatewayFilter</code> that have been constructed with a specific factory. Here, you can modify requests and responses before or after sending the downstream request.</p>
</li>
</ul>
<p> </p>
<ol>
<li><p>路由（根据什么条件，转发到哪里）</p>
</li>
<li><p>断言（一组规则，条件，用来确定如何转发路由）</p>
</li>
<li><p>过滤器：对请求进行一系列的处理，比如添加请求头，添加请求参数</p>
</li>
</ol>
<p> </p>
<h3 id="2、请求流程"><a href="#2、请求流程" class="headerlink" title="2、请求流程"></a>2、请求流程</h3><p> </p>
<ol>
<li><p>客户端发起请求</p>
</li>
<li><p>Handler Mapping ：根据断言，去将请求转发到对应的路由</p>
</li>
<li><p>Web Handler：处理请求（一层层经过过滤器）</p>
</li>
<li><p>实际调用服务</p>
</li>
</ol>
<p>  <img src="http://halo-ctc.qiniu.ctcnb.cn/markdown/api/image-20230131144724778.png">  </p>
<h2 id="2、两种配置方式"><a href="#2、两种配置方式" class="headerlink" title="2、两种配置方式"></a>2、两种配置方式</h2><hr>
<ol>
<li><p>配置式 （方便，规范）能用就用</p>
</li>
<li><p>简化版</p>
</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    gateway:</span><br><span class="line">      routes:</span><br><span class="line">      - id: after_route</span><br><span class="line">        uri: https://example.org</span><br><span class="line">        predicates:</span><br><span class="line">        - Cookie=mycookie,mycookievalue</span><br></pre></td></tr></table></figure>

<p> </p>
<ol>
<li>全称</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    gateway:</span><br><span class="line">      routes:</span><br><span class="line">      - id: after_route</span><br><span class="line">        uri: https://example.org</span><br><span class="line">        predicates:</span><br><span class="line">        - name: Cookie</span><br><span class="line">          args:</span><br><span class="line">            name: mycookie</span><br><span class="line">            regexp: mycookievalue</span><br></pre></td></tr></table></figure>

<p> </p>
<ol start="2">
<li>编程式 （灵活，相对麻烦）</li>
</ol>
<p> </p>
<h2 id="3、路由的各种断言"><a href="#3、路由的各种断言" class="headerlink" title="3、路由的各种断言"></a>3、路由的各种断言</h2><hr>
<p>官网地址:<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#gateway-request-predicates-factories">https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#gateway-request-predicates-factories</a>   <strong>目录</strong>  </p>
<ol>
<li><p>After    在xx时间之后</p>
</li>
<li><p>Before     在xx时间之前</p>
</li>
<li><p>Between 在xx时间之间</p>
</li>
<li><p>请求类别</p>
</li>
<li><p>请求头（包含Cookie)</p>
</li>
<li><p>查涧参数</p>
</li>
<li><p>客户端地址</p>
</li>
<li><p><strong>权重</strong></p>
</li>
</ol>
<p>  <strong>The After Route Predicate Factory</strong>   当前时间在这个时间<strong>之后</strong>，就会访问当前这个路由  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    gateway:</span><br><span class="line">      routes:</span><br><span class="line">      - id: after_route</span><br><span class="line">        uri: https://example.org</span><br><span class="line">        predicates:</span><br><span class="line">        - After=2017-01-20T17:42:47.789-07:00[America/Denver]</span><br></pre></td></tr></table></figure>

<p>  <strong>The Before Route Predicate Factory</strong>   当前时间在这个时间<strong>之前</strong>，就会访问当前这个路由  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    gateway:</span><br><span class="line">      routes:</span><br><span class="line">      - id: before_route</span><br><span class="line">        uri: https://example.org</span><br><span class="line">        predicates:</span><br><span class="line">        - Before=2017-01-20T17:42:47.789-07:00[America/Denver]</span><br></pre></td></tr></table></figure>

<p>  <strong>The Between Route Predicate Factory</strong>   当前时间在这个时间<strong>之间</strong>，就会访问当前这个路由  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    gateway:</span><br><span class="line">      routes:</span><br><span class="line">      - id: between_route</span><br><span class="line">        uri: https://example.org</span><br><span class="line">        predicates:</span><br><span class="line">        - Between=2017-01-20T17:42:47.789-07:00[America/Denver], 2017-01-21T17:42:47.789-07:00[America/Denver]</span><br></pre></td></tr></table></figure>

<p>  <strong>The Cookie Route Predicate Factory</strong>   如果你的<strong>请求头cookie</strong>的是<strong>chocolate</strong>，它的值是<strong>ch.p</strong>，就会访问当前这个路由  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    gateway:</span><br><span class="line">      routes:</span><br><span class="line">      - id: cookie_route</span><br><span class="line">        uri: https://example.org</span><br><span class="line">        predicates:</span><br><span class="line">        - Cookie=chocolate, ch.p</span><br></pre></td></tr></table></figure>

<p>  <strong>The Header Route Predicate Factory</strong>   如果你的<strong>请求头</strong>包含<strong>X-Request-Id</strong>这样一个请求头，并且，它的值符合<strong>正则表达式的规则</strong>，就会访问当前这个路由  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    gateway:</span><br><span class="line">      routes:</span><br><span class="line">      - id: header_route</span><br><span class="line">        uri: https://example.org</span><br><span class="line">        predicates:</span><br><span class="line">        - Header=X-Request-Id, \d+</span><br></pre></td></tr></table></figure>

<p>  <strong>The Host Route Predicate Factory</strong>   如果你的<strong>访问</strong>的是这个**.somehost.org,<strong>.<strong>anotherhost.org</strong>，</strong>域名**，就会访问当前这个路由  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    gateway:</span><br><span class="line">      routes:</span><br><span class="line">      - id: host_route</span><br><span class="line">        uri: https://example.org</span><br><span class="line">        predicates:</span><br><span class="line">        - Host=**.somehost.org,**.anotherhost.org</span><br></pre></td></tr></table></figure>

<p>  <strong>The Method Route Predicate Factory</strong>   如果你的<strong>请求类别</strong>是这个<strong>GET</strong>、<strong>POST</strong>，就会访问当前这个路由  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    gateway:</span><br><span class="line">      routes:</span><br><span class="line">      - id: method_route</span><br><span class="line">        uri: https://example.org</span><br><span class="line">        predicates:</span><br><span class="line">        - Method=GET,POST</span><br></pre></td></tr></table></figure>

<p>  <strong>The Path Route Predicate Factory</strong>   如果你的<strong>访问的地址</strong>是以这些**&#x2F;red&#x2F;{segment},&#x2F;blue&#x2F;{segment}**路径作为前缀，就会访问当前这个路由  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    gateway:</span><br><span class="line">      routes:</span><br><span class="line">      - id: path_route</span><br><span class="line">        uri: https://example.org</span><br><span class="line">        predicates:</span><br><span class="line">        - Path=/red/&#123;segment&#125;,/blue/&#123;segment&#125;</span><br></pre></td></tr></table></figure>

<p>  <strong>The Query Route Predicate Factory</strong>   根据<strong>查询条件</strong>，比如red greet green，就会访问当前这个路由  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    gateway:</span><br><span class="line">      routes:</span><br><span class="line">      - id: query_route</span><br><span class="line">        uri: https://example.org</span><br><span class="line">        predicates:</span><br><span class="line">        - Query=red, gree.</span><br></pre></td></tr></table></figure>

<p>  <strong>The RemoteAddr Route Predicate Factory</strong>   根据<strong>远程地址</strong>，比如你的用户的ip地址是192.168.1.1&#x2F;24，就会访问当前这个路由  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    gateway:</span><br><span class="line">      routes:</span><br><span class="line">      - id: remoteaddr_route</span><br><span class="line">        uri: https://example.org</span><br><span class="line">        predicates:</span><br><span class="line">        - RemoteAddr=192.168.1.1/24</span><br></pre></td></tr></table></figure>

<p>  <strong>The Weight Route Predicate Factory</strong>   根据你设置的<strong>权重</strong>，给你把同一个访问的地址，重定到不同的服务，轻松实现发布控制  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    gateway:</span><br><span class="line">      routes:</span><br><span class="line">      - id: weight_high</span><br><span class="line">        uri: https://weighthigh.org</span><br><span class="line">        predicates:</span><br><span class="line">        - Weight=group1, 8</span><br><span class="line">      - id: weight_low</span><br><span class="line">        uri: https://weightlow.org</span><br><span class="line">        predicates:</span><br><span class="line">        - Weight=group1, 2</span><br></pre></td></tr></table></figure>

<p>  <strong>The XForwarded Remote Addr Route Predicate Factory</strong>   从请求头中如果拿到XForwarded这个<strong>请求头的地址</strong>192.168.1.1&#x2F;24 就会访问当前这个路由  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    gateway:</span><br><span class="line">      routes:</span><br><span class="line">      - id: xforwarded_remoteaddr_route</span><br><span class="line">        uri: https://example.org</span><br><span class="line">        predicates:</span><br><span class="line">        - XForwardedRemoteAddr=192.168.1.1/24</span><br></pre></td></tr></table></figure>

<p> </p>
<h2 id="4、过滤器"><a href="#4、过滤器" class="headerlink" title="4、过滤器"></a>4、过滤器</h2><hr>
<p><strong>官网文档</strong>：<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#gatewayfilter-factories">https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#gatewayfilter-factories</a>   <strong>基本功能</strong>：对请求头、请求参数、响应头的增删改查 1.添加清求头 2.添加请求参数 3.添加响应头 4.降级 5.限流 6.重试   <strong>The</strong> <code>AddRequestHeader</code> <code>GatewayFilter</code> <strong>Factory</strong>   增加请求头 （可以用作流量染色）  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    gateway:</span><br><span class="line">      routes:</span><br><span class="line">      - id: add_request_header_route</span><br><span class="line">        uri: https://example.org</span><br><span class="line">        filters:</span><br><span class="line">        - AddRequestHeader=X-Request-red, blue</span><br></pre></td></tr></table></figure>

<p>  使用xuan-api做测试  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">server:</span><br><span class="line">  port: 8090</span><br><span class="line"></span><br><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    gateway:</span><br><span class="line">      routes:</span><br><span class="line">        - id: name_api_route</span><br><span class="line">          uri: http://localhost:8123</span><br><span class="line">          predicates:</span><br><span class="line">            - Path=/api/**</span><br><span class="line">          filters:</span><br><span class="line">            - AddRequestHeader=color, blue</span><br><span class="line">            - AddRequestParameter=name, mars</span><br></pre></td></tr></table></figure>

<p>  在地址栏访问：<a target="_blank" rel="noopener" href="http://localhost:8090/api/name/xuan">http://localhost:8090/api/name/xuan</a>   得到结果如下   <img src="http://halo-ctc.qiniu.ctcnb.cn/markdown/api/image-20230131162105385.png">   <strong>The</strong> <code>AddRequestParameter</code> <code>GatewayFilter</code> <strong>Factory</strong>   增加请求参数  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    gateway:</span><br><span class="line">      routes:</span><br><span class="line">      - id: add_request_parameter_route</span><br><span class="line">        uri: https://example.org</span><br><span class="line">        filters:</span><br><span class="line">        - AddRequestParameter=red, blue</span><br></pre></td></tr></table></figure>

<p>  <strong>The</strong> <code>AddResponseHeader</code> <code>GatewayFilter</code> <strong>Factory</strong>   添加响应头  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    gateway:</span><br><span class="line">      routes:</span><br><span class="line">      - id: add_response_header_route</span><br><span class="line">        uri: https://example.org</span><br><span class="line">        filters:</span><br><span class="line">        - AddResponseHeader=X-Response-Red, Blue</span><br></pre></td></tr></table></figure>

<p>  <strong>The</strong> <code>DedupeResponseHeader</code> <code>GatewayFilter</code> <strong>Factory</strong>   如果响应头中有重复的，去重  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    gateway:</span><br><span class="line">      routes:</span><br><span class="line">      - id: dedupe_response_header_route</span><br><span class="line">        uri: https://example.org</span><br><span class="line">        filters:</span><br><span class="line">        - DedupeResponseHeader=Access-Control-Allow-Credentials Access-Control-Allow-Origin</span><br></pre></td></tr></table></figure>

<p>  保留策略，第一，最后，随机   The <code>DedupeResponseHeader</code> filter also accepts an optional <code>strategy</code> parameter. The accepted values are <code>RETAIN_FIRST</code> (default), <code>RETAIN_LAST</code>, and <code>RETAIN_UNIQUE</code>.   <strong>Spring Cloud CircuitBreaker GatewayFilter Factory</strong>   降级   需要引入<strong>spring-cloud-starter-circuitbreaker-reactor-resilience4j</strong>包  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">  &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">  &lt;artifactId&gt;spring-cloud-starter-circuitbreaker-reactor-resilience4j&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<p> </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    gateway:</span><br><span class="line">      routes:</span><br><span class="line">      - id: circuitbreaker_route</span><br><span class="line">        uri: lb://backing-service:8088</span><br><span class="line">        predicates:</span><br><span class="line">        - Path=/consumingServiceEndpoint</span><br><span class="line">        filters:</span><br><span class="line">        - name: CircuitBreaker</span><br><span class="line">          args:</span><br><span class="line">            name: myCircuitBreaker</span><br><span class="line">            fallbackUri: forward:/inCaseOfFailureUseThis</span><br><span class="line">        - RewritePath=/consumingServiceEndpoint, /backingServiceEndpoint</span><br></pre></td></tr></table></figure>

<p>  <strong>The</strong> <code>FallbackHeaders</code> <code>GatewayFilter</code> <strong>Factory</strong>   降级处理器，写一下降级规则  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    gateway:</span><br><span class="line">      routes:</span><br><span class="line">      - id: ingredients</span><br><span class="line">        uri: lb://ingredients</span><br><span class="line">        predicates:</span><br><span class="line">        - Path=//ingredients/**</span><br><span class="line">        filters:</span><br><span class="line">        - name: CircuitBreaker</span><br><span class="line">          args:</span><br><span class="line">            name: fetchIngredients</span><br><span class="line">            fallbackUri: forward:/fallback</span><br><span class="line">      - id: ingredients-fallback</span><br><span class="line">        uri: http://localhost:9994</span><br><span class="line">        predicates:</span><br><span class="line">        - Path=/fallback</span><br><span class="line">        filters:</span><br><span class="line">        - name: FallbackHeaders</span><br><span class="line">          args:</span><br><span class="line">            executionExceptionTypeHeaderName: Test-Header</span><br></pre></td></tr></table></figure>

<p>  <strong>The</strong> <code>MapRequestHeader</code> <code>GatewayFilter</code> <strong>Factory</strong>   如果你的<strong>请求头</strong>里面有<strong>Blue</strong>，会把<strong>Blue</strong>的值给<strong>X-Request-Red</strong>，相当于做了映射  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    gateway:</span><br><span class="line">      routes:</span><br><span class="line">      - id: map_request_header_route</span><br><span class="line">        uri: https://example.org</span><br><span class="line">        filters:</span><br><span class="line">        - MapRequestHeader=Blue, X-Request-Red</span><br></pre></td></tr></table></figure>

<p>  <strong>The</strong> <code>PrefixPath</code> <code>GatewayFilter</code> <strong>Factory</strong>   前缀处理器  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    gateway:</span><br><span class="line">      routes:</span><br><span class="line">      - id: prefixpath_route</span><br><span class="line">        uri: https://example.org</span><br><span class="line">        filters:</span><br><span class="line">        - PrefixPath=/mypath</span><br></pre></td></tr></table></figure>

<p>  这会将&#x2F;mypath作为所有匹配请求的路径的前缀。因此，对&#x2F;hello的请求将发送到&#x2F;mypath&#x2F;hello。   <strong>The</strong> <code>PreserveHostHeader</code> <code>GatewayFilter</code> <strong>Factoryatewayfilter-factory)</strong>   请求头转发的时候，有时候<strong>host值</strong>会变，这个可以保证不变  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    gateway:</span><br><span class="line">      routes:</span><br><span class="line">      - id: preserve_host_route</span><br><span class="line">        uri: https://example.org</span><br><span class="line">        filters:</span><br><span class="line">        - PreserveHostHeader</span><br></pre></td></tr></table></figure>

<p>  <strong>The</strong> <code>RequestRateLimiter</code> <code>GatewayFilter</code> <strong>Factory</strong>   限流   <img src="http://halo-ctc.qiniu.ctcnb.cn/markdown/api/image-20230131175738299.png">   一般会使用redis+令牌桶算法  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    gateway:</span><br><span class="line">      routes:</span><br><span class="line">      - id: requestratelimiter_route</span><br><span class="line">        uri: https://example.org</span><br><span class="line">        filters:</span><br><span class="line">        - name: RequestRateLimiter</span><br><span class="line">          args:</span><br><span class="line">            redis-rate-limiter.replenishRate: 10</span><br><span class="line">            redis-rate-limiter.burstCapacity: 20</span><br><span class="line">            redis-rate-limiter.requestedTokens: 1</span><br></pre></td></tr></table></figure>

<p>  <code>RequestHeaderSize</code> <code>GatewayFilter</code> <strong>Factory</strong>   限制请求头大小 <strong>请求保护</strong>  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    gateway:</span><br><span class="line">      routes:</span><br><span class="line">      - id: requestheadersize_route</span><br><span class="line">        uri: https://example.org</span><br><span class="line">        filters:</span><br><span class="line">        - RequestHeaderSize=1000B</span><br></pre></td></tr></table></figure>

<p>  <strong>The RemoveRequestHeader Gateway Filter Factory</strong>   移除请求头 （脱敏）  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    gateway:</span><br><span class="line">      routes:</span><br><span class="line">      - id: removerequestheader_route</span><br><span class="line">        uri: https://example.org</span><br><span class="line">        filters:</span><br><span class="line">        - RemoveRequestHeader=X-Request-Foo</span><br></pre></td></tr></table></figure>

<p>  This removes the <code>X-Request-Foo</code> header before it is sent downstream.   <strong>The</strong> <code>RewritePath</code> <code>GatewayFilter</code> <strong>Factory</strong>   改写特殊的请求参数  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    gateway:</span><br><span class="line">      routes:</span><br><span class="line">      - id: rewritepath_route</span><br><span class="line">        uri: https://example.org</span><br><span class="line">        predicates:</span><br><span class="line">        - Path=/red/**</span><br><span class="line">        filters:</span><br><span class="line">        - RewritePath=/red/?(?&lt;segment&gt;.*), /$\&#123;segment&#125;</span><br></pre></td></tr></table></figure>

<p>  <strong>The Retry</strong> <code>GatewayFilter</code> <strong>Factory</strong>   自动帮你重试接口，降级重试  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    gateway:</span><br><span class="line">      routes:</span><br><span class="line">      - id: retry_test</span><br><span class="line">        uri: http://localhost:8080/flakey</span><br><span class="line">        predicates:</span><br><span class="line">        - Host=*.retry.com</span><br><span class="line">        filters:</span><br><span class="line">        - name: Retry</span><br><span class="line">          args:</span><br><span class="line">            retries: 3</span><br><span class="line">            statuses: BAD_GATEWAY</span><br><span class="line">            methods: GET,POST</span><br><span class="line">            backoff:</span><br><span class="line">              firstBackoff: 10ms</span><br><span class="line">              maxBackoff: 50ms</span><br><span class="line">              factor: 2</span><br><span class="line">              basedOnPreviousValue: false</span><br></pre></td></tr></table></figure>

<p>  <strong>Default Filters</strong>   默认过滤器 可以用作全局染色  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    gateway:</span><br><span class="line">      default-filters:</span><br><span class="line">      - AddResponseHeader=X-Response-Default-Red, Default-Blue</span><br><span class="line">      - PrefixPath=/httpbin</span><br></pre></td></tr></table></figure>

<p> </p>
<h2 id="5、其他配置"><a href="#5、其他配置" class="headerlink" title="5、其他配置"></a>5、其他配置</h2><hr>
<h3 id="1、全局过滤器"><a href="#1、全局过滤器" class="headerlink" title="1、全局过滤器"></a>1、全局过滤器</h3><p>  Global Filters   定义过滤器  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">@Bean</span><br><span class="line">public GlobalFilter customFilter() &#123;</span><br><span class="line">    return new CustomGlobalFilter();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public class CustomGlobalFilter implements GlobalFilter, Ordered &#123;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Mono&lt;Void&gt; filter(ServerWebExchange exchange, GatewayFilterChain chain) &#123;</span><br><span class="line">        log.info(&quot;custom global filter&quot;);</span><br><span class="line">        return chain.filter(exchange);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public int getOrder() &#123;</span><br><span class="line">        return -1;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> </p>
<h3 id="2、Http-timeouts-configuration"><a href="#2、Http-timeouts-configuration" class="headerlink" title="2、Http timeouts configuration"></a>2、Http timeouts configuration</h3><p>  Global  timeouts   配置http超时  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    gateway:</span><br><span class="line">      httpclient:</span><br><span class="line">        connect-timeout: 1000</span><br><span class="line">        response-timeout: 5s</span><br></pre></td></tr></table></figure>

<p> </p>
<h3 id="3、CORS-Configuration"><a href="#3、CORS-Configuration" class="headerlink" title="3、CORS Configuration"></a>3、CORS Configuration</h3><p>  跨域配置  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    gateway:</span><br><span class="line">      globalcors:</span><br><span class="line">        cors-configurations:</span><br><span class="line">          &#x27;[/**]&#x27;:</span><br><span class="line">            allowedOrigins: &quot;https://docs.spring.io&quot;</span><br><span class="line">            allowedMethods:</span><br><span class="line">            - GET</span><br></pre></td></tr></table></figure>

<p>  <strong>小作业：</strong>   通过阅读源码：<a target="_blank" rel="noopener" href="https://spring.io/projects/spring-cloud-gateway/#samples">https://spring.io/projects/spring-cloud-gateway/#samples</a> 来了解gateway编程式开发  </p>
<h1 id="十二、项目整合网关"><a href="#十二、项目整合网关" class="headerlink" title="十二、项目整合网关"></a>十二、项目整合网关</h1><hr>
<ol>
<li><p>实现统一的用户鉴权 ，统一的接口调用次数统计（把API网关用到项目中）</p>
</li>
<li><p>完善功能</p>
</li>
</ol>
<p>  <strong>会用到的特性</strong>  </p>
<ol>
<li><p>路由（转发请求到模拟接口项目）</p>
</li>
<li><p>负载均衡（需要用到注册中心）</p>
</li>
<li><p>统一鉴权(accessKey，secretKey)</p>
</li>
<li><p>统一处理跨域</p>
</li>
<li><p>统一业务处理（每次请求接口后，接口调用次数+1）</p>
</li>
<li><p>访问控制（黑白名单）</p>
</li>
<li><p>发布控制</p>
</li>
<li><p>流量染色(记录请求是否为网关来的)</p>
</li>
<li><p>统一接口保护</p>
</li>
<li><p>限制请求</p>
</li>
<li><p>信息脱敏</p>
</li>
<li><p>降级（熔断）</p>
</li>
<li><p>限流 学习令牌桶算法，学习露桶算法，学习一下RedislimitHandler</p>
</li>
<li><p>超时时间</p>
</li>
<li><p>重试（业务保护）</p>
</li>
<li><p>统一日志(记录每次的请求和响应)</p>
</li>
<li><p>统一文档</p>
</li>
</ol>
<p>  <strong>业务逻辑</strong>  </p>
<ol>
<li><p>用户发送请求到API网关</p>
</li>
<li><p>请求日志</p>
</li>
<li><p>黑白名单</p>
</li>
<li><p>用户鉴权（判断ak，sk是否合法）</p>
</li>
<li><p>请求的模拟接口是否存在？</p>
</li>
<li><p><strong>请求转发，调用模拟接口</strong></p>
</li>
<li><p>响应日志</p>
</li>
<li><p>调用成功，接口调用次数+1</p>
</li>
<li><p>调用失败，返回规范错误码</p>
</li>
</ol>
<hr>
<h2 id="1、请求转发"><a href="#1、请求转发" class="headerlink" title="1、请求转发"></a>1、请求转发</h2><hr>
<p>使用Path匹配断言   所有前缀为：&#x2F;api&#x2F; 的请求进行转发，转发到<a target="_blank" rel="noopener" href="http://localhost:8123/api">http://localhost:8123/api</a>   比如请求网关：<a target="_blank" rel="noopener" href="http://localhost:8090/api/name/?name=archer%E8%BD%AC%E5%8F%91%E5%88%B0">http://localhost:8090/api/name/?name=archer转发到</a> <a target="_blank" rel="noopener" href="http://localhost:8123/api/name/?name=archer">http://localhost:8123/api/name/?name=archer</a>  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">server:  </span><br><span class="line">  port: 8090  </span><br><span class="line">  </span><br><span class="line">spring:  </span><br><span class="line">  cloud:  </span><br><span class="line">    gateway:  </span><br><span class="line">      routes:  </span><br><span class="line">        - id: api_route  </span><br><span class="line">          uri: http://localhost:8123  </span><br><span class="line">          predicates:  </span><br><span class="line">            - Path=/api/**</span><br></pre></td></tr></table></figure>

<p>  测试没有问题   <img src="http://halo-ctc.qiniu.ctcnb.cn/markdown/api/image-20230201201022011.png">  </p>
<h2 id="2、Global-Filter"><a href="#2、Global-Filter" class="headerlink" title="2、Global Filter"></a>2、Global Filter</h2><p>  使用了Global Filters，全局请求拦截处理（类似aop）   查看<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#global-filters">官网</a>，使用模板代码为基础进行编写程序  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">package com.xuan.filter;</span><br><span class="line">/**</span><br><span class="line"> * 全局过滤器</span><br><span class="line"> *</span><br><span class="line"> * @version 1.0</span><br><span class="line"> * @author: 玄</span><br><span class="line"> * @date: 2023/2/1</span><br><span class="line"> */</span><br><span class="line">@Slf4j</span><br><span class="line">@Component</span><br><span class="line">public class CustomGlobalFilter implements GlobalFilter, Ordered &#123;</span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line">public Mono&lt;Void&gt; filter(ServerWebExchange exchange, GatewayFilterChain chain) &#123;</span><br><span class="line">log.info(&quot;custom global filter&quot;);</span><br><span class="line">return chain.filter(exchange);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line">public int getOrder() &#123;</span><br><span class="line">return -1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> </p>
<h3 id="1、请求日志"><a href="#1、请求日志" class="headerlink" title="1、请求日志"></a>1、请求日志</h3><p>  我们参考之前的AOP的写法，从exchange这个路由交换机里面拿到我们所有的请求的信息  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public Mono&lt;Void&gt; filter(ServerWebExchange exchange, GatewayFilterChain chain) &#123;</span><br><span class="line">// 1. 请求日志</span><br><span class="line">ServerHttpRequest request = exchange.getRequest();</span><br><span class="line">log.info(&quot;请求id: &#123;&#125;&quot;, request.getId());</span><br><span class="line">log.info(&quot;请求路径: &#123;&#125;&quot;, request.getPath());</span><br><span class="line">log.info(&quot;请求方法: &#123;&#125;&quot;, request.getMethod());</span><br><span class="line">log.info(&quot;请求参数: &#123;&#125;&quot;, request.getQueryParams());</span><br><span class="line">log.info(&quot;请求头: &#123;&#125;&quot;, request.getHeaders());</span><br><span class="line">log.info(&quot;请求地址: &#123;&#125;&quot;, request.getRemoteAddress());</span><br><span class="line">return chain.filter(exchange);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>  <img src="http://halo-ctc.qiniu.ctcnb.cn/markdown/api/image-20230201204627949.png">  </p>
<h3 id="2、添加黑白名单"><a href="#2、添加黑白名单" class="headerlink" title="2、添加黑白名单"></a>2、添加黑白名单</h3><p>  建议用白名单，更安全些   如果这个来源地址不是白名单里面的，我们就直接设个状态码（这里设置403），然后拦截掉 <strong>response.setComplete()</strong> 可以理解为设置响应完成  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">private static final List&lt;String&gt; IP_WHITE_LIST = Arrays.asList(&quot;127.0.0.1&quot;, &quot;127.0.0.2&quot;);</span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line">public Mono&lt;Void&gt; filter(ServerWebExchange exchange, GatewayFilterChain chain) &#123;</span><br><span class="line">// 1. 请求日志</span><br><span class="line">ServerHttpRequest request = exchange.getRequest();</span><br><span class="line">String remoteAddress = request.getRemoteAddress().getHostString();</span><br><span class="line">log.info(&quot;请求地址: &#123;&#125;&quot;, remoteAddress);</span><br><span class="line">// 2. 访问控制 - 黑白名单</span><br><span class="line">if (!IP_WHITE_LIST.contains(remoteAddress))&#123;</span><br><span class="line">ServerHttpResponse response = exchange.getResponse();</span><br><span class="line">response.setStatusCode(HttpStatus.FORBIDDEN);</span><br><span class="line">return response.setComplete();</span><br><span class="line">&#125;</span><br><span class="line">return chain.filter(exchange);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>  将IP_WHITE_LIST设置为黑名单 测试被拒   <img src="http://halo-ctc.qiniu.ctcnb.cn/markdown/api/image-20230201205411510.png">  </p>
<h3 id="3、用户鉴权"><a href="#3、用户鉴权" class="headerlink" title="3、用户鉴权"></a>3、用户鉴权</h3><p>  找到之前用户鉴权的代码 复制过来 修改一下 需要倒入我之前做的starter  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.xuan&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;xuanapi-client-sdk&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;0.0.1&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<p> </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public Mono&lt;Void&gt; filter(ServerWebExchange exchange, GatewayFilterChain chain) &#123;</span><br><span class="line">// 1. 请求日志</span><br><span class="line">ServerHttpRequest request = exchange.getRequest();</span><br><span class="line">log.info(&quot;请求id: &#123;&#125;&quot;, request.getId());</span><br><span class="line">log.info(&quot;请求路径: &#123;&#125;&quot;, request.getPath());</span><br><span class="line">log.info(&quot;请求方法: &#123;&#125;&quot;, request.getMethod());</span><br><span class="line">log.info(&quot;请求参数: &#123;&#125;&quot;, request.getQueryParams());</span><br><span class="line">log.info(&quot;请求头: &#123;&#125;&quot;, request.getHeaders());</span><br><span class="line">String remoteAddress = request.getRemoteAddress().getHostString();</span><br><span class="line">log.info(&quot;请求地址: &#123;&#125;&quot;, remoteAddress);</span><br><span class="line"></span><br><span class="line">// 2. 访问控制 - 黑白名单</span><br><span class="line">if (!IP_WHITE_LIST.contains(remoteAddress)) &#123;</span><br><span class="line">return handleNoAuth(exchange.getResponse());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 3. 用户鉴权</span><br><span class="line">HttpHeaders headers = request.getHeaders();</span><br><span class="line">String accessKey = headers.getFirst(&quot;accessKey&quot;);</span><br><span class="line">// 防止中文乱码</span><br><span class="line">String body = null;</span><br><span class="line">try &#123;</span><br><span class="line">body = URLDecoder.decode(headers.getFirst(&quot;body&quot;), StandardCharsets.UTF_8.name());</span><br><span class="line">&#125; catch (UnsupportedEncodingException e) &#123;</span><br><span class="line">throw new RuntimeException(e);</span><br><span class="line">&#125;</span><br><span class="line">String sign = headers.getFirst(&quot;sign&quot;);</span><br><span class="line">String nonce = headers.getFirst(&quot;nonce&quot;);</span><br><span class="line">String timestamp = headers.getFirst(&quot;timestamp&quot;);</span><br><span class="line">boolean hasBlank = StrUtil.hasBlank(accessKey, body, sign, nonce, timestamp);</span><br><span class="line">// 判断是否有空</span><br><span class="line">if (hasBlank) &#123;</span><br><span class="line">return handleInvokeError(exchange.getResponse());</span><br><span class="line">&#125;</span><br><span class="line">// TODO 使用accessKey去数据库查询secretKey</span><br><span class="line">// 假设查到的secret是abc 进行加密得到sign</span><br><span class="line">String secretKey = &quot;abc&quot;;</span><br><span class="line">String sign1 = SignUtil.getSign(body, secretKey);</span><br><span class="line">if (!StrUtil.equals(sign, sign1)) &#123;</span><br><span class="line">return handleInvokeError(exchange.getResponse());</span><br><span class="line">&#125;</span><br><span class="line">// TODO 判断随机数nonce</span><br><span class="line">// 时间戳是否为数字</span><br><span class="line">if (!NumberUtil.isNumber(timestamp)) &#123;</span><br><span class="line">return handleInvokeError(exchange.getResponse());</span><br><span class="line">&#125;</span><br><span class="line">// 五分钟内的请求有效</span><br><span class="line">if (System.currentTimeMillis() - Long.parseLong(timestamp) &gt; FIVE_MINUTES) &#123;</span><br><span class="line">return handleInvokeError(exchange.getResponse());</span><br><span class="line">&#125;</span><br><span class="line">// 4. 请求的模拟接口是否存在？</span><br><span class="line">// 5. 请求转发，调用模拟接口</span><br><span class="line">// 6. 响应日志</span><br><span class="line">// 7. 调用成功，接口调用次数+1</span><br><span class="line">// 8. 调用失败，返回规范错误码</span><br><span class="line">return chain.filter(exchange);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private Mono&lt;Void&gt; handleNoAuth(ServerHttpResponse response) &#123;</span><br><span class="line">response.setStatusCode(HttpStatus.FORBIDDEN);</span><br><span class="line">return response.setComplete();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private Mono&lt;Void&gt; handleInvokeError(ServerHttpResponse response) &#123;</span><br><span class="line">response.setStatusCode(HttpStatus.INTERNAL_SERVER_ERROR);</span><br><span class="line">return response.setComplete();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> </p>
<h3 id="4、判读请求的接口是否存在"><a href="#4、判读请求的接口是否存在" class="headerlink" title="4、判读请求的接口是否存在"></a>4、判读请求的接口是否存在</h3><p>  我们可以从<strong>数据库</strong>中查询模拟接口是否存在，以及请求方法是否匹配（还可以校验请求参数） 因为网关项目没引入MyBatis等操作数据库的类库，如果该孩操作较为复杂，可以由backend增删改查项目提供接口，我们直接调用，不用再重复写逻辑了。  </p>
<ul>
<li><p>HTTP请求（用HTTPClient、.用RestTemplate、Feign)</p>
</li>
<li><p>RPC(Dubbo)</p>
</li>
</ul>
<p> </p>
<h3 id="5、请求转发-调用模拟接口"><a href="#5、请求转发-调用模拟接口" class="headerlink" title="5、请求转发 调用模拟接口"></a>5、请求转发 调用模拟接口</h3><p> </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// 5. 请求转发，调用模拟接口</span><br><span class="line">Mono&lt;Void&gt; filter = chain.filter(exchange);</span><br><span class="line">// 6. 响应日志</span><br><span class="line">log.info(&quot;响应状态码：&#123;&#125;&quot;, response.getStatusCode());</span><br><span class="line">if (response.getStatusCode() == HttpStatus.OK) &#123;</span><br><span class="line">// 7. 调用成功，接口调用次数+1</span><br><span class="line">&#125; else &#123;</span><br><span class="line">// 8. 调用失败，返回规范错误码</span><br><span class="line">return handleInvokeError(response);</span><br><span class="line">&#125;</span><br><span class="line">return filter;</span><br></pre></td></tr></table></figure>

<p>  接下来需要修改客户端的地址，让它经过网关   找到SDK修改地址   <img src="http://halo-ctc.qiniu.ctcnb.cn/markdown/api/image-20230202162858649.png">  </p>
<h3 id="6、异步返回问题"><a href="#6、异步返回问题" class="headerlink" title="6、异步返回问题"></a>6、异步返回问题</h3><p>  又出现一个问题，我们的接口调用，是在过滤器完成之后进行的，是个<strong>异步操作</strong>   <img src="http://halo-ctc.qiniu.ctcnb.cn/markdown/api/image-20230202163045626.png">   预期是等模拟接口调用完成，才记录响应日志、统计调用次数。 但现实是 chain.fitter 方法立刻返回了，直到 filter 过滤器 return 后才调用了模拟接口。 原因是：chain.filter 是个异步操作，理解为前端的 promise   解決方案：利用response 装饰者，增强原有 response 的处理能力 参考博客：<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq/_19636353/article/details/126759522%EF%BC%88%E4%BB%A5%E8%BF%99%E4%B8%AA%E4%B8%BA%E4%B8%BB%EF%BC%89">https://blog.csdn.net/qq\_19636353/article/details/126759522（以这个为主）</a> 其他参考： • <a target="_blank" rel="noopener" href="https://blog.csdn.net/mo_67595943/article/details/124667975">https://blog.csdn.net/mo_67595943&#x2F;article&#x2F;details&#x2F;124667975</a> • <a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_43933728/article/details/121359727">https://blog.csdn.net/weixin_43933728&#x2F;article&#x2F;details&#x2F;121359727</a> • <a target="_blank" rel="noopener" href="https://blog.csdn.net/zx156955/article/details/121670681">https://blog.csdn.net/zx156955/article/details/121670681</a> • <a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_39529562/article/details/108911983">https://blog.csdn.net/qq_39529562&#x2F;article&#x2F;details&#x2F;108911983</a>   这些代码不用记忆 搜「Spring Cloud Gateway 响应日志」就有了   复制<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq/_19636353/article/details/126759522">https://blog.csdn.net/qq\_19636353/article/details/126759522</a>  中的Response log代码。并改写  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 处理响应</span><br><span class="line"> *</span><br><span class="line"> * @param exchange</span><br><span class="line"> * @param chain</span><br><span class="line"> * @return</span><br><span class="line"> */</span><br><span class="line">private Mono&lt;Void&gt; handleResponse(ServerWebExchange exchange, GatewayFilterChain chain) &#123;</span><br><span class="line">try &#123;</span><br><span class="line">// 从交换机拿到原始response</span><br><span class="line">ServerHttpResponse originalResponse = exchange.getResponse();</span><br><span class="line">// 缓冲区工厂 拿到缓存数据</span><br><span class="line">DataBufferFactory bufferFactory = originalResponse.bufferFactory();</span><br><span class="line">// 拿到状态码</span><br><span class="line">HttpStatus statusCode = originalResponse.getStatusCode();</span><br><span class="line"></span><br><span class="line">if (statusCode == HttpStatus.OK) &#123;</span><br><span class="line">// 装饰，增强能力</span><br><span class="line">ServerHttpResponseDecorator decoratedResponse = new ServerHttpResponseDecorator(originalResponse) &#123;</span><br><span class="line">// 等调用完转发的接口后才会执行</span><br><span class="line">@Override</span><br><span class="line">public Mono&lt;Void&gt; writeWith(Publisher&lt;? extends DataBuffer&gt; body) &#123;</span><br><span class="line">log.info(&quot;body instanceof Flux: &#123;&#125;&quot;, (body instanceof Flux));</span><br><span class="line">// 对象是响应式的</span><br><span class="line">if (body instanceof Flux) &#123;</span><br><span class="line">// 我们拿到真正的body</span><br><span class="line">Flux&lt;? extends DataBuffer&gt; fluxBody = Flux.from(body);</span><br><span class="line">// 往返回值里面写数据</span><br><span class="line">// 拼接字符串</span><br><span class="line">return super.writeWith(fluxBody.map(dataBuffer -&gt; &#123;</span><br><span class="line">// TODO 7. 调用成功，接口调用次数+1</span><br><span class="line">// data从这个content中读取</span><br><span class="line">byte[] content = new byte[dataBuffer.readableByteCount()];</span><br><span class="line">dataBuffer.read(content);</span><br><span class="line">DataBufferUtils.release(dataBuffer);// 释放掉内存</span><br><span class="line">// 6.构建日志</span><br><span class="line">List&lt;Object&gt; rspArgs = new ArrayList&lt;&gt;();</span><br><span class="line">rspArgs.add(originalResponse.getStatusCode());</span><br><span class="line">String data = new String(content, StandardCharsets.UTF_8);// data</span><br><span class="line">rspArgs.add(data);</span><br><span class="line">log.info(&quot;&lt;--- status:&#123;&#125; data:&#123;&#125;&quot;// data</span><br><span class="line">, rspArgs.toArray());// log.info(&quot;&lt;-- &#123;&#125; &#123;&#125;&quot;, originalResponse.getStatusCode(), data);</span><br><span class="line">return bufferFactory.wrap(content);</span><br><span class="line">&#125;));</span><br><span class="line">&#125; else &#123;</span><br><span class="line">// 8.调用失败返回错误状态码</span><br><span class="line">log.error(&quot;&lt;--- &#123;&#125; 响应code异常&quot;, getStatusCode());</span><br><span class="line">&#125;</span><br><span class="line">return super.writeWith(body);</span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br><span class="line">// 设置 response 对象为装饰过的</span><br><span class="line">return chain.filter(exchange.mutate().response(decoratedResponse).build());</span><br><span class="line">&#125;</span><br><span class="line">return chain.filter(exchange);// 降级处理返回数据</span><br><span class="line">&#125; catch (Exception e) &#123;</span><br><span class="line">log.error(&quot;gateway log exception.\n&quot; + e);</span><br><span class="line">return chain.filter(exchange);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> </p>
<h1 id="十二、RPC"><a href="#十二、RPC" class="headerlink" title="十二、RPC"></a>十二、RPC</h1><hr>
<p>RPC（Remote Procedure Call）远程过程调用   <strong>网关业务逻辑</strong>   问题： 网关项目比较存粹，没有操作数据库的包，并且还要调用我们之前写过的代码？复制粘贴维护麻烦 理想：直接请求到其他项目的方法   <strong>怎么调用其他项目的方法？</strong>  </p>
<ol>
<li><p>复制代码和依赖，环境</p>
</li>
<li><p>HTTP请求（提供接口，供其他项目调用）</p>
</li>
<li><p>RPC</p>
</li>
<li><p>把公共的代码打个jar包，其他项目去引用</p>
</li>
</ol>
<p>  <strong>HTTP请求怎么调用</strong>  </p>
<ol>
<li><p>提供方提供一个接口（地址，请求方法，参数，返回值）</p>
</li>
<li><p>调用方使用HTTP Client之类的代码包去发送HTTP请求</p>
</li>
</ol>
<p>  <strong>RPC作用</strong>   像调用本地方法一样去调用远程方法   <strong>RPC优点</strong>  </p>
<ol>
<li><p>对开发者更透明,减少很多的沟通成本</p>
</li>
<li><p>RPC向远程服务器发送请求时，未必使用HTTP协议，比如还可以使用TCP&#x2F;IP，性能更高。（内部服务更实适用）</p>
</li>
</ol>
<p>  <img src="http://halo-ctc.qiniu.ctcnb.cn/markdown/api/image-20230203144005014.png">   注意： 这里注册中心只提供信息，并不会帮助调用  </p>
<h2 id="1、Dubbo框架（RPC实现）"><a href="#1、Dubbo框架（RPC实现）" class="headerlink" title="1、Dubbo框架（RPC实现）"></a>1、Dubbo框架（RPC实现）</h2><hr>
<p>官网：<a target="_blank" rel="noopener" href="https://cn.dubbo.apache.org/zh/">https://cn.dubbo.apache.org/zh/</a>   常见框架还有GRPC、TRPC   最好的学习方式：<a target="_blank" rel="noopener" href="https://dubbo.incubator.apache.org/zh/docs3-v2/java-sdk/quick-start/spring-boot/">阅读官方文档</a>  </p>
<h3 id="1、两种使用方式"><a href="#1、两种使用方式" class="headerlink" title="1、两种使用方式"></a>1、两种使用方式</h3><p> </p>
<ol>
<li><p>Spring Boot代码（注解+编程式）：写Java接口，服务提供者和消费者都去引用这个接口 偏程导</p>
</li>
<li><p>DL(接口调用语言)：创建一个公共的接口定义文件，服务提供者和消费者读取这个文件。优点是跨语言，所有的框架都认识</p>
</li>
</ol>
<p>  底层是Triple协议： <a target="_blank" rel="noopener" href="https://dubbo.incubator.apache.org/zh/docs3-v2/java-sdk/concepts-and-architecture/triple/">https://dubbo.incubator.apache.org/zh/docs3-v2/java-sdk/concepts-and-architecture/triple/</a>  </p>
<h3 id="2、快速使用-（Spring-Boot）"><a href="#2、快速使用-（Spring-Boot）" class="headerlink" title="2、快速使用 （Spring Boot）"></a>2、快速使用 （Spring Boot）</h3><p>  按照官网步骤来   <strong>下载源码</strong>  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone -b master https://github.com/apache/dubbo-samples.git</span><br></pre></td></tr></table></figure>

<p>  <strong>在IDEA中打开</strong>   <img src="http://halo-ctc.qiniu.ctcnb.cn/markdown/api/image-20230203160423574.png">   看一下结构   <img src="http://halo-ctc.qiniu.ctcnb.cn/markdown/api/image-20230203165252141.png">   consumer和provider的配置都如下  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">dubbo:</span><br><span class="line">  application:</span><br><span class="line">    name: dubbo-springboot-demo-provider</span><br><span class="line">  protocol:</span><br><span class="line">    name: dubbo</span><br><span class="line">    port: -1</span><br><span class="line">  registry: # 注册中心</span><br><span class="line">    id: zk-registry</span><br><span class="line">    address: zookeeper://127.0.0.1:2181</span><br><span class="line">  config-center:</span><br><span class="line">    address: zookeeper://127.0.0.1:2181</span><br><span class="line">  metadata-report:</span><br><span class="line">    address: zookeeper://127.0.0.1:2181</span><br></pre></td></tr></table></figure>

<p>  EmbeddedZooKeeper 提个一个内置的ZooKeeper作为注册中心   <strong>启动项目</strong>   先后启动 注册中心(provider内置)、provider、consumer 测试跑通。  </p>
<h1 id="十三、项目整合Dubbo、Nacos"><a href="#十三、项目整合Dubbo、Nacos" class="headerlink" title="十三、项目整合Dubbo、Nacos"></a>十三、项目整合Dubbo、Nacos</h1><hr>
<ol>
<li><p>backend项目作为<strong>服务提供者</strong>，提供3个方法：</p>
</li>
<li><p>实际情况应该是去数据库中查是否已分配给用户</p>
</li>
<li><p>从数据库中查询模拟接口是否存在，以及请求方法是否匹配（还可以校验请求参数）</p>
</li>
<li><p>调用成功，接口调用次数+1 invokeCount</p>
</li>
<li><p>gateway项日作为<strong>服务调用者</strong>，调用这3个方法</p>
</li>
</ol>
<p> </p>
<h2 id="1、安装启动Nacos"><a href="#1、安装启动Nacos" class="headerlink" title="1、安装启动Nacos"></a>1、安装启动Nacos</h2><p>  整合Nacos注册中：<a target="_blank" rel="noopener" href="https://cn.dubbo.apache.org/zh/docs3-v2/java-sdk/reference-manual/registry/nacos/">Nacos Apache Dubbo</a> Nacos下载地址：<a target="_blank" rel="noopener" href="https://nacos.io/zh-cn/docs/v2/quickstart/quick-start.html">Nacos 快速开始</a>   启动命令(standalone代表着单机模式运行，非集群模式)  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh startup.sh -m standalone</span><br></pre></td></tr></table></figure>

<p>  <img src="http://halo-ctc.qiniu.ctcnb.cn/markdown/api/image-20230206110644915.png">   用户名、密码都是nacos   <img src="http://halo-ctc.qiniu.ctcnb.cn/markdown/api/image-20230206110747933.png">  </p>
<h2 id="2、项目跑通"><a href="#2、项目跑通" class="headerlink" title="2、项目跑通"></a>2、项目跑通</h2><hr>
<p><strong>添加依赖</strong>   在api-platform-backend、api-platform-gateway中添加如下依赖  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.apache.dubbo&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;dubbo&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;3.1.5&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.alibaba.nacos&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;nacos-client&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;2.2.0&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<p>  这里的nacos是我下载的版本   <strong>添加配置</strong>  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">dubbo:</span><br><span class="line">  application:</span><br><span class="line">    name: dubbo-api-platform-backend-provider</span><br><span class="line">  protocol:</span><br><span class="line">    name: dubbo</span><br><span class="line">    port: -1</span><br><span class="line">  registry:</span><br><span class="line">    id: nacos-registry</span><br><span class="line">    address: nacos://localhost:8848</span><br></pre></td></tr></table></figure>

<p>  <strong>注意：</strong>  </p>
<ol>
<li><p>服务接口类必须要在同一个包下，建议是抽象出一个公共项日（放接口、实体类等）</p>
</li>
<li><p>置注解（比如启动类的EnableDubbo、接口实现类和Bean引用的注解：@DubboService、@DubboReference）</p>
</li>
<li><p>添加配置</p>
</li>
<li><p>服务调用项目和提供者项目尽量引入相同的依赖和配置</p>
</li>
</ol>
<p> </p>
<h3 id="1、api-platform-backend"><a href="#1、api-platform-backend" class="headerlink" title="1、api-platform-backend"></a>1、api-platform-backend</h3><p>  在主包下添加rpc包（com.xuan.project.rpc）   <img src="http://halo-ctc.qiniu.ctcnb.cn/markdown/api/image-20230206120727992.png">   RpcDemoServer.java  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public interface RpcDemoService &#123;</span><br><span class="line">String sayHello(String name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>  RpcDemoServerImpl.java  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@DubboService</span><br><span class="line">public class RpcDemoServiceImpl implements RpcDemoService &#123;</span><br><span class="line">@Override</span><br><span class="line">public String sayHello(String name) &#123;</span><br><span class="line">System.out.println(&quot;Hello &quot; + name + &quot;, request from consumer: &quot; + RpcContext.getContext().getRemoteAddress());</span><br><span class="line">return &quot;Hello &quot; + name;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>  Application主类新增@EnableDubbo注解  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@SpringBootApplication</span><br><span class="line">@EnableDubbo</span><br><span class="line">@MapperScan(&quot;com.xuan.project.mapper&quot;)</span><br><span class="line">public class MyApplication &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">       SpringApplication.run(MyApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>  启动主类查看Nacos 注册成功   <img src="http://halo-ctc.qiniu.ctcnb.cn/markdown/api/image-20230206121543673.png">  </p>
<h3 id="2、api-platform-gateway"><a href="#2、api-platform-gateway" class="headerlink" title="2、api-platform-gateway"></a>2、api-platform-gateway</h3><p>  在和backend一样的路径下新建rpc包 （com.xuan.project.rpc） 新增接口类 代码复制过来即可   <img src="http://halo-ctc.qiniu.ctcnb.cn/markdown/api/image-20230206121742038.png">   前往测试类做测试  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@SpringBootTest</span><br><span class="line">class ApiPlatformGatewayApplicationTests &#123;</span><br><span class="line"></span><br><span class="line">@DubboReference</span><br><span class="line">private RpcDemoService rpcDemoService;</span><br><span class="line"></span><br><span class="line">@Test</span><br><span class="line">void testRpc() &#123;</span><br><span class="line">System.out.println(rpcDemoService.sayHello(&quot;world&quot;));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>  测试成功~   <img src="http://halo-ctc.qiniu.ctcnb.cn/markdown/api/image-20230206121833955.png">  </p>
<h2 id="3、抽象公共服务"><a href="#3、抽象公共服务" class="headerlink" title="3、抽象公共服务"></a>3、抽象公共服务</h2><hr>
<p>项目名：api-platform-common 目的是让方法、实体类在多个项目间复用，减少重复编写  </p>
<h3 id="1、抽取的服务"><a href="#1、抽取的服务" class="headerlink" title="1、抽取的服务"></a>1、抽取的服务</h3><p> </p>
<ol>
<li><p>数据库中查是否已分配给用户秘钥(根据 accessKey 拿到用户信息，返回用户信息，为空表示不存在）</p>
</li>
<li><p>从数据库中查询模拟接口是否存在（请求路径、请求方法、请求参数，返回接口信息，为空表示不存在）</p>
</li>
<li><p>接口调用次数+ 1 invokeCount (accessKey、secretKey(标识用户），请求接口路径)</p>
</li>
</ol>
<p> </p>
<h3 id="2、具体操作"><a href="#2、具体操作" class="headerlink" title="2、具体操作"></a>2、具体操作</h3><p> </p>
<ol>
<li>新建maven项目 取名为api-platform-common 依赖才api-platform-backend里复制后摘出我需要的</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot;</span><br><span class="line">         xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;</span><br><span class="line">    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</span><br><span class="line"></span><br><span class="line">    &lt;parent&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;2.7.0&lt;/version&gt;</span><br><span class="line">        &lt;relativePath/&gt; &lt;!-- lookup parent from repository --&gt;</span><br><span class="line">    &lt;/parent&gt;</span><br><span class="line"></span><br><span class="line">    &lt;groupId&gt;com.xuan&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;api-platform-common&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;0.0.1&lt;/version&gt;</span><br><span class="line"></span><br><span class="line">    &lt;properties&gt;</span><br><span class="line">        &lt;maven.compiler.source&gt;8&lt;/maven.compiler.source&gt;</span><br><span class="line">        &lt;maven.compiler.target&gt;8&lt;/maven.compiler.target&gt;</span><br><span class="line">        &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;</span><br><span class="line">    &lt;/properties&gt;</span><br><span class="line"></span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line"></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.mybatis.spring.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;mybatis-spring-boot-starter&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;2.2.2&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.baomidou&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;mybatis-plus-boot-starter&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;3.5.1&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!-- https://mvnrepository.com/artifact/com.google.code.gson/gson --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.google.code.gson&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;gson&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;2.9.0&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;!-- https://mvnrepository.com/artifact/org.apache.commons/commons-lang3 --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.apache.commons&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;commons-lang3&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;3.12.0&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;mysql&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;</span><br><span class="line">            &lt;scope&gt;runtime&lt;/scope&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;lombok&lt;/artifactId&gt;</span><br><span class="line">            &lt;optional&gt;true&lt;/optional&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;</span><br><span class="line">            &lt;scope&gt;test&lt;/scope&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;!-- https://mvnrepository.com/artifact/junit/junit --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;junit&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;junit&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;4.13.2&lt;/version&gt;</span><br><span class="line">            &lt;scope&gt;test&lt;/scope&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">    &lt;/dependencies&gt;</span><br><span class="line"></span><br><span class="line">&lt;/project&gt;</span><br></pre></td></tr></table></figure>

<p> </p>
<ol start="2">
<li><p>复制之前的model包下的实体类</p>
</li>
<li><p>在common包下新建service层 <img src="http://halo-ctc.qiniu.ctcnb.cn/markdown/api/image-20230207113847350.png"></p>
</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">public interface InnerInterfaceInfoService &#123;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 根据path、method查询接口信息</span><br><span class="line"> *</span><br><span class="line"> * @param path   请求路径</span><br><span class="line"> * @param method 请求方法</span><br><span class="line"> * @return InterfaceInfo</span><br><span class="line"> */</span><br><span class="line">InterfaceInfo getInvokeInterfaceInfo(String path, String method);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public interface InnerUserService &#123;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 根据accessKey查询用户</span><br><span class="line">     *</span><br><span class="line">     * @param accessKey accessKey</span><br><span class="line">     * @return User</span><br><span class="line">     */</span><br><span class="line">    User getInvokeUser(String accessKey);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public interface InnerUserInterfaceInfoService &#123;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line"> * 是否还有调用次数</span><br><span class="line"> *</span><br><span class="line"> * @param userId          用户id</span><br><span class="line"> * @param interfaceInfoId 接口id</span><br><span class="line"> * @return boolean</span><br><span class="line"> */</span><br><span class="line">boolean hasInvokeNum(long userId, long interfaceInfoId);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 根据userId、interfaceInfoId计数</span><br><span class="line"> *</span><br><span class="line"> * @param userId          用户id</span><br><span class="line"> * @param interfaceInfoId 接口id</span><br><span class="line"> * @return boolean</span><br><span class="line"> */</span><br><span class="line">boolean invokeInterfaceCount(long userId, long interfaceInfoId);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> </p>
<ol start="4">
<li>打包 使用maven install打包 api-platform-backend引入依赖</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.xuan&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;api-platform-common&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;0.0.1&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<p> </p>
<ol start="5">
<li>编写impl进行测试</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * @version 1.0</span><br><span class="line"> * @author: 玄</span><br><span class="line"> * @date: 2023/2/6</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">@DubboService</span><br><span class="line">public class InnerUserInterfaceInfoServiceImpl implements InnerUserInterfaceInfoService &#123;</span><br><span class="line"></span><br><span class="line">@Resource</span><br><span class="line">private UserInterfaceInfoMapper userInterfaceInfoMapper;</span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line">public boolean hasInvokeNum(long userId, long interfaceInfoId) &#123;</span><br><span class="line">if (userId &lt;= 0  interfaceInfoId &lt;= 0) &#123;</span><br><span class="line">throw new BusinessException(ErrorCode.NOT_FOUND_ERROR);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">LambdaQueryWrapper&lt;UserInterfaceInfo&gt; queryWrapper = new LambdaQueryWrapper&lt;&gt;();</span><br><span class="line">queryWrapper.eq(UserInterfaceInfo::getUserId, userId)</span><br><span class="line">.eq(UserInterfaceInfo::getInterfaceInfoId, interfaceInfoId)</span><br><span class="line">.gt(UserInterfaceInfo::getLeftNum, 0);</span><br><span class="line"></span><br><span class="line">UserInterfaceInfo userInterfaceInfo = userInterfaceInfoMapper.selectOne(queryWrapper);</span><br><span class="line">return userInterfaceInfo != null;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line">public boolean invokeInterfaceCount(long userId, long interfaceInfoId) &#123;</span><br><span class="line">if (userId &lt;= 0  interfaceInfoId &lt;= 0) &#123;</span><br><span class="line">throw new BusinessException(ErrorCode.NOT_FOUND_ERROR);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">LambdaUpdateWrapper&lt;UserInterfaceInfo&gt; updateWrapper = new LambdaUpdateWrapper&lt;&gt;();</span><br><span class="line">updateWrapper.eq(UserInterfaceInfo::getUserId, userId)</span><br><span class="line">.eq(UserInterfaceInfo::getInterfaceInfoId, interfaceInfoId)</span><br><span class="line">.gt(UserInterfaceInfo::getLeftNum, 0)</span><br><span class="line">.setSql(&quot;left_num = left_num -1, total_num = total_num + 1&quot;);</span><br><span class="line"></span><br><span class="line">int updateCount = userInterfaceInfoMapper.update(null, updateWrapper);</span><br><span class="line">return updateCount &gt; 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> </p>
<ol start="6">
<li>gateway启动报错</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Description:</span><br><span class="line"></span><br><span class="line">Failed to configure a DataSource: &#x27;url&#x27; attribute is not specified and no embedded datasource could be configured.</span><br><span class="line"></span><br><span class="line">Reason: Failed to determine a suitable driver class</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Action:</span><br><span class="line"></span><br><span class="line">Consider the following:</span><br><span class="line">If you want an embedded database (H2, HSQL or Derby), please put it on the classpath.</span><br><span class="line">If you have database settings to be loaded from a particular profile you may need to activate it (no profiles are currently active).</span><br></pre></td></tr></table></figure>

<p><img src="http://halo-ctc.qiniu.ctcnb.cn/markdown/api/image-20230207151142622.png"> 经分析我们需要在主类上排除数据库的类加载（google springboot忽略数据库启动得到）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">package com.xuan.project;</span><br><span class="line"></span><br><span class="line">import org.apache.dubbo.config.spring.context.annotation.EnableDubbo;</span><br><span class="line">import org.springframework.boot.SpringApplication;</span><br><span class="line">import org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line">import org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration;</span><br><span class="line">import org.springframework.boot.autoconfigure.jdbc.DataSourceTransactionManagerAutoConfiguration;</span><br><span class="line">import org.springframework.boot.autoconfigure.orm.jpa.HibernateJpaAutoConfiguration;</span><br><span class="line"></span><br><span class="line">@EnableDubbo</span><br><span class="line">@SpringBootApplication(exclude = &#123;DataSourceAutoConfiguration.class,</span><br><span class="line">DataSourceTransactionManagerAutoConfiguration.class,</span><br><span class="line">HibernateJpaAutoConfiguration.class&#125;)</span><br><span class="line">public class ApiPlatformGatewayApplication &#123;</span><br><span class="line"></span><br><span class="line">public static void main(String[] args) &#123;</span><br><span class="line">SpringApplication.run(ApiPlatformGatewayApplication.class, args);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再次启动网关成功~</p>
<ol start="7">
<li>测试跑通 <img src="http://halo-ctc.qiniu.ctcnb.cn/markdown/api/image-20230206180958642.png"></li>
</ol>
<p> </p>
<h3 id="3、impl具体实现"><a href="#3、impl具体实现" class="headerlink" title="3、impl具体实现"></a>3、impl具体实现</h3><p>  在backend新建 service&#x2F;impl&#x2F;inner包   <img src="http://halo-ctc.qiniu.ctcnb.cn/markdown/api/image-20230207114407493.png">  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * @version 1.0</span><br><span class="line"> * @author: 玄</span><br><span class="line"> * @date: 2023/2/6</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">@DubboService</span><br><span class="line">public class InnerInterfaceInfoServiceImpl implements InnerInterfaceInfoService &#123;</span><br><span class="line"></span><br><span class="line">@Resource</span><br><span class="line">private InterfaceInfoMapper interfaceInfoMapper;</span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line">public InterfaceInfo getInvokeInterfaceInfo(String url, String method) &#123;</span><br><span class="line">if (StrUtil.hasBlank(url, method)) &#123;</span><br><span class="line">throw new BusinessException(ErrorCode.PARAMS_ERROR);</span><br><span class="line">&#125;</span><br><span class="line">LambdaQueryWrapper&lt;InterfaceInfo&gt; lambdaQueryWrapper = new LambdaQueryWrapper&lt;&gt;();</span><br><span class="line">lambdaQueryWrapper.eq(InterfaceInfo::getUrl, url).eq(InterfaceInfo::getMethod, method);</span><br><span class="line">return interfaceInfoMapper.selectOne(lambdaQueryWrapper);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * @version 1.0</span><br><span class="line"> * @author: 玄</span><br><span class="line"> * @date: 2023/2/6</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">@DubboService</span><br><span class="line">public class InnerUserServiceImpl implements InnerUserService &#123;</span><br><span class="line"></span><br><span class="line">@Resource</span><br><span class="line">private UserMapper userMapper;</span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line">public User getInvokeUser(String accessKey) &#123;</span><br><span class="line">if (StrUtil.isBlank(accessKey)) &#123;</span><br><span class="line">throw new BusinessException(ErrorCode.PARAMS_ERROR);</span><br><span class="line">&#125;</span><br><span class="line">LambdaQueryWrapper&lt;User&gt; lambdaQueryWrapper = new LambdaQueryWrapper&lt;&gt;();</span><br><span class="line">lambdaQueryWrapper.eq(User::getAccessKey, accessKey);</span><br><span class="line">return userMapper.selectOne(lambdaQueryWrapper);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> </p>
<h2 id="4、优化网关Global-Filter"><a href="#4、优化网关Global-Filter" class="headerlink" title="4、优化网关Global Filter"></a>4、优化网关Global Filter</h2><p> </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 全局过滤器</span><br><span class="line"> *</span><br><span class="line"> * @version 1.0</span><br><span class="line"> * @author: 玄</span><br><span class="line"> * @date: 2023/2/1</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">@Slf4j</span><br><span class="line">@Component</span><br><span class="line">public class CustomGlobalFilter implements GlobalFilter, Ordered &#123;</span><br><span class="line"></span><br><span class="line">@DubboReference</span><br><span class="line">private InnerUserService innerUserService;</span><br><span class="line"></span><br><span class="line">@DubboReference</span><br><span class="line">private InnerInterfaceInfoService innerInterfaceInfoService;</span><br><span class="line"></span><br><span class="line">@DubboReference</span><br><span class="line">private InnerUserInterfaceInfoService innerUserInterfaceInfoService;</span><br><span class="line"></span><br><span class="line">private static final List&lt;String&gt; IP_WHITE_LIST = Arrays.asList(&quot;127.0.0.1&quot;, &quot;127.0.0.2&quot;);</span><br><span class="line"></span><br><span class="line">private static final long FIVE_MINUTES = 5 * 60 * 1000L;</span><br><span class="line"></span><br><span class="line">private static final String INTERFACE_HOST = &quot;http://localhost:8090&quot;;</span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line">public Mono&lt;Void&gt; filter(ServerWebExchange exchange, GatewayFilterChain chain) &#123;</span><br><span class="line">// 1. 请求日志</span><br><span class="line">ServerHttpRequest request = exchange.getRequest();</span><br><span class="line">String path = INTERFACE_HOST + request.getPath().value();</span><br><span class="line">String method = Objects.requireNonNull(request.getMethod()).toString();</span><br><span class="line">log.info(&quot;请求id: &#123;&#125;&quot;, request.getId());</span><br><span class="line">log.info(&quot;请求路径: &#123;&#125;&quot;, path);</span><br><span class="line">log.info(&quot;请求方法: &#123;&#125;&quot;, method);</span><br><span class="line">log.info(&quot;请求参数: &#123;&#125;&quot;, request.getQueryParams());</span><br><span class="line">log.info(&quot;请求头: &#123;&#125;&quot;, request.getHeaders());</span><br><span class="line">String remoteAddress = Objects.requireNonNull(request.getRemoteAddress()).getHostString();</span><br><span class="line">log.info(&quot;请求地址: &#123;&#125;&quot;, remoteAddress);</span><br><span class="line"></span><br><span class="line">// 2. 访问控制 - 黑白名单</span><br><span class="line">ServerHttpResponse response = exchange.getResponse();</span><br><span class="line">if (!IP_WHITE_LIST.contains(remoteAddress)) &#123;</span><br><span class="line">return handleNoAuth(response);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 3. 用户鉴权</span><br><span class="line">HttpHeaders headers = request.getHeaders();</span><br><span class="line">String accessKey = headers.getFirst(&quot;accessKey&quot;);</span><br><span class="line">// 防止中文乱码</span><br><span class="line">String body = null;</span><br><span class="line">try &#123;</span><br><span class="line">body = URLDecoder.decode(headers.getFirst(&quot;body&quot;), StandardCharsets.UTF_8.name());</span><br><span class="line">&#125; catch (UnsupportedEncodingException e) &#123;</span><br><span class="line">throw new RuntimeException(e);</span><br><span class="line">&#125;</span><br><span class="line">String sign = headers.getFirst(&quot;sign&quot;);</span><br><span class="line">String nonce = headers.getFirst(&quot;nonce&quot;);</span><br><span class="line">String timestamp = headers.getFirst(&quot;timestamp&quot;);</span><br><span class="line">boolean hasBlank = StrUtil.hasBlank(accessKey, body, sign, nonce, timestamp);</span><br><span class="line">// 判断是否有空</span><br><span class="line">if (hasBlank) &#123;</span><br><span class="line">return handleInvokeError(response);</span><br><span class="line">&#125;</span><br><span class="line">// 使用accessKey去数据库查询secretKey</span><br><span class="line">User invokeUser = null;</span><br><span class="line">try &#123;</span><br><span class="line">invokeUser = innerUserService.getInvokeUser(accessKey);</span><br><span class="line">&#125; catch (Exception e) &#123;</span><br><span class="line">log.error(&quot;getInvokeUser error&quot;, e);</span><br><span class="line">&#125;</span><br><span class="line">if (invokeUser == null) &#123;</span><br><span class="line">return handleInvokeError(response);</span><br><span class="line">&#125;</span><br><span class="line">String secretKey = invokeUser.getSecretKey();</span><br><span class="line">String sign1 = SignUtil.getSign(body, secretKey);</span><br><span class="line">if (!StrUtil.equals(sign, sign1)) &#123;</span><br><span class="line">return handleInvokeError(response);</span><br><span class="line">&#125;</span><br><span class="line">// TODO 判断随机数nonce</span><br><span class="line">// 时间戳是否为数字</span><br><span class="line">if (!NumberUtil.isNumber(timestamp)) &#123;</span><br><span class="line">return handleInvokeError(response);</span><br><span class="line">&#125;</span><br><span class="line">// 五分钟内的请求有效</span><br><span class="line">if (System.currentTimeMillis() - Long.parseLong(timestamp) &gt; FIVE_MINUTES) &#123;</span><br><span class="line">return handleInvokeError(response);</span><br><span class="line">&#125;</span><br><span class="line">// 4. 请求的模拟接口是否存在</span><br><span class="line">InterfaceInfo invokeInterfaceInfo = null;</span><br><span class="line">try &#123;</span><br><span class="line">invokeInterfaceInfo = innerInterfaceInfoService.getInvokeInterfaceInfo(path, method);</span><br><span class="line">&#125; catch (Exception e) &#123;</span><br><span class="line">log.error(&quot;getInvokeInterfaceInfo error&quot;, e);</span><br><span class="line">&#125;</span><br><span class="line">if (invokeInterfaceInfo == null) &#123;</span><br><span class="line">return handleInvokeError(response);</span><br><span class="line">&#125;</span><br><span class="line">//  是否有调用次数</span><br><span class="line">if (!innerUserInterfaceInfoService.hasInvokeNum(invokeUser.getId(), invokeInterfaceInfo.getId())) &#123;</span><br><span class="line">return handleInvokeError(response);</span><br><span class="line">&#125;</span><br><span class="line">// 5. 请求转发，调用模拟接口</span><br><span class="line">return handleResponse(exchange, chain, invokeUser.getId(), invokeInterfaceInfo.getId());</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line">public int getOrder() &#123;</span><br><span class="line">return -1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 处理响应</span><br><span class="line"> *</span><br><span class="line"> * @param exchange</span><br><span class="line"> * @param chain</span><br><span class="line"> * @return</span><br><span class="line"> */</span><br><span class="line">private Mono&lt;Void&gt; handleResponse(ServerWebExchange exchange, GatewayFilterChain chain, long userId, long interfaceInfoId) &#123;</span><br><span class="line">try &#123;</span><br><span class="line">// 从交换机拿到原始response</span><br><span class="line">ServerHttpResponse originalResponse = exchange.getResponse();</span><br><span class="line">// 缓冲区工厂 拿到缓存数据</span><br><span class="line">DataBufferFactory bufferFactory = originalResponse.bufferFactory();</span><br><span class="line">// 拿到状态码</span><br><span class="line">HttpStatus statusCode = originalResponse.getStatusCode();</span><br><span class="line"></span><br><span class="line">if (statusCode == HttpStatus.OK) &#123;</span><br><span class="line">// 装饰，增强能力</span><br><span class="line">ServerHttpResponseDecorator decoratedResponse = new ServerHttpResponseDecorator(originalResponse) &#123;</span><br><span class="line">// 等调用完转发的接口后才会执行</span><br><span class="line">@Override</span><br><span class="line">public Mono&lt;Void&gt; writeWith(Publisher&lt;? extends DataBuffer&gt; body) &#123;</span><br><span class="line">log.info(&quot;body instanceof Flux: &#123;&#125;&quot;, (body instanceof Flux));</span><br><span class="line">// 对象是响应式的</span><br><span class="line">if (body instanceof Flux) &#123;</span><br><span class="line">// 我们拿到真正的body</span><br><span class="line">Flux&lt;? extends DataBuffer&gt; fluxBody = Flux.from(body);</span><br><span class="line">// 往返回值里面写数据</span><br><span class="line">// 拼接字符串</span><br><span class="line">return super.writeWith(fluxBody.map(dataBuffer -&gt; &#123;</span><br><span class="line">// 7. 调用成功，接口调用次数+1</span><br><span class="line">try &#123;</span><br><span class="line">innerUserInterfaceInfoService.invokeInterfaceCount(userId, interfaceInfoId);</span><br><span class="line">&#125; catch (Exception e) &#123;</span><br><span class="line">log.error(&quot;invokeInterfaceCount error&quot;, e);</span><br><span class="line">&#125;</span><br><span class="line">// data从这个content中读取</span><br><span class="line">byte[] content = new byte[dataBuffer.readableByteCount()];</span><br><span class="line">dataBuffer.read(content);</span><br><span class="line">DataBufferUtils.release(dataBuffer);// 释放掉内存</span><br><span class="line">// 6.构建日志</span><br><span class="line">List&lt;Object&gt; rspArgs = new ArrayList&lt;&gt;();</span><br><span class="line">rspArgs.add(originalResponse.getStatusCode());</span><br><span class="line">String data = new String(content, StandardCharsets.UTF_8);// data</span><br><span class="line">rspArgs.add(data);</span><br><span class="line">log.info(&quot;&lt;--- status:&#123;&#125; data:&#123;&#125;&quot;// data</span><br><span class="line">, rspArgs.toArray());// log.info(&quot;&lt;-- &#123;&#125; &#123;&#125;&quot;, originalResponse.getStatusCode(), data);</span><br><span class="line">return bufferFactory.wrap(content);</span><br><span class="line">&#125;));</span><br><span class="line">&#125; else &#123;</span><br><span class="line">// 8.调用失败返回错误状态码</span><br><span class="line">log.error(&quot;&lt;--- &#123;&#125; 响应code异常&quot;, getStatusCode());</span><br><span class="line">&#125;</span><br><span class="line">return super.writeWith(body);</span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br><span class="line">// 设置 response 对象为装饰过的</span><br><span class="line">return chain.filter(exchange.mutate().response(decoratedResponse).build());</span><br><span class="line">&#125;</span><br><span class="line">return chain.filter(exchange);// 降级处理返回数据</span><br><span class="line">&#125; catch (Exception e) &#123;</span><br><span class="line">log.error(&quot;gateway log exception.\n&quot; + e);</span><br><span class="line">return chain.filter(exchange);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private Mono&lt;Void&gt; handleNoAuth(ServerHttpResponse response) &#123;</span><br><span class="line">response.setStatusCode(HttpStatus.FORBIDDEN);</span><br><span class="line">return response.setComplete();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private Mono&lt;Void&gt; handleInvokeError(ServerHttpResponse response) &#123;</span><br><span class="line">response.setStatusCode(HttpStatus.INTERNAL_SERVER_ERROR);</span><br><span class="line">return response.setComplete();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> </p>
<h1 id="十四、统计分析"><a href="#十四、统计分析" class="headerlink" title="十四、统计分析"></a>十四、统计分析</h1><hr>
<p><strong>需求</strong>   各接口的总调用次数占比（饼图）取调用最多的前 3个接口，从而分析出哪些接口没有人用（降低资源、或者下线），高频接口（增加资源、提高收费）。用饼图展示。  </p>
<h2 id="1、后端-1"><a href="#1、后端-1" class="headerlink" title="1、后端"></a>1、后端</h2><hr>
<h3 id="1、编写SQL"><a href="#1、编写SQL" class="headerlink" title="1、编写SQL"></a>1、编写SQL</h3><p> </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">SELECT</span><br><span class="line">interface_info_id,</span><br><span class="line">SUM( total_num ) AS invoke_num </span><br><span class="line">FROM</span><br><span class="line">user_interface_info </span><br><span class="line">GROUP BY</span><br><span class="line">interface_info_id </span><br><span class="line">ORDER BY</span><br><span class="line">invoke_num DESC </span><br><span class="line">LIMIT 3</span><br></pre></td></tr></table></figure>

<p>  <img src="http://halo-ctc.qiniu.ctcnb.cn/markdown/api/image-20230207154946647.png">   SQL语句确认没问题后 再在代码里编写  </p>
<h3 id="2、编写接口"><a href="#2、编写接口" class="headerlink" title="2、编写接口"></a>2、编写接口</h3><p>  新增VO、Mapper、Service、Controller   <strong>VO</strong>  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@EqualsAndHashCode(callSuper = true)</span><br><span class="line">@Data</span><br><span class="line">public class InvokeInterfaceInfoVO extends InterfaceInfo &#123;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 接口调用次数</span><br><span class="line">     */</span><br><span class="line">    private Integer invokeNum;</span><br><span class="line"></span><br><span class="line">    private static final long serialVersionUID = 1L;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>  <strong>Mapper</strong>  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public interface UserInterfaceInfoMapper extends BaseMapper&lt;UserInterfaceInfo&gt; &#123;</span><br><span class="line">    </span><br><span class="line">List&lt;InvokeInterfaceInfoVO&gt; listTopInvokeInterfaceInfo(int limit);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE mapper</span><br><span class="line">        PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span><br><span class="line">        &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span><br><span class="line">&lt;mapper namespace=&quot;com.xuan.project.mapper.UserInterfaceInfoMapper&quot;&gt;</span><br><span class="line">   </span><br><span class="line">    &lt;select id=&quot;listTopInvokeInterfaceInfo&quot; resultType=&quot;com.xuan.project.model.vo.InvokeInterfaceInfoVO&quot;&gt;</span><br><span class="line">        SELECT interface_info_id AS id,</span><br><span class="line">               SUM(total_num)    AS invoke_num</span><br><span class="line">        FROM user_interface_info</span><br><span class="line">        GROUP BY interface_info_id</span><br><span class="line">        ORDER BY invoke_num DESC LIMIT #&#123;limit&#125;</span><br><span class="line">    &lt;/select&gt;</span><br><span class="line">    </span><br><span class="line">&lt;/mapper&gt;</span><br></pre></td></tr></table></figure>

<p>  注意 ：SELECT interface_info_id AS id, 这里一定要AS id 因为VO类继承的InterfaceInfo类。这里面只有id字段   <strong>Service</strong>  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * @version 1.0</span><br><span class="line"> * @author: 玄</span><br><span class="line"> * @date: 2023/2/7</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">@Service</span><br><span class="line">public class ChartServiceImpl implements ChartService &#123;</span><br><span class="line"></span><br><span class="line">@Resource</span><br><span class="line">private UserInterfaceInfoMapper userInterfaceInfoMapper;</span><br><span class="line"></span><br><span class="line">@Resource</span><br><span class="line">private InterfaceInfoService interfaceInfoService;</span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line">public List&lt;InvokeInterfaceInfoVO&gt; listTopInvokeInterfaceInfo(int limit) &#123;</span><br><span class="line">List&lt;InvokeInterfaceInfoVO&gt; vos = userInterfaceInfoMapper.listTopInvokeInterfaceInfo(limit);</span><br><span class="line">if (vos == null  vos.size() == 0) &#123;</span><br><span class="line">throw new BusinessException(ErrorCode.SYSTEM_ERROR);</span><br><span class="line">&#125;</span><br><span class="line">// 根据id查询接口名称</span><br><span class="line">LinkedHashMap&lt;Long, InvokeInterfaceInfoVO&gt; voHashMap = new LinkedHashMap&lt;&gt;(vos.size());</span><br><span class="line">for (InvokeInterfaceInfoVO vo : vos) &#123;</span><br><span class="line">voHashMap.put(vo.getId(), vo);</span><br><span class="line">&#125;</span><br><span class="line">LambdaQueryWrapper&lt;InterfaceInfo&gt; queryWrapper = new LambdaQueryWrapper&lt;&gt;();</span><br><span class="line">queryWrapper.in(InterfaceInfo::getId, voHashMap.keySet());</span><br><span class="line">List&lt;InterfaceInfo&gt; infoList = interfaceInfoService.list(queryWrapper);</span><br><span class="line"></span><br><span class="line">for (InterfaceInfo interfaceInfo : infoList) &#123;</span><br><span class="line">voHashMap.get(interfaceInfo.getId()).setName(interfaceInfo.getName());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">return new ArrayList&lt;&gt;(voHashMap.values());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>  也可以使用stream流来实现   <strong>Controller</strong>  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 图表</span><br><span class="line"> *</span><br><span class="line"> * @version 1.0</span><br><span class="line"> * @author: 玄</span><br><span class="line"> * @date: 2023/2/7</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">@Slf4j</span><br><span class="line">@RestController</span><br><span class="line">@RequestMapping(&quot;/chart&quot;)</span><br><span class="line">public class ChartController &#123;</span><br><span class="line"></span><br><span class="line">@Resource</span><br><span class="line">private ChartService chartService;</span><br><span class="line"></span><br><span class="line">@GetMapping(&quot;/top/interface/invoke&quot;)</span><br><span class="line">BaseResponse&lt;List&lt;InvokeInterfaceInfoVO&gt;&gt; listTopInvokeInterfaceInfo () &#123;</span><br><span class="line">List&lt;InvokeInterfaceInfoVO&gt; listTopInvokeInterfaceInfo = chartService.listTopInvokeInterfaceInfo(3);</span><br><span class="line">return ResultUtils.success(listTopInvokeInterfaceInfo);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> </p>
<h2 id="2、前端-1"><a href="#2、前端-1" class="headerlink" title="2、前端"></a>2、前端</h2><hr>
<p>图表强烈推荐用现成的库！！！ 比如：  </p>
<ul>
<li><p><a target="_blank" rel="noopener" href="https://echarts.apache.org/zh/index.html">ECharts</a>（推荐）</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://antv.vision/zh">AntV</a>（推荐）</p>
</li>
<li><p>BizCharts</p>
</li>
</ul>
<p>  使用步骤都大同小异  </p>
<ol>
<li><p>看官网</p>
</li>
<li><p>找到快速入门、按文档去引入库</p>
</li>
<li><p>进入示例页面</p>
</li>
<li><p>找到你要的图</p>
</li>
<li><p>在线调试</p>
</li>
<li><p>复制代码</p>
</li>
<li><p>改为真实数据</p>
</li>
</ol>
<p>  这里选择使用了Echars再加上使用的是react 所以用这个库：<a target="_blank" rel="noopener" href="https://github.com/hustcc/echarts-for-react">https://github.com/hustcc/echarts-for-react</a>   config&#x2F;routes.ts下新增路由   src&#x2F;pages&#x2F;Admin中使用上面步骤写了一个简单页面  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">import &#123; PageContainer &#125; from &#x27;@ant-design/pro-components&#x27;;</span><br><span class="line">import ReactECharts from &#x27;echarts-for-react&#x27;;</span><br><span class="line">import React, &#123; useEffect, useState &#125; from &#x27;react&#x27;;</span><br><span class="line">import &#123; listTopInvokeInterfaceInfoUsingGET &#125; from &#x27;@/services/api-platform-backend/chartController&#x27;;</span><br><span class="line"></span><br><span class="line">const InterfaceChart: React.FC = () =&gt; &#123;</span><br><span class="line">  </span><br><span class="line">  const [data, setData] = useState&lt;API.InvokeInterfaceInfoVO[]&gt;([]);</span><br><span class="line"></span><br><span class="line">  const [loading, setLoading] = useState(true);</span><br><span class="line"></span><br><span class="line">  useEffect(() =&gt; &#123;</span><br><span class="line">    listTopInvokeInterfaceInfoUsingGET().then((res) =&gt; &#123;</span><br><span class="line">      if (res.data) &#123;</span><br><span class="line">        setData(res.data);</span><br><span class="line">        setLoading(false);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;, []);</span><br><span class="line"></span><br><span class="line">  const chartInterface = data.map((item) =&gt; &#123;</span><br><span class="line">    return &#123;</span><br><span class="line">      value: item.invokeNum,</span><br><span class="line">      name: item.name,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  const option = &#123;</span><br><span class="line">    tooltip: &#123;</span><br><span class="line">      trigger: &#x27;item&#x27;,</span><br><span class="line">    &#125;,</span><br><span class="line">    legend: &#123;</span><br><span class="line">      top: &#x27;5%&#x27;,</span><br><span class="line">      left: &#x27;center&#x27;,</span><br><span class="line">    &#125;,</span><br><span class="line">    series: [</span><br><span class="line">      &#123;</span><br><span class="line">        name: &#x27;Access From&#x27;,</span><br><span class="line">        type: &#x27;pie&#x27;,</span><br><span class="line">        radius: [&#x27;40%&#x27;, &#x27;70%&#x27;],</span><br><span class="line">        avoidLabelOverlap: false,</span><br><span class="line">        itemStyle: &#123;</span><br><span class="line">          borderRadius: 10,</span><br><span class="line">          borderColor: &#x27;#fff&#x27;,</span><br><span class="line">          borderWidth: 2,</span><br><span class="line">        &#125;,</span><br><span class="line">        label: &#123;</span><br><span class="line">          show: false,</span><br><span class="line">          position: &#x27;center&#x27;,</span><br><span class="line">        &#125;,</span><br><span class="line">        emphasis: &#123;</span><br><span class="line">          label: &#123;</span><br><span class="line">            show: true,</span><br><span class="line">            fontSize: 20,</span><br><span class="line">            fontWeight: &#x27;bold&#x27;,</span><br><span class="line">          &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">        labelLine: &#123;</span><br><span class="line">          show: false,</span><br><span class="line">        &#125;,</span><br><span class="line">        data: chartInterface,</span><br><span class="line">      &#125;,</span><br><span class="line">    ],</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  return (</span><br><span class="line">    &lt;PageContainer title=&#123;&#x27;接口调用情况&#x27;&#125;&gt;</span><br><span class="line">      &lt;ReactECharts showLoading=&#123;loading&#125; option=&#123;option&#125; /&gt;</span><br><span class="line">    &lt;/PageContainer&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">export default InterfaceChart;</span><br></pre></td></tr></table></figure>

<p>  效果如下   <img src="http://halo-ctc.qiniu.ctcnb.cn/markdown/api/image-20230207184004186.png">  </p>
<h1 id="十五、拓展点"><a href="#十五、拓展点" class="headerlink" title="十五、拓展点"></a>十五、拓展点</h1><p> </p>
<ol>
<li><p>用户可以申请更换签名</p>
</li>
<li><p>怎么让其他用户也上传接口？ 需要提供一个机制 (界面），让用户输入自己的接口host （服务器地址）、接口信息，将接口信息写入数据库。 可以在 interfacelnto 表里加个 host 字段，区分服务器地址，让接口提供者更灵活地接入系统。 将接口信息写入数据库之前，要对接口进行校验（比如检查他的地址是否遵循规则，测试调用），保证他是正常的。 将接口信息写入数据库之前遵循咱们的要求（井且使用咱们的 sdk），在接入时，平台需要测试调用这个接口，保证他是正常的。</p>
</li>
<li><p>网关校验是否还有调用次数 需要考虑井发问题，防止瞬间调用超额。</p>
</li>
<li><p>网关优化 比如增加限流 &#x2F;降级保护，提高性能等。还可以考虑搭配 Nginx 网关使用。</p>
</li>
<li><p>功能增强 可以针对不同的请求头或者接口类型来设计前端界面和表单，便于用户调用，获得更好的体验。 可以参考 swagger、postman、knife4j 的页面。</p>
</li>
</ol>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a href="http://example.com">阿库娅</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="http://example.com/2024/07/07/api%E5%BC%80%E5%8F%91%E5%B9%B3%E5%8F%B0/">http://example.com/2024/07/07/api%E5%BC%80%E5%8F%91%E5%B9%B3%E5%8F%B0/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/java/">java</a><a class="post-meta__tags" href="/tags/api%E5%BC%80%E5%8F%91%E5%B9%B3%E5%8F%B0/">api开发平台</a><a class="post-meta__tags" href="/tags/%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/">项目实战</a></div><div class="post_share"><div class="social-share" data-image="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/07/07/docker-java%E4%BD%BF%E7%94%A8win%E7%B3%BB%E7%BB%9F%E4%B8%8Bdocker/" title="docker-java使用win系统下docker"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">Previous</div><div class="prev_info">docker-java使用win系统下docker</div></div></a></div><div class="next-post pull-right"><a href="/2024/07/07/python%E7%A8%8B%E5%BA%8F%E6%89%93%E5%8C%85%E4%B8%BAwin-linux%E5%8F%AF%E6%89%A7%E8%A1%8C%E6%96%87%E4%BB%B6/" title="python程序打包为win/linux可执行文件"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">Next</div><div class="next_info">python程序打包为win/linux可执行文件</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><div><a href="/2022/11/25/java%E7%9F%A5%E8%AF%86%E7%82%B9-%E5%B9%B6%E5%8F%91%E7%AF%87/" title="java知识点-并发篇"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-11-25</div><div class="title">java知识点-并发篇</div></div></a></div><div><a href="/2023/03/08/java%E7%9F%A5%E8%AF%86%E7%82%B9-%E6%A1%86%E6%9E%B6%E7%AF%87/" title="java知识点——框架篇"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-03-08</div><div class="title">java知识点——框架篇</div></div></a></div><div><a href="/2022/12/19/java%E7%AE%97%E6%B3%95%E6%A8%A1%E6%9D%BF%E6%B1%87%E6%80%BB/" title="java算法模板汇总"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-19</div><div class="title">java算法模板汇总</div></div></a></div><div><a href="/2023/03/08/java%E7%9F%A5%E8%AF%86%E7%82%B9-%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%AF%87/" title="java知识点——虚拟机篇"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-03-08</div><div class="title">java知识点——虚拟机篇</div></div></a></div><div><a href="/2023/02/18/leetcode%E5%88%B7%E9%A2%98-%E5%89%91%E6%8C%87-offer/" title="leetcode刷题——剑指 Offer"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-02-18</div><div class="title">leetcode刷题——剑指 Offer</div></div></a></div><div><a href="/2023/02/22/%E4%BA%8C%E5%88%86%E6%9F%A5%E6%89%BE%E5%AE%9A%E8%BE%B9%E7%95%8C%EF%BC%88%E8%AF%A6%E7%BB%86%E8%A7%A3%E6%9E%90%EF%BC%89/" title="二分查找定边界（详细解析）"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-02-22</div><div class="title">二分查找定边界（详细解析）</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">阿库娅</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">31</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">78</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">8</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/ctcnb"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E9%A1%B9%E7%9B%AE%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">2.</span> <span class="toc-text">一、项目初始化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81Ant-Design-Pro"><span class="toc-number">2.1.</span> <span class="toc-text">1、Ant Design Pro</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E5%90%8E%E7%AB%AF"><span class="toc-number">2.2.</span> <span class="toc-text">2、后端</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">2.2.1.</span> <span class="toc-text">1、初始化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E6%95%B0%E6%8D%AE%E5%BA%93%E8%AE%BE%E8%AE%A1"><span class="toc-number">2.2.2.</span> <span class="toc-text">2、数据库设计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E4%BD%BF%E7%94%A8MabatisX%E6%8F%92%E4%BB%B6"><span class="toc-number">2.2.3.</span> <span class="toc-text">3、使用MabatisX插件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81Controller"><span class="toc-number">2.2.4.</span> <span class="toc-text">4、Controller</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5%E3%80%81DTO"><span class="toc-number">2.2.5.</span> <span class="toc-text">5、DTO</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6%E3%80%81Service"><span class="toc-number">2.2.6.</span> <span class="toc-text">6、Service</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81%E5%89%8D%E7%AB%AF"><span class="toc-number">2.3.</span> <span class="toc-text">3、前端</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E9%85%8D%E7%BD%AE%E6%8F%92%E4%BB%B6"><span class="toc-number">2.3.1.</span> <span class="toc-text">1、配置插件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E6%8E%A5%E5%8F%A3%E8%B0%83%E7%94%A8"><span class="toc-number">2.3.2.</span> <span class="toc-text">2、接口调用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E4%BF%AE%E6%94%B9%E7%99%BB%E5%BD%95%E7%9A%84%E6%8E%A5%E5%8F%A3"><span class="toc-number">2.3.3.</span> <span class="toc-text">3、修改登录的接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81%E6%B3%A8%E9%94%80"><span class="toc-number">2.3.4.</span> <span class="toc-text">4、注销</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5%E3%80%81%E7%AE%A1%E7%90%86%E6%9D%83%E9%99%90"><span class="toc-number">2.3.5.</span> <span class="toc-text">5、管理权限</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6%E3%80%81%E8%A1%A8%E6%A0%BC%E9%A1%B5%E9%9D%A2"><span class="toc-number">2.3.6.</span> <span class="toc-text">6、表格页面</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E5%9F%BA%E7%A1%80%E5%A2%9E%E5%88%A0%E6%94%B9%E6%9F%A5"><span class="toc-number">3.</span> <span class="toc-text">二、基础增删改查</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E4%BF%AE%E6%94%B9%E8%B7%AF%E7%94%B1"><span class="toc-number">3.1.</span> <span class="toc-text">1、修改路由</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E6%96%B0%E5%A2%9E%E6%8E%A5%E5%8F%A3%E4%BF%A1%E6%81%AF"><span class="toc-number">3.2.</span> <span class="toc-text">2、新增接口信息</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%EF%BC%89%E8%A1%A8%E5%8D%95%E6%A8%A1%E5%9D%97"><span class="toc-number">3.2.1.</span> <span class="toc-text">1）表单模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%EF%BC%89%E8%AF%B7%E6%B1%82%E5%90%8E%E7%AB%AF"><span class="toc-number">3.2.2.</span> <span class="toc-text">2）请求后端</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81%E7%BC%96%E8%BE%91%E6%8E%A5%E5%8F%A3%E4%BF%A1%E6%81%AF"><span class="toc-number">3.3.</span> <span class="toc-text">3、编辑接口信息</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%EF%BC%89%E8%A1%A8%E5%8D%95%E6%A8%A1%E5%9D%97-1"><span class="toc-number">3.3.1.</span> <span class="toc-text">1）表单模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%EF%BC%89%E8%AF%B7%E6%B1%82%E5%90%8E%E7%AB%AF-1"><span class="toc-number">3.3.2.</span> <span class="toc-text">2）请求后端</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4%E3%80%81%E5%88%A0%E9%99%A4%E6%8E%A5%E5%8F%A3%E4%BF%A1%E6%81%AF"><span class="toc-number">3.4.</span> <span class="toc-text">4、删除接口信息</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%89%E3%80%81API%E5%BC%80%E5%8F%91"><span class="toc-number">4.</span> <span class="toc-text">三、API开发</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E6%A8%A1%E6%8B%9F%E6%8E%A5%E5%8F%A3"><span class="toc-number">4.1.</span> <span class="toc-text">1、模拟接口</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E8%B0%83%E7%94%A8%E6%8E%A5%E5%8F%A3"><span class="toc-number">4.2.</span> <span class="toc-text">2、调用接口</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9B%9B%E3%80%81API%E7%AD%BE%E5%90%8D%E8%AE%A4%E8%AF%81"><span class="toc-number">5.</span> <span class="toc-text">四、API签名认证</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E4%BF%AE%E6%94%B9%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">5.1.</span> <span class="toc-text">1、修改数据库</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E5%8A%A0%E5%AF%86"><span class="toc-number">5.2.</span> <span class="toc-text">2、加密</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E5%8A%A0%E5%AF%86%E6%96%B9%E5%BC%8F"><span class="toc-number">5.2.1.</span> <span class="toc-text">1、加密方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E5%8A%A0%E5%AF%86%E4%BB%A3%E7%A0%81"><span class="toc-number">5.2.2.</span> <span class="toc-text">2、加密代码</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%94%E3%80%81%E5%BC%80%E5%8F%91%E4%B8%80%E4%B8%AASDK%EF%BC%88starter%EF%BC%89"><span class="toc-number">6.</span> <span class="toc-text">五、开发一个SDK（starter）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E6%96%B0%E5%BB%BA%E9%A1%B9%E7%9B%AE"><span class="toc-number">6.1.</span> <span class="toc-text">1、新建项目</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E7%BC%96%E5%86%99%E9%85%8D%E7%BD%AE%E7%B1%BB"><span class="toc-number">6.2.</span> <span class="toc-text">2、编写配置类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81%E6%8C%87%E5%AE%9A%E9%85%8D%E7%BD%AE%E7%B1%BB"><span class="toc-number">6.3.</span> <span class="toc-text">3、指定配置类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4%E3%80%81%E5%8F%91%E5%B8%83starter"><span class="toc-number">6.4.</span> <span class="toc-text">4、发布starter</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5%E3%80%81%E6%B5%8B%E8%AF%95"><span class="toc-number">6.5.</span> <span class="toc-text">5、测试</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%AD%E3%80%81%E6%8E%A5%E5%8F%A3%E5%8F%91%E5%B8%83-%E4%B8%8B%E7%BA%BF"><span class="toc-number">7.</span> <span class="toc-text">六、接口发布&#x2F;下线</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E5%90%8E%E7%AB%AF"><span class="toc-number">7.1.</span> <span class="toc-text">1、后端</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E5%89%8D%E7%AB%AF"><span class="toc-number">7.2.</span> <span class="toc-text">2、前端</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E6%B7%BB%E5%8A%A0%E5%8F%91%E5%B8%83%E6%8C%89%E9%92%AE%E5%92%8C%E4%B8%8B%E7%BA%BF%E6%8C%89%E9%92%AE"><span class="toc-number">7.2.1.</span> <span class="toc-text">1、添加发布按钮和下线按钮</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E7%BC%96%E5%86%99%E5%8F%91%E5%B8%83-%E4%B8%8B%E7%BA%BF%E7%9A%84%E6%96%B9%E6%B3%95"><span class="toc-number">7.2.2.</span> <span class="toc-text">2、编写发布&#x2F;下线的方法</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%83%E3%80%81%E7%94%A8%E6%88%B7%E4%B8%BB%E9%A1%B5"><span class="toc-number">8.</span> <span class="toc-text">七、用户主页</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E6%B5%8F%E8%A7%88%E6%8E%A5%E5%8F%A3"><span class="toc-number">8.0.1.</span> <span class="toc-text">1、浏览接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E6%9F%A5%E7%9C%8B%E6%8E%A5%E5%8F%A3%E6%96%87%E6%A1%A3"><span class="toc-number">8.0.2.</span> <span class="toc-text">2、查看接口文档</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E7%94%B3%E8%AF%B7%E7%AD%BE%E5%90%8D"><span class="toc-number">8.0.3.</span> <span class="toc-text">3、申请签名</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%AB%E3%80%81%E5%9C%A8%E7%BA%BF%E8%B0%83%E7%94%A8"><span class="toc-number">9.</span> <span class="toc-text">八、在线调用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E5%89%8D%E7%AB%AF%E7%AE%80%E5%8D%95%E6%A0%B7%E5%BC%8F"><span class="toc-number">9.1.</span> <span class="toc-text">1、前端简单样式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E4%BF%AE%E6%94%B9%E5%90%8E%E7%AB%AF"><span class="toc-number">9.2.</span> <span class="toc-text">2、修改后端</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81%E4%BF%AE%E6%94%B9%E5%89%8D%E7%AB%AF"><span class="toc-number">9.3.</span> <span class="toc-text">3、修改前端</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4%E3%80%81TODO"><span class="toc-number">9.4.</span> <span class="toc-text">4、TODO</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B9%9D%E3%80%81%E6%8E%A5%E5%8F%A3%E8%B0%83%E7%94%A8%E6%AC%A1%E6%95%B0%E7%BB%9F%E8%AE%A1"><span class="toc-number">10.</span> <span class="toc-text">九、接口调用次数统计</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E8%AE%BE%E8%AE%A1%E5%BA%93%E8%A1%A8"><span class="toc-number">10.1.</span> <span class="toc-text">1、设计库表</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E5%9F%BA%E7%A1%80%E5%A2%9E%E5%88%A0%E6%94%B9%E6%9F%A5"><span class="toc-number">10.2.</span> <span class="toc-text">2、基础增删改查</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81%E8%B0%83%E7%94%A8%E6%AC%A1%E6%95%B0%E7%BB%9F%E8%AE%A1"><span class="toc-number">10.3.</span> <span class="toc-text">3、调用次数统计</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4%E3%80%81%E9%97%AE%E9%A2%98"><span class="toc-number">10.4.</span> <span class="toc-text">4、问题</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8D%81%E3%80%81%E7%BD%91%E5%85%B3"><span class="toc-number">11.</span> <span class="toc-text">十、网关</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E7%BD%91%E5%85%B3%E4%BD%9C%E7%94%A8"><span class="toc-number">11.1.</span> <span class="toc-text">1、网关作用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E5%85%B7%E4%BD%93%E4%BD%9C%E7%94%A8"><span class="toc-number">11.2.</span> <span class="toc-text">2、具体作用</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8D%81%E4%B8%80%E3%80%81Spring-Cloud-Gateway"><span class="toc-number">12.</span> <span class="toc-text">十一、Spring Cloud Gateway</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5"><span class="toc-number">12.1.</span> <span class="toc-text">1、核心概念</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81Glossary"><span class="toc-number">12.1.1.</span> <span class="toc-text">1、Glossary</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E8%AF%B7%E6%B1%82%E6%B5%81%E7%A8%8B"><span class="toc-number">12.1.2.</span> <span class="toc-text">2、请求流程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E4%B8%A4%E7%A7%8D%E9%85%8D%E7%BD%AE%E6%96%B9%E5%BC%8F"><span class="toc-number">12.2.</span> <span class="toc-text">2、两种配置方式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81%E8%B7%AF%E7%94%B1%E7%9A%84%E5%90%84%E7%A7%8D%E6%96%AD%E8%A8%80"><span class="toc-number">12.3.</span> <span class="toc-text">3、路由的各种断言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4%E3%80%81%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="toc-number">12.4.</span> <span class="toc-text">4、过滤器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5%E3%80%81%E5%85%B6%E4%BB%96%E9%85%8D%E7%BD%AE"><span class="toc-number">12.5.</span> <span class="toc-text">5、其他配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E5%85%A8%E5%B1%80%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="toc-number">12.5.1.</span> <span class="toc-text">1、全局过滤器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81Http-timeouts-configuration"><span class="toc-number">12.5.2.</span> <span class="toc-text">2、Http timeouts configuration</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81CORS-Configuration"><span class="toc-number">12.5.3.</span> <span class="toc-text">3、CORS Configuration</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8D%81%E4%BA%8C%E3%80%81%E9%A1%B9%E7%9B%AE%E6%95%B4%E5%90%88%E7%BD%91%E5%85%B3"><span class="toc-number">13.</span> <span class="toc-text">十二、项目整合网关</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E8%AF%B7%E6%B1%82%E8%BD%AC%E5%8F%91"><span class="toc-number">13.1.</span> <span class="toc-text">1、请求转发</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81Global-Filter"><span class="toc-number">13.2.</span> <span class="toc-text">2、Global Filter</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E8%AF%B7%E6%B1%82%E6%97%A5%E5%BF%97"><span class="toc-number">13.2.1.</span> <span class="toc-text">1、请求日志</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E6%B7%BB%E5%8A%A0%E9%BB%91%E7%99%BD%E5%90%8D%E5%8D%95"><span class="toc-number">13.2.2.</span> <span class="toc-text">2、添加黑白名单</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E7%94%A8%E6%88%B7%E9%89%B4%E6%9D%83"><span class="toc-number">13.2.3.</span> <span class="toc-text">3、用户鉴权</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81%E5%88%A4%E8%AF%BB%E8%AF%B7%E6%B1%82%E7%9A%84%E6%8E%A5%E5%8F%A3%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8"><span class="toc-number">13.2.4.</span> <span class="toc-text">4、判读请求的接口是否存在</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5%E3%80%81%E8%AF%B7%E6%B1%82%E8%BD%AC%E5%8F%91-%E8%B0%83%E7%94%A8%E6%A8%A1%E6%8B%9F%E6%8E%A5%E5%8F%A3"><span class="toc-number">13.2.5.</span> <span class="toc-text">5、请求转发 调用模拟接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6%E3%80%81%E5%BC%82%E6%AD%A5%E8%BF%94%E5%9B%9E%E9%97%AE%E9%A2%98"><span class="toc-number">13.2.6.</span> <span class="toc-text">6、异步返回问题</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8D%81%E4%BA%8C%E3%80%81RPC"><span class="toc-number">14.</span> <span class="toc-text">十二、RPC</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81Dubbo%E6%A1%86%E6%9E%B6%EF%BC%88RPC%E5%AE%9E%E7%8E%B0%EF%BC%89"><span class="toc-number">14.1.</span> <span class="toc-text">1、Dubbo框架（RPC实现）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E4%B8%A4%E7%A7%8D%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F"><span class="toc-number">14.1.1.</span> <span class="toc-text">1、两种使用方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E5%BF%AB%E9%80%9F%E4%BD%BF%E7%94%A8-%EF%BC%88Spring-Boot%EF%BC%89"><span class="toc-number">14.1.2.</span> <span class="toc-text">2、快速使用 （Spring Boot）</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8D%81%E4%B8%89%E3%80%81%E9%A1%B9%E7%9B%AE%E6%95%B4%E5%90%88Dubbo%E3%80%81Nacos"><span class="toc-number">15.</span> <span class="toc-text">十三、项目整合Dubbo、Nacos</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E5%AE%89%E8%A3%85%E5%90%AF%E5%8A%A8Nacos"><span class="toc-number">15.1.</span> <span class="toc-text">1、安装启动Nacos</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E9%A1%B9%E7%9B%AE%E8%B7%91%E9%80%9A"><span class="toc-number">15.2.</span> <span class="toc-text">2、项目跑通</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81api-platform-backend"><span class="toc-number">15.2.1.</span> <span class="toc-text">1、api-platform-backend</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81api-platform-gateway"><span class="toc-number">15.2.2.</span> <span class="toc-text">2、api-platform-gateway</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81%E6%8A%BD%E8%B1%A1%E5%85%AC%E5%85%B1%E6%9C%8D%E5%8A%A1"><span class="toc-number">15.3.</span> <span class="toc-text">3、抽象公共服务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E6%8A%BD%E5%8F%96%E7%9A%84%E6%9C%8D%E5%8A%A1"><span class="toc-number">15.3.1.</span> <span class="toc-text">1、抽取的服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E5%85%B7%E4%BD%93%E6%93%8D%E4%BD%9C"><span class="toc-number">15.3.2.</span> <span class="toc-text">2、具体操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81impl%E5%85%B7%E4%BD%93%E5%AE%9E%E7%8E%B0"><span class="toc-number">15.3.3.</span> <span class="toc-text">3、impl具体实现</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4%E3%80%81%E4%BC%98%E5%8C%96%E7%BD%91%E5%85%B3Global-Filter"><span class="toc-number">15.4.</span> <span class="toc-text">4、优化网关Global Filter</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8D%81%E5%9B%9B%E3%80%81%E7%BB%9F%E8%AE%A1%E5%88%86%E6%9E%90"><span class="toc-number">16.</span> <span class="toc-text">十四、统计分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E5%90%8E%E7%AB%AF-1"><span class="toc-number">16.1.</span> <span class="toc-text">1、后端</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E7%BC%96%E5%86%99SQL"><span class="toc-number">16.1.1.</span> <span class="toc-text">1、编写SQL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E7%BC%96%E5%86%99%E6%8E%A5%E5%8F%A3"><span class="toc-number">16.1.2.</span> <span class="toc-text">2、编写接口</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E5%89%8D%E7%AB%AF-1"><span class="toc-number">16.2.</span> <span class="toc-text">2、前端</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8D%81%E4%BA%94%E3%80%81%E6%8B%93%E5%B1%95%E7%82%B9"><span class="toc-number">17.</span> <span class="toc-text">十五、拓展点</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/07/07/%E5%9C%A8%E7%BB%BF%E8%81%94%E4%B8%8A%E5%AE%89%E8%A3%85clouddrive2/" title="在绿联上安装clouddrive2">在绿联上安装clouddrive2</a><time datetime="2024-07-07T02:22:00.000Z" title="Created 2024-07-07 10:22:00">2024-07-07</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/07/07/%E4%BD%BF%E7%94%A8github%E5%92%8Ccloudflare%E5%AE%9E%E7%8E%B0%E8%87%AA%E5%BB%BAdocker%E5%8A%A0%E9%80%9F%E5%99%A8%EF%BC%8C%E8%A7%A3%E5%86%B3docker%E9%95%9C%E5%83%8F%E6%97%A0%E6%B3%95%E6%8B%89%E5%8F%96/" title="使用github和cloudflare实现自建docker加速器，解决docker镜像无法拉取的问题">使用github和cloudflare实现自建docker加速器，解决docker镜像无法拉取的问题</a><time datetime="2024-07-07T02:20:36.000Z" title="Created 2024-07-07 10:20:36">2024-07-07</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/07/07/docker-java%E4%BD%BF%E7%94%A8win%E7%B3%BB%E7%BB%9F%E4%B8%8Bdocker/" title="docker-java使用win系统下docker">docker-java使用win系统下docker</a><time datetime="2024-07-07T02:18:45.000Z" title="Created 2024-07-07 10:18:45">2024-07-07</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/07/07/api%E5%BC%80%E5%8F%91%E5%B9%B3%E5%8F%B0/" title="api开发平台">api开发平台</a><time datetime="2024-07-07T02:16:44.000Z" title="Created 2024-07-07 10:16:44">2024-07-07</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/07/07/python%E7%A8%8B%E5%BA%8F%E6%89%93%E5%8C%85%E4%B8%BAwin-linux%E5%8F%AF%E6%89%A7%E8%A1%8C%E6%96%87%E4%BB%B6/" title="python程序打包为win/linux可执行文件">python程序打包为win/linux可执行文件</a><time datetime="2024-07-07T01:47:49.000Z" title="Created 2024-07-07 09:47:49">2024-07-07</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By 阿库娅</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.13.0"></script><script src="/js/main.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>