<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>分类: 文档 | 编程小屋</title><meta name="author" content="阿库娅"><meta name="copyright" content="阿库娅"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="一、本地事务 本地事务是指事务的参与者、支持事务的服务器、资源服务器以及事务管理器位于同一节点相同数据库上。  1.ACID理论（强一致性）原子性(Atomicity)、一致性(Consistency )隔离性或独立性( Isolation)和持久性(Durabilily)，简称就是ACID;  原子性：一系列的操作整体不可拆分，要么同时成功，要么同时失败 一致性：数据在事务的前后，不能破坏数据的">
<meta property="og:type" content="article">
<meta property="og:title" content="本地事务&amp;分布式事务（Seata）">
<meta property="og:url" content="http://020327.xyz/2023/01/850adb54cef4.html">
<meta property="og:site_name" content="编程小屋">
<meta property="og:description" content="一、本地事务 本地事务是指事务的参与者、支持事务的服务器、资源服务器以及事务管理器位于同一节点相同数据库上。  1.ACID理论（强一致性）原子性(Atomicity)、一致性(Consistency )隔离性或独立性( Isolation)和持久性(Durabilily)，简称就是ACID;  原子性：一系列的操作整体不可拆分，要么同时成功，要么同时失败 一致性：数据在事务的前后，不能破坏数据的">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://common.ctcnb.cn/avatar.png">
<meta property="article:published_time" content="2023-01-13T05:06:51.000Z">
<meta property="article:modified_time" content="2024-07-07T09:11:04.648Z">
<meta property="article:author" content="阿库娅">
<meta property="article:tag" content="spring">
<meta property="article:tag" content="事务">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://common.ctcnb.cn/avatar.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://020327.xyz/2023/01/850adb54cef4.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '分类: 文档',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-07-07 17:11:04'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.1.1"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://common.ctcnb.cn/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">31</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">41</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">10</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog-info"><a href="/" title="编程小屋"><img class="site-icon" src="https://halo-ctc.upyun.ctcnb.cn/halo/cropped-logo.png"/><span class="site-name">编程小屋</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">本地事务&amp;分布式事务（Seata）</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-01-13T05:06:51.000Z" title="发表于 2023-01-13 13:06:51">2023-01-13</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-07-07T09:11:04.648Z" title="更新于 2024-07-07 17:11:04">2024-07-07</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%96%87%E6%A1%A3/">文档</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="本地事务&amp;分布式事务（Seata）"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="一、本地事务"><a href="#一、本地事务" class="headerlink" title="一、本地事务"></a>一、本地事务</h1><p><img src="https://halo-ctc.upyun.ctcnb.cn/gulimall-dev/1641087512768.png" alt="本地事务"></p>
<pre><code>本地事务是指事务的参与者、支持事务的服务器、资源服务器以及事务管理器位于同一节点相同数据库上。
</code></pre>
<h2 id="1-ACID理论（强一致性）"><a href="#1-ACID理论（强一致性）" class="headerlink" title="1.ACID理论（强一致性）"></a>1.ACID理论（强一致性）</h2><p><strong>原子性(Atomicity)、一致性(Consistency )隔离性或独立性( Isolation)和持久性(Durabilily)，简称就是ACID;</strong></p>
<ul>
<li>原子性：一系列的操作整体不可拆分，要么同时成功，要么同时失败</li>
<li>一致性：数据在事务的前后，不能破坏数据的完整性以及业务逻辑上的一致性。</li>
<li>隔离性：多个事务并发访问时，事务之间互相隔离。（脏读、不可重复读、幻读）</li>
<li>持久性：事务成功后，数据会保存在数据库并不再回滚</li>
</ul>
<h2 id="2-事务间的影响"><a href="#2-事务间的影响" class="headerlink" title="2.事务间的影响"></a>2.事务间的影响</h2><p>三者可能同时出现，都会导致同一事务中前后两次读取结果不一致</p>
<p>描述</p>
<p>脏读</p>
<p>在一个事务中读取了另一个事务未提交的脏数据（前后两次结果读取不一致）</p>
<p>不可重复读</p>
<p>在一个事务中读取了另一个事务dml操作并提交的数据（前后两次结果读取不一致）</p>
<p>幻读</p>
<p>在一个事务中读取了另一个事务ddl操作并提交的数据（前后两次结果读取不一致）</p>
<h2 id="3-解决方法"><a href="#3-解决方法" class="headerlink" title="3.解决方法"></a>3.解决方法</h2><p><strong>开启事务，设置事务隔离级别</strong></p>
<p>在数据库管理系统（DBMS）中，默认情况下一条SQL就是一个单独事务，事务是自动提交的。 只有显式的使用start transaction开启一个事务，才能将一个代码块放在事务中执行。 保障事务的原子性是数据库管理系统的责任，为此许多数据源采用日志机制。 例如，SQL Server使用一个预写事务日志，在将数据提交到实际数据页面前，先写在事务日志上。</p>
<h2 id="4-事务隔离级别"><a href="#4-事务隔离级别" class="headerlink" title="4.事务隔离级别"></a>4.事务隔离级别</h2><p><strong>概述：</strong> 事务之间会存在互相影响的情况，事务隔离级别不同影响的范围也不同</p>
<p>谁实现的？ 由数据库实现 在JAVA中只是设定事务隔离级别，而不是实现它</p>
<table>
<thead>
<tr>
<th></th>
<th>脏读</th>
<th>不可重复读</th>
<th>幻读</th>
<th>默认级别</th>
<th>实现方法</th>
</tr>
</thead>
<tbody><tr>
<td>Read uncommitted</td>
<td>√</td>
<td>√</td>
<td>√</td>
<td></td>
<td></td>
</tr>
<tr>
<td>Read committed</td>
<td>×</td>
<td>√</td>
<td>√</td>
<td>SQLServer&#x2F;Oracle</td>
<td></td>
</tr>
<tr>
<td>Repeatable read</td>
<td>×</td>
<td>×</td>
<td>√</td>
<td>Mysql</td>
<td>行锁</td>
</tr>
<tr>
<td>Serializable</td>
<td>×</td>
<td>×</td>
<td>×</td>
<td></td>
<td>表锁</td>
</tr>
</tbody></table>
<h3 id="4-1-Spring设置事务隔离级别"><a href="#4-1-Spring设置事务隔离级别" class="headerlink" title="4.1.Spring设置事务隔离级别"></a>4.1.Spring设置事务隔离级别</h3><p>@Transactional(isolation&#x3D;Isolation.REPEATABLE_READ)</p>
<ul>
<li><strong>DEFAULT</strong> (默认)</li>
<li><strong>READ_UNCOMMITTED</strong> (读未提交)该隔离级别的事务会读到其它未提交事务的数据，此现象也称之为脏读。</li>
<li><strong>READ_COMMITTED</strong> (读已提交)一个事务可以读取另一个已提交的事务，多次读取会造成不一样的结果，此现象称为不可重复读问题，Oracle 和 SQL Server 的默认隔离级别。</li>
<li><strong>REPEATABLE_READ</strong> (可重复读)该隔离级别是 MySQL 默认的隔离级别，在同一个事务里，select 的结果是事务开始时时间点的状态，因此，同样的 select 操作读到的结果会是一致的，但是，会有幻读现象。MySQL的 InnoDB 引擎可以通过 next-key locks 机制来避免幻读。</li>
<li><strong>SERIALIZABLE</strong> (串行化)在该隔离级别下事务都是串行顺序执行的，MySQL 数据库的 InnoDB 引擎会给读操作隐式加一把读共享锁，从而避免了脏读、不可重读复读和幻读问题</li>
</ul>
<h2 id="5-Spring的传播行为"><a href="#5-Spring的传播行为" class="headerlink" title="5.Spring的传播行为"></a>5.Spring的传播行为</h2><ul>
<li><strong>PROPAGATION_REQUIRED</strong>：（要求一个事务）当前没有事务，创建事务；如果存在事务，就加入该事务<strong>【常用】</strong></li>
<li><strong>PROPAGATION_SUPPORTS</strong>：（支持当前事务）当前存在事务，就加入该事务；如果当不存在事务，以非事务执行</li>
<li><strong>PROPAGATION_MANDATORY</strong>：（强制使用当前事务）当前存在事务，就加入该事务；如果不存在事务，抛出异常</li>
<li><strong>PROPAGATION_REQUIRES_NEW</strong>：（要求一个新事务）创建新事务执行</li>
<li><strong>PROPAGATION_NOT_SUPPORTED</strong>：（不使用事务）以非事务方式执行，如果存在事务，就把当前事务挂起</li>
<li><strong>PROPAGATION_NEVER</strong>：（强制不使用事务）如果当前存在事务，则抛出异常</li>
<li><strong>PROPAGATION_NESTED</strong>：（嵌套事务）如果存在事务，则在嵌套事务内执行；如果没有事务，创建事务</li>
</ul>
<h3 id="5-1-案例"><a href="#5-1-案例" class="headerlink" title="5.1.案例"></a>5.1.案例</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional(timeout=30)</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">a</span><span class="params">()</span> &#123;  </span><br><span class="line">    b();<span class="comment">// a事务传播给了b事务，并且b事务的设置失效  </span></span><br><span class="line">    c();<span class="comment">// c单独创建一个新事务  </span></span><br><span class="line">&#125;  </span><br><span class="line">​  </span><br><span class="line"><span class="meta">@Transactional(propagation = Propagation.REQUIRED, timeout=2)</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">b</span><span class="params">()</span> &#123;  </span><br><span class="line">​  </span><br><span class="line">&#125;  </span><br><span class="line">​  </span><br><span class="line"><span class="meta">@Transactional(propagation = Propagation.REQUIRES\_NEW)</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">c</span><span class="params">()</span> &#123;  </span><br><span class="line">​  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="5-2-本地事务失效问题"><a href="#5-2-本地事务失效问题" class="headerlink" title="5.2.本地事务失效问题"></a>5.2.本地事务失效问题</h3><h4 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 事务方法调用本方法内的其他事务方法，出现本地事务失效的问题  </span></span><br><span class="line"><span class="meta">@Transactional(timeout=30)</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">a</span><span class="params">()</span> &#123;  </span><br><span class="line">    b();<span class="comment">// 绕过了代理对象，异常不会回滚  </span></span><br><span class="line">    c();<span class="comment">// 绕过了代理对象，异常不会回滚  </span></span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"><span class="meta">@Transactional(propagation = Propagation.REQUIRED, timeout=2)</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">b</span><span class="params">()</span> &#123;  </span><br><span class="line"></span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="meta">@Transactional(propagation = Propagation.REQUIRES\_NEW)</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">c</span><span class="params">()</span> &#123;  </span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h4><p>Spring事务的原理是使用了代理对象，如果两个事务方法在同一个Service类内，事务A方法直接调用事务B方法，即绕过了代理对象，事务未生效</p>
<h4 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h4><p>使用代理对象来调用事务方法，不能使用this.b()，也不能注入自己</p>
<h4 id="具体步骤："><a href="#具体步骤：" class="headerlink" title="具体步骤："></a><strong>具体步骤：</strong></h4><ol>
<li>引入aop依赖</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 引入aop，解决本地事务失效问题 --&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-aop<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li><p>在启动类添加注解，开启动态代理 &#x2F;&#x2F; 加该注解后使用aspectj作动态代理【即使没有接口也能代理，使用cglib继承的方式完成动态代理】  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// exposeProxy = true 对外暴露代理对象  </span></span><br><span class="line"><span class="meta">@EnableAspectJAutoProxy(exposeProxy = true)</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>本类互相调用使用代理对象 获取当前类的代理对象</p>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">OrderServiceImpl</span> <span class="variable">orderService</span> <span class="operator">=</span> (OrderServiceImpl)AopContext.currentProxy();  </span><br><span class="line">orderService.b();  </span><br><span class="line">orderService.c();</span><br></pre></td></tr></table></figure>



<h1 id="二、CAP定理和BASE理论"><a href="#二、CAP定理和BASE理论" class="headerlink" title="二、CAP定理和BASE理论"></a>二、CAP定理和BASE理论</h1><h2 id="1-CAP定理"><a href="#1-CAP定理" class="headerlink" title="1.CAP定理"></a>1.CAP定理</h2><h3 id="1-1-概述"><a href="#1-1-概述" class="headerlink" title="1.1.概述"></a>1.1.概述</h3><p>CAP定理，指的是在一个分布式系统中：</p>
<ul>
<li>一致性（Consistency）： 在分布式系统中的所有数据备份，在同一时刻是一致的。（3个数据库，同一份数据值一致）</li>
<li>可用性（Availability）： 在集群中一部分节点故障后，集群整体仍能响应客户端的请求。（同一时刻数据可允许出现不一致）</li>
<li>分区容错性（Partition tolerance）： 分布式系统之间允许通信失败。（分布式网络必须保证分区容错性，因为网络通信一定会出现问题） 大多数分布式系统都分布在多个子网络。每个子网络就叫做一个区(partition） 分区容错的意思是，区间通信可能失败。比如，一台服务器放在中国，另一台服务器放在美国，这就是两个区，它们之间可能无法通信。</li>
</ul>
<p><strong>CAP原则指的是</strong>，这三个要素最多只能同时实现两点，不可能三者兼蹊。</p>
<ul>
<li>CA：互斥</li>
<li>AP：可用性+分区容错性，允许出现子网络通信失败，并保证可用性（出现数据未同步，不能保证一致性）</li>
<li>CP：一致性+分区容错性，允许出现子网络通信失败，并保证数据一致性（网络通信故障的节点无法继续提供服务，牺牲可用性）</li>
</ul>
<h3 id="1-2-实现一致性的算法"><a href="#1-2-实现一致性的算法" class="headerlink" title="1.2.实现一致性的算法"></a>1.2.实现一致性的算法</h3><blockquote>
<p>raft、paxos</p>
</blockquote>
<p><strong>raft算法演示：</strong></p>
<ul>
<li><a target="_blank" rel="noopener" href="http://thesecretlivesofdata.com/raft/">Raft (thesecretlivesofdata.com)</a></li>
<li><a target="_blank" rel="noopener" href="https://raft.github.io/">Raft Consensus Algorithm</a></li>
</ul>
<h3 id="1-3-raft算法（CP）"><a href="#1-3-raft算法（CP）" class="headerlink" title="1.3.raft算法（CP）"></a>1.3.raft算法（CP）</h3><h4 id="1-3-1-概述"><a href="#1-3-1-概述" class="headerlink" title="1.3.1.概述"></a>1.3.1.概述</h4><p>1.raft算法通过领导选举、日志复制实现一致性+分区容错性<br>2.无法实现可用性，例如出现两个分区的时候，出现了两个领导并且两个分区节点数相等时，两个分区都无法工作（无法选出领导，因为无法获得大多数选举人的投票）</p>
<h5 id="三种状态"><a href="#三种状态" class="headerlink" title="三种状态"></a>三种状态</h5><p>Follower：随从（集群所有节点启动默认都是随从状态）<br>Candidate：候选者（没有在集群中监听到领导者，变成候选者）<br>Leader：领导者（得票多者被选举为领导者，所有的修改都必须经过领导）</p>
<p><img src="https://halo-ctc.upyun.ctcnb.cn/gulimall-dev/1641041444190.png" alt="1641041444190"></p>
<p><img src="https://halo-ctc.upyun.ctcnb.cn/gulimall-dev/1641041444190.png" alt="1641041444190"></p>
<p><img src="https://halo-ctc.upyun.ctcnb.cn/gulimall-dev/1641041521050.png" alt="1641041521050"></p>
<h5 id="三个超时时间"><a href="#三个超时时间" class="headerlink" title="三个超时时间"></a>三个超时时间</h5><p>election timeout：选举超时（随从者成为候选者的自旋时间）<br>150ms~300ms之间</p>
<p>heartbeat timeout：心跳超时（领导者发送心跳给跟踪者的间隔时间）</p>
<p>最小选举超时：<br>如果集群中存在Leader时，并且接收到心跳信息之后在最小选举超时时间内接受到请求投票消息，那么将会忽略掉该投票消息。<br>在分布式系统中，有时候需要对集群中的成员数量进行更新的操作。对于被删除的服务器而言，如果它们没有及时关闭，那么它们将不会接收到心跳信息和日志信息，从而不断发生超时，最后导致任期不断增加（高于集群中所有成员的任期），然后不断向集群中发送请求投票消息。集群中的Leader将变为Follower，集群中将不断开始新的选举，从而扰乱集群的正常运行。</p>
<h4 id="1-3-2-领导选举"><a href="#1-3-2-领导选举" class="headerlink" title="1.3.2.领导选举"></a>1.3.2.领导选举</h4><p>选举步骤：<br>1.集群启动各节点进入随从态，若未监听到领导者，各自进行选举倒计时，倒计时结束成为候选者，并发起第一轮选举，向其他节点发起投票请求（自己会给自己投一票）<br>2.其他节点如果当前未投过票，就会投票给自己（可能投给了其他候选者）<br>3.随从节点投票完后立即进入下一选举时间（重置选举时间进入自旋态）<br>4.领导会发送追加日志消息给随从节点，并且不断给随从节点发送心跳<br>5.随从者接收心跳后重新进入下一轮选举自旋<br>6.领导者宕机后，随从者选举超时成为候选者进入第二轮选举，并向其他节点发起投票请求<br>7.随从节点投票后也进入第二轮选举</p>
<p>注意：<br>1.领导者也会回复投票请求<br>2.领导者接收到其他领导者的心跳检测后会让出领导者<br>3.同一轮投票时，每个节点只能给一个候选节点投票</p>
<p><strong>选举超时的随从者成为候选者：</strong> <img src="https://halo-ctc.upyun.ctcnb.cn/gulimall-dev/1641044837441.png" alt="1641044837441"></p>
<hr>
<hr>
<hr>
<p><strong>发起第一轮选举，向其他节点发起投票请求：</strong> <img src="https://halo-ctc.upyun.ctcnb.cn/gulimall-dev/1641045036623.png" alt="1641045036623"></p>
<hr>
<hr>
<hr>
<p><strong>其他节点如果当前未投过票，就会投票给自己：</strong> <img src="https://halo-ctc.upyun.ctcnb.cn/gulimall-dev/1641045149730.png" alt="1641045149730"></p>
<hr>
<hr>
<hr>
<p><strong>随从节点投票完后立即进入下一选举时间：</strong> <img src="https://halo-ctc.upyun.ctcnb.cn/gulimall-dev/1641045233540.png" alt="1641045233540"></p>
<hr>
<hr>
<hr>
<p><strong>候选节点获得大多数投票后成为领导者：</strong> <img src="https://halo-ctc.upyun.ctcnb.cn/gulimall-dev/1641045362833.png" alt="1641045362833"></p>
<hr>
<hr>
<hr>
<p><strong>领导会发送追加日志消息给随从节点：</strong> <img src="https://halo-ctc.upyun.ctcnb.cn/gulimall-dev/1641045516542.png" alt="1641045516542"></p>
<hr>
<hr>
<hr>
<p><strong>领导者发送心跳消息：</strong> <img src="https://halo-ctc.upyun.ctcnb.cn/gulimall-dev/1641045785706.png" alt="1641045785706"></p>
<hr>
<hr>
<hr>
<p><strong>随从者接收心跳后重新进入下一轮选举自旋：</strong> <img src="https://halo-ctc.upyun.ctcnb.cn/gulimall-dev/1641046362988.png" alt="1641046362988"></p>
<hr>
<hr>
<hr>
<p><strong>第二轮选举结束，A成为新领导：</strong> <img src="https://halo-ctc.upyun.ctcnb.cn/gulimall-dev/1641046726571.png" alt="1641046726571"></p>
<h5 id="投票分离"><a href="#投票分离" class="headerlink" title="投票分离"></a>投票分离</h5><p>当出现两个候选者的时候，会出现投票分离，结果会一直自旋抢票，直到产生一个领导者</p>
<p>C成为领导者的同时，B也成为了候选者并发出了投票请求</p>
<p><strong>两个候选者：</strong></p>
<p><img src="https://halo-ctc.upyun.ctcnb.cn/gulimall-dev/1641046899572.png" alt="1641046899572"></p>
<p><strong>D投给C，B投给A：</strong></p>
<p><img src="https://halo-ctc.upyun.ctcnb.cn/gulimall-dev/1641046939048.png" alt="1641046939048"></p>
<p><strong>重新自旋，可能所有节点成为候选者：</strong></p>
<p><img src="https://halo-ctc.upyun.ctcnb.cn/gulimall-dev/1641047099347.png" alt="1641047099347"></p>
<p><strong>C成为领导者的同时，B也成为了候选者并发出了投票请求：</strong></p>
<p><img src="https://halo-ctc.upyun.ctcnb.cn/gulimall-dev/1641047376096.png" alt="1641047376096"></p>
<h4 id="1-3-3-日志复制"><a href="#1-3-3-日志复制" class="headerlink" title="1.3.3.日志复制"></a>1.3.3.日志复制</h4><p>日志复制：<br>指集群使用raft算法，以日志复制的方式实现一致性</p>
<p>步骤：<br>1.所有修改数据都必须经过领导者<br>2.领导者创建节点日志，此时日志是未提交状态，且数据未修改<br>3.日志不会马上发出，会伴随心跳发送给每一个节点，节点收到心跳后回复<br>4.当大多数节点回复后领导者提交，数据更新<br>5.领导者更新成功响应客户端更新成功，并在下一次心跳通知其他节点也提交更新<br>7.所有节点修改成功后，集群实现一致性</p>
<p>注意：<br>1.修改数据的请求到达leader后创建日志，但是日志发出是随下一次心跳发出的<br>2.领导者提交后就会响应客户端修改成功，并在下一个心跳时间告诉其他节点提交<br>3.如果领导者没有接收到大多数节点的回复，日志不会提交</p>
<p><strong>所有修改数据都必须经过领导者：</strong> <img src="https://halo-ctc.upyun.ctcnb.cn/gulimall-dev/1641042143343.png" alt="1641042143343"></p>
<hr>
<hr>
<hr>
<p><strong>每一个修改操作都会被添加为节点日志：</strong> </p>
<p><img src="https://halo-ctc.upyun.ctcnb.cn/gulimall-dev/1641042215255.png" alt="img"></p>
<hr>
<hr>
<hr>
<p><strong>此时日志是未提交状态，领导者还未修改数据：</strong> <img src="https://halo-ctc.upyun.ctcnb.cn/gulimall-dev/1641042274289.png" alt="1641042274289"></p>
<hr>
<hr>
<hr>
<p><strong>领导者将日志复制发送给每一个随从节点：</strong> <img src="https://halo-ctc.upyun.ctcnb.cn/gulimall-dev/1641042378425.png" alt="1641042378425"></p>
<hr>
<hr>
<hr>
<p><strong>大多数节点收到日志并告知领导者：</strong> <img src="https://halo-ctc.upyun.ctcnb.cn/gulimall-dev/1641042434106.png" alt="1641042434106"></p>
<hr>
<hr>
<hr>
<p><strong>领导节点提交，数据更新：</strong> <img src="https://halo-ctc.upyun.ctcnb.cn/gulimall-dev/1641042902677.png" alt="1641042902677"></p>
<hr>
<hr>
<hr>
<p><strong>领导者更新成功后通知其他节点也提交更新：</strong> <img src="https://halo-ctc.upyun.ctcnb.cn/gulimall-dev/1641042955261.png" alt="1641042955261"></p>
<hr>
<hr>
<hr>
<p><strong>所有节点修改成功后，集群实现一致性：</strong> <img src="https://halo-ctc.upyun.ctcnb.cn/gulimall-dev/1641043118477.png" alt="1641043118477"></p>
<h4 id="1-3-4-网络分区一致性"><a href="#1-3-4-网络分区一致性" class="headerlink" title="1.3.4.网络分区一致性"></a>1.3.4.网络分区一致性</h4><p>1.网络出现分区时，原先领导延任，其他区重新选取领导<br>2.如果领导没有接收到大多数节点的回应，不会提交日志（只有领导E的提交成功）<br>3.恢复网络通信后，低轮次领导者会退位，并且A和B将未提交的数据全部回滚，并且同步新领导的数据</p>
<p><img src="https://halo-ctc.upyun.ctcnb.cn/gulimall-dev/1641048233770.png" alt="1641048233770"> <strong>各分区出现各自的领导：</strong> <img src="https://halo-ctc.upyun.ctcnb.cn/gulimall-dev/1641048286677.png" alt="1641048286677"> <strong>如果领导没有接收到大多数节点的回应，不会提交日志：</strong> <img src="https://halo-ctc.upyun.ctcnb.cn/gulimall-dev/1641048434260.png" alt="1641048434260"> <img src="https://halo-ctc.upyun.ctcnb.cn/gulimall-dev/1641048498630.png" alt="1641048498630"> <strong>B退位，并且A和B回滚未提交的数据，并同步新领导的数据：</strong> <img src="https://halo-ctc.upyun.ctcnb.cn/gulimall-dev/1641049003625.png" alt="1641049003625"></p>
<h3 id="1-4-paxos算法"><a href="#1-4-paxos算法" class="headerlink" title="1.4.paxos算法"></a>1.4.paxos算法</h3><h3 id="1-5-集群面临的问题（AP）"><a href="#1-5-集群面临的问题（AP）" class="headerlink" title="1.5.集群面临的问题（AP）"></a>1.5.集群面临的问题（AP）</h3><p>对于多数大型互联网应用的场景，主机众多、部署分散，而且现在的集群规模越来越大，所以节点故障、网络故障是常态，而且要保证服务可用性达到 99.99999%（N 个 9），即保证P 和 A，舍弃 C。</p>
<h2 id="2-BASE理论（最终一致性）"><a href="#2-BASE理论（最终一致性）" class="headerlink" title="2.BASE理论（最终一致性）"></a>2.BASE理论（最终一致性）</h2><h3 id="2-1-案例"><a href="#2-1-案例" class="headerlink" title="2.1.案例"></a>2.1.案例</h3><blockquote>
<p>创建订单 1）远程锁定库存 2）创建订单 3）扣减积分 当扣减积分异常时，订单可以回滚，但是库存已经锁定无法回滚，所以在最后将锁定的库存释放，达到最终一致性。</p>
</blockquote>
<h3 id="2-2-概述"><a href="#2-2-概述" class="headerlink" title="2.2.概述"></a>2.2.概述</h3><blockquote>
<p>是对CAP理论的延伸，思想是即使无法做到强一致性（CAP的一致性就是强一致性），但可以采用适当的采取弱一致性，即最终一致性。【保证AP时，无法保证C，但是可以最终一致性】</p>
</blockquote>
<p>BASE是指</p>
<ul>
<li>基本可用（Basically Available）<ul>
<li>基本可用是指分布式系统在出现故障的时候，允许损失部分可用性(例如响应时间、功能上的可用性），允许损失部分可用性。需要注意的是，基本可用绝不等价于系统不可用。<ul>
<li>响应时间上的损失：正常情况下搜索引擎需要在0.5秒之内返回给用户相应的查询结果，但由于出现故障（比如系统部分机房发生断电或断网故障），查询结果的响应时间增加到了1~2秒。</li>
<li>功能上的损失：购物网站在购物高峰(如双十一)时，为了保护系统的稳定性，部分消费者可能会被引导到一个降级页面。</li>
</ul>
</li>
</ul>
</li>
<li>软状态（Soft State)<ul>
<li>软状态是指允许系统存在中间状态，中间状态不会影响系统整体可用性。分布式存储中一般一份数据会有多个副本，允许不同副本同步的延时就是软状态的体现。mysal replication的异步复制也是一种体现。通俗解释就是一致性只有两个状态，成功、失败，软状态是二者之间的状态</li>
</ul>
</li>
<li>最终一致性（Eventual Consistency)<ul>
<li>最终一致性是指系统中的所有数据副本经过一定时间后，最终能够达到一致的状态。弱一致性和强一致性相反，最终一致性是弱一致性的一种特殊情况。</li>
</ul>
</li>
</ul>
<h3 id="2-3-强一致性、弱一致性、最终一致性"><a href="#2-3-强一致性、弱一致性、最终一致性" class="headerlink" title="2.3.强一致性、弱一致性、最终一致性"></a>2.3.强一致性、弱一致性、最终一致性</h3><blockquote>
<p>强一致性：更新后的数据后续访问能看到（数据强一致，及时更新到所有节点） 弱一致性：容忍部分或全部访问不到（数据不一致，数据未及时同步到所有节点）【软状态，存在不一致的数据】 最终一致性：弱一致性经过一段时间后更新到最新数据【订单创建失败，经过一段时间后释放库存】</p>
</blockquote>
<h1 id="三、分布式事务"><a href="#三、分布式事务" class="headerlink" title="三、分布式事务"></a>三、分布式事务</h1><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/142136446">分布式事务：2PC、3PC、SAGA、TCC</a></p>
<p><img src="https://halo-ctc.upyun.ctcnb.cn/gulimall-dev/1641088033241.png" alt="1641088033241"></p>
<h2 id="1-分布式事务概述"><a href="#1-分布式事务概述" class="headerlink" title="1.分布式事务概述"></a>1.分布式事务概述</h2><blockquote>
<p>分布式事务是指事务的参与者、支持事务的服务器、资源服务器以及事务管理器分别位于不同的分布式系统的不同节点之上。 分布式事务的方案其实就是根据不同一致性设计的几种不同方案</p>
</blockquote>
<p><img src="https://halo-ctc.upyun.ctcnb.cn/gulimall-dev/1640911301435.png" alt="1640911301435"></p>
<p><img src="https://halo-ctc.upyun.ctcnb.cn/gulimall-dev/1641035986389.png" alt="1641035986389"></p>
<h3 id="分布式系统出现的异常"><a href="#分布式系统出现的异常" class="headerlink" title="分布式系统出现的异常"></a>分布式系统出现的异常</h3><blockquote>
<p>异常： 机器宕机、网络异常、消息丢失、消息乱序、数据错误、不可靠的TCP、存储数据丢失</p>
<p>案例： 1.远程服务假失败： 远程服务其实成功了，由于网络故障没有返回 导致：订单回滚，库存成功扣减</p>
<p>2.远程服务执行完成，用户服务扣减积分异常 导致：订单回滚，库存成功扣减</p>
</blockquote>
<h2 id="2-刚性事务XA（ACID）"><a href="#2-刚性事务XA（ACID）" class="headerlink" title="2.刚性事务XA（ACID）"></a>2.刚性事务XA（ACID）</h2><blockquote>
<p>刚性事务遵循ACID理论，强一致性，基于AT模式（Auto Transaction），根据日志自动提交回滚</p>
<p>XA协议是一个基于数据库的分布式事务协议，其分为两部分： 事务管理器、本地资源管理器。</p>
<p>事务管理器：作为一个全局的调度者，负责对各个本地资源管理器统一号令提交或者回滚。二阶提交协议（2PC）和三阶提交协议（3PC）就是根据此协议衍生出来而来。如今Oracle、Mysql等数据库均已实现了XA接口。</p>
</blockquote>
<p><img src="https://halo-ctc.upyun.ctcnb.cn/gulimall-dev/1641055275130.png" alt="1641055275130"></p>
<h3 id="2-1-2PC协议"><a href="#2-1-2PC协议" class="headerlink" title="2.1.2PC协议"></a>2.1.2PC协议</h3><blockquote>
<p>两个阶段： 第一阶段提交： 协调者收到客户端请求，协调者给每一个参与者发送prepare指令，参与者接收指令执行本地数据但不提交事务，并返回ready</p>
<p>第二阶段提交： 1）当第一阶段所有参与者返回接收prepare指令并返回ready时，协调者发送commit指令给参与者，所有参与者提交事务 2）当第一阶段返回超时或者参与者执行失败，协调者在第二阶段告诉所有参与者回滚</p>
</blockquote>
<p><img src="https://halo-ctc.upyun.ctcnb.cn/gulimall-dev/1641092168221.png" alt="1641092168221"></p>
<h4 id="案例-1"><a href="#案例-1" class="headerlink" title="案例"></a>案例</h4><blockquote>
<p>一个下单流程会用到多个服务，各个服务都无法保证调用的其他服务的成功与否，这个时候就需要一个全局的角色（协调者）对各个服务（参与者）进行协调。</p>
<p>一个下单请求过来通过协调者，给每一个参与者发送Prepare消息，执行本地数据脚本但不提交事务。 如果协调者收到了参与者的失败消息或者超时，直接给每个参与者发送回滚(Rollback)消息；否则，发送提交(Commit)消息；参与者根据协调者的指令执行提交或者回滚操作，释放所有事务处理过程中被占用的资源，显然2PC做到了所有操作要么全部成功、要么全部失败。</p>
</blockquote>
<p><img src="https://halo-ctc.upyun.ctcnb.cn/gulimall-dev/1641092111746.png" alt="1641092111746"></p>
<h4 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h4><p>二阶段提交看似能够提供原子性的操作，但它存在着严重的缺陷</p>
<ul>
<li><strong>网络抖动导致的数据不一致：</strong> 第二阶段中<code>协调者</code>向<code>参与者</code>发送<code>commit</code>命令之后，一旦此时发生网络抖动，导致一部分<code>参与者</code>接收到了<code>commit</code>请求并执行，可其他未接到<code>commit</code>请求的<code>参与者</code>无法执行事务提交。进而导致整个分布式系统出现了数据不一致。</li>
<li><strong>超时导致的同步阻塞问题：</strong> <code>2PC</code>中的所有的参与者节点都为<code>事务阻塞型</code>，当某一个<code>参与者</code>节点出现通信超时，其余<code>参与者</code>都会被动阻塞占用资源不能释放。</li>
<li><strong>单点故障的风险：</strong> 由于严重的依赖<code>协调者</code>，一旦<code>协调者</code>发生故障，而此时<code>参与者</code>还都处于锁定资源的状态，无法完成事务<code>commit</code>操作。虽然协调者出现故障后，会重新选举一个协调者，可无法解决因前一个<code>协调者</code>宕机导致的<code>参与者</code>处于阻塞状态的问题。</li>
</ul>
<h3 id="2-2-3PC协议"><a href="#2-2-3PC协议" class="headerlink" title="2.2.3PC协议"></a>2.2.3PC协议</h3><blockquote>
<p>三个阶段：</p>
<ul>
<li>CanCommit： 协调者向所有参与者发送CanCommit命令，询问是否可以执行事务提交操作。如果全部响应YES则进入下一个阶段。</li>
<li>PreCommit： 协调者向所有参与者发送PreCommit命令，询问是否可以进行事务的预提交操作，参与者接收到PreCommit请求后，如参与者成功的执行了事务操作，则返回Yes响应，进入最终commit阶段。一旦参与者中有向协调者发送了No响应，或因网络造成超时，协调者没有接到参与者的响应，协调者向所有参与者发送abort请求，参与者接受abort命令执行事务的中断。</li>
<li>DoCommit： 在前两个阶段中所有参与者的响应反馈均是YES后，协调者向参与者发送DoCommit命令正式提交事务，如协调者没有接收到参与者发送的ACK响应，会向所有参与者发送abort请求命令，执行事务的中断。</li>
</ul>
</blockquote>
<p><img src="https://halo-ctc.upyun.ctcnb.cn/gulimall-dev/1641092644487.png" alt="1641092644487"></p>
<h4 id="缺点-1"><a href="#缺点-1" class="headerlink" title="缺点"></a>缺点</h4><blockquote>
<p>三段提交（3PC）是对两段提交（2PC）的一种升级优化，3PC在2PC的第一阶段和第二阶段中插入一个准备阶段。保证了在最后提交阶段之前，各参与者节点的状态都一致。同时在协调者和参与者中都引入超时机制，当参与者各种原因未收到协调者的commit请求后，会对本地事务进行commit，不会一直阻塞等待，解决了2PC的单点故障问题，但3PC还是没能从根本上解决数据一致性的问题。 主要原因：网络中断，自动提交</p>
</blockquote>
<h2 id="3-柔性事务（BASE）"><a href="#3-柔性事务（BASE）" class="headerlink" title="3.柔性事务（BASE）"></a>3.柔性事务（BASE）</h2><blockquote>
<p>柔性事务是基于BASE理论，最终一致性</p>
</blockquote>
<h3 id="3-1-TCC模式"><a href="#3-1-TCC模式" class="headerlink" title="3.1.TCC模式"></a>3.1.TCC模式</h3><blockquote>
<p>TCC与XA协议不同，不是数据库原生实现</p>
</blockquote>
<h4 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h4><p>TCC（Try-Confirm-Cancel）分布式事务模型通过对业务逻辑进行分解来实现分布式事务。顾名思义，TCC事务模型需要业务系统提供以下三种业务逻辑。</p>
<ul>
<li>Try：完成业务检查，预留业务所需的资源。Try操作是整个TCC的精髓，可以灵活选择业务资源锁的粒度。</li>
<li>Confirm：执行业务逻辑，直接使用Try阶段预留的业务资源，无须再次进行业务检查。</li>
<li>Cancel：释放Try阶段预留的业务资源。</li>
</ul>
<blockquote>
<p>TCC模型仅提供两阶段原子提交协议，保证分布式事务的原子性。事务的隔离交给业务逻辑来实现。TCC 模型的隔离性思想是，通过对业务的改造将对数据库资源层面加锁上移至对业务层面加锁，从而释放底层数据库锁资源，拓宽分布式事务锁协议，提高系统的并发性。</p>
</blockquote>
<h4 id="案例-2"><a href="#案例-2" class="headerlink" title="案例"></a>案例</h4><blockquote>
<p>以A账户向B账户汇款100元为例。汇款服务和收款服务需要分别实现Try、Confirm、Cancel这三个接口，并在业务初始化阶段将这三个接口的实现注入TCC事务管理器。</p>
</blockquote>
<ul>
<li>汇款服务</li>
</ul>
<p>— Try：检查A账户的有效性；检查A账户的余额是否充足；从A账户中扣减100元，并将状态置为“转账中”；预留扣减资源，将“从A账户向B账户转账100元”这个事件存入消息或日志。</p>
<p>— Confirm：不做任何操作。</p>
<p>— Cancel：A账户增加100元；从日志或消息中释放扣减资源。</p>
<ul>
<li>收款服务</li>
</ul>
<p>— Try：检查B账户的有效性。</p>
<p>— Confirm：读取日志或者消息，B账户增加100元；从日志或消息中释放扣减资源。</p>
<p>— Cancel：不做任何操作。</p>
<p>由此可以看出，TCC模型对业务的侵入性较强，改造的难度较大。</p>
<p><img src="https://halo-ctc.upyun.ctcnb.cn/gulimall-dev/v2-9611f594bb5b3fd578c2f1f9165509cb_720w.jpg" alt="img"></p>
<h4 id="缺点-2"><a href="#缺点-2" class="headerlink" title="缺点"></a>缺点</h4><p>虽然在柔性事务中，TCC事务模型的功能最强，但需要应用方负责提供实现Try、Confirm和Cancel操作的三个接口，供事务管理器调用，因此业务方改造的成本较高。</p>
<h3 id="3-2-最大努力通知型"><a href="#3-2-最大努力通知型" class="headerlink" title="3.2.最大努力通知型"></a>3.2.最大努力通知型</h3><p>按规律进行通知，不保证数据一定能通知成功，但会提供可查询操作接口进行核对。这种方案主要用在与第三方系统通讯时，比如：调用微信或支付宝支付后的支付结果通知。这种方案也是结合MQ进行实现，例如:通过MQ发送http请求，设置最大通知次数。达到通知次数后即不再通知。<br>案例：银行通知、商户通知等（各大交易业务平台间的商户通知：多次通知、查询校对、对账文件），支付宝的支付成功异步回调</p>
<h3 id="3-3-可靠消息-最终一致性"><a href="#3-3-可靠消息-最终一致性" class="headerlink" title="3.3. 可靠消息+最终一致性"></a>3.3. 可靠消息+最终一致性</h3><h4 id="概述-1"><a href="#概述-1" class="headerlink" title="概述"></a>概述</h4><p>消息一致性方案是通过消息中间件保证上下游应用数据操作一致性的。基本思路是，将本地操作和发送消息放在同一个本地事务中，下游应用从消息系统订阅该消息，收到消息后执行相应的操作，本质上是依靠消息的重试机制达到最终一致性的。</p>
<p><img src="https://halo-ctc.upyun.ctcnb.cn/gulimall-dev/v2-879faa49fca36c2e65ea6622483f56cc_720w.jpg" alt="img"></p>
<h4 id="缺点-3"><a href="#缺点-3" class="headerlink" title="缺点"></a>缺点</h4><p>消息驱动的缺点是，耦合度高，需要在业务系统中引入消息中间件，将导致系统复杂度增加。</p>
<p>基于ACID的强一致性事务和基于BASE的最终一致性事务都不是“银弹”，只有在最适合的场景中才能发挥它们的最大长处。</p>
<h3 id="3-4-Sega"><a href="#3-4-Sega" class="headerlink" title="3.4.Sega"></a>3.4.Sega</h3><h2 id="4-AT、TCC、XA"><a href="#4-AT、TCC、XA" class="headerlink" title="4.AT、TCC、XA"></a>4.AT、TCC、XA</h2><ul>
<li>XA协议<ul>
<li>基于数据库的分布式事务协议，由数据库原生支持，例如2PC、3PC，是自动提交的</li>
</ul>
</li>
<li>AT模式<ul>
<li>是基于XA协议实现的，将一段执行的sql记录在undo_log表中，然后通过undo_log自动完成回滚，不需要程序员手动写补偿代码（一个注解即可搞定分布式事务）</li>
<li>AT模式下必须要依赖于数据库事务，并且每个资源管理器都要创建一个回滚日志表，需要回滚的时候根据日志魔改数据库</li>
<li>Seata的AT模式与2PC的区别，第一段提交已经提交了事务，当出现异常的时候是根据undo_log回滚。Seata的AT模式本质其实就是2PC模式，只不过是变种</li>
<li>不使用与高并发场景</li>
</ul>
</li>
<li>TCC模式<ul>
<li>未基于XA协议实现，由应用端实现，程序员在Cancel阶段实现业务逻辑完成数据回滚</li>
<li>可以不依赖于关系型数据库，比如我们的远程操作可能是操作Redis、MongoDB等。因为TCC中的各阶段的逻辑都是我们手动来实现的</li>
</ul>
</li>
</ul>
<h2 id="5-总结：外柔内刚"><a href="#5-总结：外柔内刚" class="headerlink" title="5.总结：外柔内刚"></a>5.总结：外柔内刚</h2><ul>
<li>强一致性的事务与柔性事务的API和功能并不完全相同，因此不能在它们之间自由地透明切换。在开发决策阶段，必须要在强一致的事务和柔性事务之间抉择，因此设计和开发成本大幅增加。</li>
<li>基于XA协议的强一致事务使用起来相对简单，但是无法很好地应对互联网的短事务和高并发场景；柔性事务则需要开发者对应用进行改造，接入成本非常高，并且需要开发者自行实现资源锁定和反向补偿。</li>
<li>对于分布式系统来说，建议使用“外柔内刚”的设计方案。外柔指的是在跨数据分片的情况下使用柔性事务，保证数据最终一致，并且换取最佳性能；内刚则是指在同一数据分片内使用本地事务，以满足ACID特性。</li>
</ul>
<h2 id="6-分布式事务对比表"><a href="#6-分布式事务对比表" class="headerlink" title="6.分布式事务对比表"></a>6.分布式事务对比表</h2><blockquote>
<p>XA协议： 适用场景：后台管理接口，例如新增商品（无高并发）</p>
<p>TCC： 适用场景：高并发接口，例如创建订单（高并发）</p>
</blockquote>
<p><img src="https://halo-ctc.upyun.ctcnb.cn/gulimall-dev/v2-887398e1ad34f7c8fb892ff445049508_720w.jpg" alt="img"></p>
<h1 id="四、Seata"><a href="#四、Seata" class="headerlink" title="四、Seata"></a>四、Seata</h1><p><a target="_blank" rel="noopener" href="http://seata.io/zh-cn/docs/overview/what-is-seata.html">seata文档</a></p>
<blockquote>
<p>Seata 是一款开源的分布式事务解决方案，致力于提供高性能和简单易用的分布式事务服务。Seata 将为用户提供了 AT、TCC、SAGA 和 XA 事务模式，为用户打造一站式的分布式解决方案。</p>
<p>概述： Seata的AT模式是基于XA协议实现的，本质上是2PC协议的变种，在第一段提交时提交事务，第二段回滚时是依照undo_log表进行回滚</p>
</blockquote>
<h2 id="1-术语表"><a href="#1-术语表" class="headerlink" title="1.术语表"></a>1.术语表</h2><ul>
<li>Seata术语<ul>
<li>TC (Transaction Coordinator) - 事务协调者 维护全局和分支事务的状态，驱动全局事务提交或回滚。</li>
<li>TM (Transaction Manager) - 事务管理器 定义全局事务的范围：开始全局事务、提交或回滚全局事务。</li>
<li>RM (Resource Manager) - 资源管理器 管理分支事务处理的资源，与TC交谈以注册分支事务和报告分支事务的状态，并驱动分支事务提交或回滚。</li>
</ul>
</li>
</ul>
<h2 id="2-流程"><a href="#2-流程" class="headerlink" title="2.流程"></a>2.流程</h2><blockquote>
<ol>
<li>事务管理器告诉事务协调器开启全局事务</li>
<li>事务管理器调用各资源管理器，并且各资源服务器在事务协调者上注册分支事务</li>
<li>事务管理器调用各分支事务，之后分支事务向事务协调器汇报分支状态</li>
<li>如果所有事务分支成功则全局提交，否则全局回滚</li>
</ol>
</blockquote>
<p><img src="https://halo-ctc.upyun.ctcnb.cn/gulimall-dev/solution.png" alt="img"></p>
<h2 id="3-整合Seata实现AT模式"><a href="#3-整合Seata实现AT模式" class="headerlink" title="3.整合Seata实现AT模式"></a>3.整合Seata实现AT模式</h2><h3 id="3-1-创建UNDO-LOG表"><a href="#3-1-创建UNDO-LOG表" class="headerlink" title="3.1.创建UNDO_LOG表"></a>3.1.创建UNDO_LOG表</h3><blockquote>
<p>AT模式是基于回滚日志表实现的</p>
</blockquote>
<p>在各资源管理器创建UNDO_LOG表<br>– 注意此处0.3.0+ 增加唯一索引 ux_undo_log</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `undo_log` (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `branch_id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `xid` <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `context` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `rollback_info` longblob <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `log_status` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `log_created` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `log_modified` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `ext` <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `ux_undo_log` (`xid`,`branch_id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">1</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br></pre></td></tr></table></figure>



<h3 id="3-2-添加依赖"><a href="#3-2-添加依赖" class="headerlink" title="3.2.添加依赖"></a>3.2.添加依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--seata 分布式事务 seata-all使用0.9【所以启动 事务协调者0.9版本的】--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-seata<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.seata<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>seata-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.seata<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>seata-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.9.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="3-3-下载安装seata服务器"><a href="#3-3-下载安装seata服务器" class="headerlink" title="3.3.下载安装seata服务器"></a>3.3.下载安装seata服务器</h3><h3 id="下载安装seata服务器"><a href="#下载安装seata服务器" class="headerlink" title="下载安装seata服务器"></a>下载安装seata服务器</h3><ol>
<li>下载seata服务器并解压 <a target="_blank" rel="noopener" href="https://github.com/seata/seata/releases">seata服务器</a></li>
<li>修改配置文件registry.xml</li>
</ol>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">registry <span class="punctuation">&#123;</span></span><br><span class="line">  # file 、nacos 、eureka、redis、zk、consul、etcd3、sofa  注册中心</span><br><span class="line">  type = <span class="string">&quot;nacos&quot;</span></span><br><span class="line"></span><br><span class="line">  nacos <span class="punctuation">&#123;</span></span><br><span class="line">    application = <span class="string">&quot;seata-server&quot;</span></span><br><span class="line">    serverAddr = <span class="string">&quot;localhost:8848&quot;</span></span><br><span class="line">    namespace = <span class="string">&quot;&quot;</span></span><br><span class="line">    cluster = <span class="string">&quot;default&quot;</span></span><br><span class="line">    username = <span class="string">&quot;&quot;</span></span><br><span class="line">    password = <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line">  eureka <span class="punctuation">&#123;</span></span><br><span class="line">    serviceUrl = <span class="string">&quot;http://localhost:8761/eureka&quot;</span></span><br><span class="line">    application = <span class="string">&quot;default&quot;</span></span><br><span class="line">    weight = <span class="string">&quot;1&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line">  redis <span class="punctuation">&#123;</span></span><br><span class="line">    serverAddr = <span class="string">&quot;localhost:6379&quot;</span></span><br><span class="line">    db = <span class="number">0</span></span><br><span class="line">    password = <span class="string">&quot;&quot;</span></span><br><span class="line">    cluster = <span class="string">&quot;default&quot;</span></span><br><span class="line">    timeout = <span class="number">0</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line">  zk <span class="punctuation">&#123;</span></span><br><span class="line">    cluster = <span class="string">&quot;default&quot;</span></span><br><span class="line">    serverAddr = <span class="string">&quot;127.0.0.1:2181&quot;</span></span><br><span class="line">    sessionTimeout = <span class="number">6000</span></span><br><span class="line">    connectTimeout = <span class="number">2000</span></span><br><span class="line">    username = <span class="string">&quot;&quot;</span></span><br><span class="line">    password = <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line">  consul <span class="punctuation">&#123;</span></span><br><span class="line">    cluster = <span class="string">&quot;default&quot;</span></span><br><span class="line">    serverAddr = <span class="string">&quot;127.0.0.1:8500&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line">  etcd3 <span class="punctuation">&#123;</span></span><br><span class="line">    cluster = <span class="string">&quot;default&quot;</span></span><br><span class="line">    serverAddr = <span class="string">&quot;http://localhost:2379&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line">  sofa <span class="punctuation">&#123;</span></span><br><span class="line">    serverAddr = <span class="string">&quot;127.0.0.1:9603&quot;</span></span><br><span class="line">    application = <span class="string">&quot;default&quot;</span></span><br><span class="line">    region = <span class="string">&quot;DEFAULT_ZONE&quot;</span></span><br><span class="line">    datacenter = <span class="string">&quot;DefaultDataCenter&quot;</span></span><br><span class="line">    cluster = <span class="string">&quot;default&quot;</span></span><br><span class="line">    group = <span class="string">&quot;SEATA_GROUP&quot;</span></span><br><span class="line">    addressWaitTime = <span class="string">&quot;3000&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line">  file <span class="punctuation">&#123;</span></span><br><span class="line">    name = <span class="string">&quot;file.conf&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">config <span class="punctuation">&#123;</span></span><br><span class="line">  # file、nacos 、apollo、zk、consul、etcd3   seata配置路径</span><br><span class="line">  type = <span class="string">&quot;file&quot;</span></span><br><span class="line"></span><br><span class="line">  nacos <span class="punctuation">&#123;</span></span><br><span class="line">    serverAddr = <span class="string">&quot;localhost&quot;</span></span><br><span class="line">    namespace = <span class="string">&quot;&quot;</span></span><br><span class="line">    group = <span class="string">&quot;SEATA_GROUP&quot;</span></span><br><span class="line">    username = <span class="string">&quot;&quot;</span></span><br><span class="line">    password = <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line">  consul <span class="punctuation">&#123;</span></span><br><span class="line">    serverAddr = <span class="string">&quot;127.0.0.1:8500&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line">  apollo <span class="punctuation">&#123;</span></span><br><span class="line">    appId = <span class="string">&quot;seata-server&quot;</span></span><br><span class="line">    apolloMeta = <span class="string">&quot;http://192.168.1.204:8801&quot;</span></span><br><span class="line">    namespace = <span class="string">&quot;application&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line">  zk <span class="punctuation">&#123;</span></span><br><span class="line">    serverAddr = <span class="string">&quot;127.0.0.1:2181&quot;</span></span><br><span class="line">    sessionTimeout = <span class="number">6000</span></span><br><span class="line">    connectTimeout = <span class="number">2000</span></span><br><span class="line">    username = <span class="string">&quot;&quot;</span></span><br><span class="line">    password = <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line">  etcd3 <span class="punctuation">&#123;</span></span><br><span class="line">    serverAddr = <span class="string">&quot;http://localhost:2379&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line">  file <span class="punctuation">&#123;</span></span><br><span class="line">    name = <span class="string">&quot;file.conf&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ol>
<li>运行 windows：seata-server.bat Linux： sh seata-server.sh</li>
</ol>
<h3 id="3-4-代理数据源"><a href="#3-4-代理数据源" class="headerlink" title="3.4.代理数据源"></a>3.4.代理数据源</h3><p>所有需要使用分布式事务的微服务使用Seata DataSourceProxy代理数据源</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  seata分布式事务</span></span><br><span class="line"><span class="comment"> *  配置代理数据源</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: wanzenghui</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MySeataConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    DataSourceProperties dataSourceProperties;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 需要将 DataSourceProxy 设置为主数据源，否则事务无法回滚</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">dataSource</span><span class="params">(DataSourceProperties dataSourceProperties)</span> &#123;</span><br><span class="line">        <span class="type">HikariDataSource</span> <span class="variable">dataSource</span> <span class="operator">=</span> dataSourceProperties.initializeDataSourceBuilder().type(HikariDataSource.class).build();</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.hasText(dataSourceProperties.getName())) &#123;</span><br><span class="line">            dataSource.setPoolName(dataSourceProperties.getName());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DataSourceProxy</span>(dataSource);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-5-每个微服务导入配置"><a href="#3-5-每个微服务导入配置" class="headerlink" title="3.5.每个微服务导入配置"></a>3.5.每个微服务导入配置</h3><ol>
<li>将registry.xml、file.xml复制到每个需要使用分布式事务的微服务里</li>
<li>修改file.xml，改为每个微服务应用的名字</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">service &#123;</span><br><span class="line">  #vgroup-&gt;rgroup</span><br><span class="line">  vgroup_mapping.gulimall-order-fescar-service-group = &quot;default&quot;</span><br><span class="line">  #only support single node</span><br><span class="line">  default.grouplist = &quot;localhost:8091&quot;</span><br><span class="line">  #degrade current not support</span><br><span class="line">  enableDegrade = false</span><br><span class="line">  #disable</span><br><span class="line">  disable = false</span><br><span class="line">  #unit ms,s,m,h,d represents milliseconds, seconds, minutes, hours, days, default permanent</span><br><span class="line">  max.commit.retry.timeout = &quot;-1&quot;</span><br><span class="line">  max.rollback.retry.timeout = &quot;-1&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-4-添加注解"><a href="#3-4-添加注解" class="headerlink" title="3.4.添加注解"></a>3.4.添加注解</h3><p>主业务方法上添加<code>@GlobalTransactional</code>（TM） 各远程接口添加<code>@Transactional</code>（RM）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 创建订单</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> vo 收货地址、发票信息、使用的优惠券、备注、应付总额、令牌</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GlobalTransactional</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> SubmitOrderResponseVO <span class="title function_">submitOrder</span><span class="params">(OrderSubmitVO orderSubmitVO)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">SubmitOrderResponseVO</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SubmitOrderResponseVO</span>();<span class="comment">// 返回值</span></span><br><span class="line">    <span class="comment">// 创建订单线程共享提交数据</span></span><br><span class="line">    confirmVoThreadLocal.set(orderSubmitVO);</span><br><span class="line">    <span class="comment">// 1.生成订单实体对象（订单 + 订单项）</span></span><br><span class="line">    <span class="type">OrderCreateTO</span> <span class="variable">order</span> <span class="operator">=</span> createOrder();</span><br><span class="line">    <span class="comment">// 2.验价应付金额（允许0.01误差，前后端计算不一致）</span></span><br><span class="line">    <span class="keyword">if</span> (Math.abs(orderSubmitVO.getPayPrice().subtract(order.getPayPrice()).doubleValue()) &gt;= <span class="number">0.01</span>) &#123;</span><br><span class="line">        <span class="comment">// 验价不通过</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">VerifyPriceException</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 验价成功</span></span><br><span class="line">    <span class="comment">// 3.保存订单</span></span><br><span class="line">    saveOrder(order);</span><br><span class="line">    <span class="comment">// 4.库存锁定（wms_ware_sku）</span></span><br><span class="line">    <span class="comment">// 封装待锁定商品项TO</span></span><br><span class="line">    <span class="type">WareSkuLockTO</span> <span class="variable">lockTO</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WareSkuLockTO</span>();</span><br><span class="line">    lockTO.setOrderSn(order.getOrder().getOrderSn());</span><br><span class="line">    List&lt;OrderItemVO&gt; locks = order.getOrderItems().stream().map((item) -&gt; &#123;</span><br><span class="line">        <span class="type">OrderItemVO</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderItemVO</span>();</span><br><span class="line">        lock.setSkuId(item.getSkuId());</span><br><span class="line">        lock.setCount(item.getSkuQuantity());</span><br><span class="line">        lock.setTitle(item.getSkuName());</span><br><span class="line">        <span class="keyword">return</span> lock;</span><br><span class="line">    &#125;).collect(Collectors.toList());</span><br><span class="line">    lockTO.setLocks(locks);<span class="comment">// 待锁定订单项</span></span><br><span class="line">    <span class="type">R</span> <span class="variable">response</span> <span class="operator">=</span> wmsFeignService.orderLockStock(lockTO);</span><br><span class="line">    <span class="keyword">if</span> (response.getCode() == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 锁定成功</span></span><br><span class="line">        <span class="comment">// TODO 5.远程扣减积分</span></span><br><span class="line">        <span class="comment">// 封装响应数据返回</span></span><br><span class="line">        result.setOrder(order.getOrder());</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 锁定失败</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NoStockException</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="五、可靠消息-最终一致性"><a href="#五、可靠消息-最终一致性" class="headerlink" title="五、可靠消息+最终一致性"></a>五、可靠消息+最终一致性</h1><h2 id="1-实现方案"><a href="#1-实现方案" class="headerlink" title="1.实现方案"></a>1.实现方案</h2><p><img src="https://halo-ctc.upyun.ctcnb.cn/gulimall-dev/QQ%E5%9B%BE%E7%89%8720220102211108.png" alt="QQ图片20220102211108"></p>
<blockquote>
<p>方案一：订单创建失败，在抛出异常的地方发送消息到MQ，告诉库存系统解锁库存</p>
<p>方案二：锁定库存的时候，同时保存库存工作单（wms_ware_order_task）+库存工作单详情（wms_ware_order_task_detail），然后使用定时器扫描工作单中创建失败的订单，进行库存解锁 【使用定时器比较麻烦，采用延迟队列】</p>
<p>方案三：锁库存时，往延时队列发送一条库存解锁消息，30分钟后消费消息，如果订单失败则释放库存</p>
</blockquote>
<p><img src="https://halo-ctc.upyun.ctcnb.cn/gulimall-dev/1598789902079.png" alt="1598789902079"></p>
<h2 id="2-RabbitMQ延时队列、死信队列"><a href="#2-RabbitMQ延时队列、死信队列" class="headerlink" title="2.RabbitMQ延时队列、死信队列"></a>2.RabbitMQ延时队列、死信队列</h2><h2 id="3-可靠消息"><a href="#3-可靠消息" class="headerlink" title="3.可靠消息"></a>3.可靠消息</h2></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://020327.xyz">阿库娅</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://020327.xyz/2023/01/850adb54cef4.html">http://020327.xyz/2023/01/850adb54cef4.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://020327.xyz" target="_blank">编程小屋</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/spring/">spring</a><a class="post-meta__tags" href="/tags/%E4%BA%8B%E5%8A%A1/">事务</a></div><div class="post_share"><div class="social-share" data-image="https://common.ctcnb.cn/avatar.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/01/0cd74a829f6c.html" title="线程池和异步编排"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">线程池和异步编排</div></div></a></div><div class="next-post pull-right"><a href="/2023/01/b99957d15be1.html" title="定时任务-spring整合cron表达式"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">定时任务-spring整合cron表达式</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2022/04/a836a7619df1.html" title="Spring基础"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-04-08</div><div class="title">Spring基础</div></div></a></div><div><a href="/2023/01/7bc9b569e5a0.html" title="sentinel实现熔断+降级+限流"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-01-14</div><div class="title">sentinel实现熔断+降级+限流</div></div></a></div><div><a href="/2023/02/631b03fcdc2f.html" title="压力测试和JMeter的使用"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-02-12</div><div class="title">压力测试和JMeter的使用</div></div></a></div><div><a href="/2023/03/991533426f94.html" title="java知识点——框架篇"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-03-08</div><div class="title">java知识点——框架篇</div></div></a></div><div><a href="/2023/01/0cd74a829f6c.html" title="线程池和异步编排"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-01-13</div><div class="title">线程池和异步编排</div></div></a></div><div><a href="/2023/01/a29775d820e8.html" title="Feign远程调用中的各种问题"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-01-04</div><div class="title">Feign远程调用中的各种问题</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://common.ctcnb.cn/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">阿库娅</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">31</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">41</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">10</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/ctcnb"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/ctcnb" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:ctcnb1@163.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E6%9C%AC%E5%9C%B0%E4%BA%8B%E5%8A%A1"><span class="toc-number">1.</span> <span class="toc-text">一、本地事务</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-ACID%E7%90%86%E8%AE%BA%EF%BC%88%E5%BC%BA%E4%B8%80%E8%87%B4%E6%80%A7%EF%BC%89"><span class="toc-number">1.1.</span> <span class="toc-text">1.ACID理论（强一致性）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E4%BA%8B%E5%8A%A1%E9%97%B4%E7%9A%84%E5%BD%B1%E5%93%8D"><span class="toc-number">1.2.</span> <span class="toc-text">2.事务间的影响</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95"><span class="toc-number">1.3.</span> <span class="toc-text">3.解决方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E4%BA%8B%E5%8A%A1%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB"><span class="toc-number">1.4.</span> <span class="toc-text">4.事务隔离级别</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-Spring%E8%AE%BE%E7%BD%AE%E4%BA%8B%E5%8A%A1%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB"><span class="toc-number">1.4.1.</span> <span class="toc-text">4.1.Spring设置事务隔离级别</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-Spring%E7%9A%84%E4%BC%A0%E6%92%AD%E8%A1%8C%E4%B8%BA"><span class="toc-number">1.5.</span> <span class="toc-text">5.Spring的传播行为</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-%E6%A1%88%E4%BE%8B"><span class="toc-number">1.5.1.</span> <span class="toc-text">5.1.案例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-%E6%9C%AC%E5%9C%B0%E4%BA%8B%E5%8A%A1%E5%A4%B1%E6%95%88%E9%97%AE%E9%A2%98"><span class="toc-number">1.5.2.</span> <span class="toc-text">5.2.本地事务失效问题</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B"><span class="toc-number">1.5.2.1.</span> <span class="toc-text">案例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8E%9F%E5%9B%A0"><span class="toc-number">1.5.2.2.</span> <span class="toc-text">原因</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3"><span class="toc-number">1.5.2.3.</span> <span class="toc-text">解决</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B7%E4%BD%93%E6%AD%A5%E9%AA%A4%EF%BC%9A"><span class="toc-number">1.5.2.4.</span> <span class="toc-text">具体步骤：</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%E3%80%81CAP%E5%AE%9A%E7%90%86%E5%92%8CBASE%E7%90%86%E8%AE%BA"><span class="toc-number">2.</span> <span class="toc-text">二、CAP定理和BASE理论</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-CAP%E5%AE%9A%E7%90%86"><span class="toc-number">2.1.</span> <span class="toc-text">1.CAP定理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E6%A6%82%E8%BF%B0"><span class="toc-number">2.1.1.</span> <span class="toc-text">1.1.概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E5%AE%9E%E7%8E%B0%E4%B8%80%E8%87%B4%E6%80%A7%E7%9A%84%E7%AE%97%E6%B3%95"><span class="toc-number">2.1.2.</span> <span class="toc-text">1.2.实现一致性的算法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-raft%E7%AE%97%E6%B3%95%EF%BC%88CP%EF%BC%89"><span class="toc-number">2.1.3.</span> <span class="toc-text">1.3.raft算法（CP）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-1-%E6%A6%82%E8%BF%B0"><span class="toc-number">2.1.3.1.</span> <span class="toc-text">1.3.1.概述</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%89%E7%A7%8D%E7%8A%B6%E6%80%81"><span class="toc-number">2.1.3.1.1.</span> <span class="toc-text">三种状态</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%89%E4%B8%AA%E8%B6%85%E6%97%B6%E6%97%B6%E9%97%B4"><span class="toc-number">2.1.3.1.2.</span> <span class="toc-text">三个超时时间</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-2-%E9%A2%86%E5%AF%BC%E9%80%89%E4%B8%BE"><span class="toc-number">2.1.3.2.</span> <span class="toc-text">1.3.2.领导选举</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8A%95%E7%A5%A8%E5%88%86%E7%A6%BB"><span class="toc-number">2.1.3.2.1.</span> <span class="toc-text">投票分离</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-3-%E6%97%A5%E5%BF%97%E5%A4%8D%E5%88%B6"><span class="toc-number">2.1.3.3.</span> <span class="toc-text">1.3.3.日志复制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-4-%E7%BD%91%E7%BB%9C%E5%88%86%E5%8C%BA%E4%B8%80%E8%87%B4%E6%80%A7"><span class="toc-number">2.1.3.4.</span> <span class="toc-text">1.3.4.网络分区一致性</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-paxos%E7%AE%97%E6%B3%95"><span class="toc-number">2.1.4.</span> <span class="toc-text">1.4.paxos算法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-5-%E9%9B%86%E7%BE%A4%E9%9D%A2%E4%B8%B4%E7%9A%84%E9%97%AE%E9%A2%98%EF%BC%88AP%EF%BC%89"><span class="toc-number">2.1.5.</span> <span class="toc-text">1.5.集群面临的问题（AP）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-BASE%E7%90%86%E8%AE%BA%EF%BC%88%E6%9C%80%E7%BB%88%E4%B8%80%E8%87%B4%E6%80%A7%EF%BC%89"><span class="toc-number">2.2.</span> <span class="toc-text">2.BASE理论（最终一致性）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E6%A1%88%E4%BE%8B"><span class="toc-number">2.2.1.</span> <span class="toc-text">2.1.案例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E6%A6%82%E8%BF%B0"><span class="toc-number">2.2.2.</span> <span class="toc-text">2.2.概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-%E5%BC%BA%E4%B8%80%E8%87%B4%E6%80%A7%E3%80%81%E5%BC%B1%E4%B8%80%E8%87%B4%E6%80%A7%E3%80%81%E6%9C%80%E7%BB%88%E4%B8%80%E8%87%B4%E6%80%A7"><span class="toc-number">2.2.3.</span> <span class="toc-text">2.3.强一致性、弱一致性、最终一致性</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1"><span class="toc-number">3.</span> <span class="toc-text">三、分布式事务</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E6%A6%82%E8%BF%B0"><span class="toc-number">3.1.</span> <span class="toc-text">1.分布式事务概述</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F%E5%87%BA%E7%8E%B0%E7%9A%84%E5%BC%82%E5%B8%B8"><span class="toc-number">3.1.1.</span> <span class="toc-text">分布式系统出现的异常</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E5%88%9A%E6%80%A7%E4%BA%8B%E5%8A%A1XA%EF%BC%88ACID%EF%BC%89"><span class="toc-number">3.2.</span> <span class="toc-text">2.刚性事务XA（ACID）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-2PC%E5%8D%8F%E8%AE%AE"><span class="toc-number">3.2.1.</span> <span class="toc-text">2.1.2PC协议</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B-1"><span class="toc-number">3.2.1.1.</span> <span class="toc-text">案例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%BA%E7%82%B9"><span class="toc-number">3.2.1.2.</span> <span class="toc-text">缺点</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-3PC%E5%8D%8F%E8%AE%AE"><span class="toc-number">3.2.2.</span> <span class="toc-text">2.2.3PC协议</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%BA%E7%82%B9-1"><span class="toc-number">3.2.2.1.</span> <span class="toc-text">缺点</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E6%9F%94%E6%80%A7%E4%BA%8B%E5%8A%A1%EF%BC%88BASE%EF%BC%89"><span class="toc-number">3.3.</span> <span class="toc-text">3.柔性事务（BASE）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-TCC%E6%A8%A1%E5%BC%8F"><span class="toc-number">3.3.1.</span> <span class="toc-text">3.1.TCC模式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0"><span class="toc-number">3.3.1.1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B-2"><span class="toc-number">3.3.1.2.</span> <span class="toc-text">案例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%BA%E7%82%B9-2"><span class="toc-number">3.3.1.3.</span> <span class="toc-text">缺点</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E6%9C%80%E5%A4%A7%E5%8A%AA%E5%8A%9B%E9%80%9A%E7%9F%A5%E5%9E%8B"><span class="toc-number">3.3.2.</span> <span class="toc-text">3.2.最大努力通知型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-%E5%8F%AF%E9%9D%A0%E6%B6%88%E6%81%AF-%E6%9C%80%E7%BB%88%E4%B8%80%E8%87%B4%E6%80%A7"><span class="toc-number">3.3.3.</span> <span class="toc-text">3.3. 可靠消息+最终一致性</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0-1"><span class="toc-number">3.3.3.1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%BA%E7%82%B9-3"><span class="toc-number">3.3.3.2.</span> <span class="toc-text">缺点</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-Sega"><span class="toc-number">3.3.4.</span> <span class="toc-text">3.4.Sega</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-AT%E3%80%81TCC%E3%80%81XA"><span class="toc-number">3.4.</span> <span class="toc-text">4.AT、TCC、XA</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E6%80%BB%E7%BB%93%EF%BC%9A%E5%A4%96%E6%9F%94%E5%86%85%E5%88%9A"><span class="toc-number">3.5.</span> <span class="toc-text">5.总结：外柔内刚</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E5%AF%B9%E6%AF%94%E8%A1%A8"><span class="toc-number">3.6.</span> <span class="toc-text">6.分布式事务对比表</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9B%9B%E3%80%81Seata"><span class="toc-number">4.</span> <span class="toc-text">四、Seata</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E6%9C%AF%E8%AF%AD%E8%A1%A8"><span class="toc-number">4.1.</span> <span class="toc-text">1.术语表</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E6%B5%81%E7%A8%8B"><span class="toc-number">4.2.</span> <span class="toc-text">2.流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E6%95%B4%E5%90%88Seata%E5%AE%9E%E7%8E%B0AT%E6%A8%A1%E5%BC%8F"><span class="toc-number">4.3.</span> <span class="toc-text">3.整合Seata实现AT模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E5%88%9B%E5%BB%BAUNDO-LOG%E8%A1%A8"><span class="toc-number">4.3.1.</span> <span class="toc-text">3.1.创建UNDO_LOG表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E6%B7%BB%E5%8A%A0%E4%BE%9D%E8%B5%96"><span class="toc-number">4.3.2.</span> <span class="toc-text">3.2.添加依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-%E4%B8%8B%E8%BD%BD%E5%AE%89%E8%A3%85seata%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">4.3.3.</span> <span class="toc-text">3.3.下载安装seata服务器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BD%E5%AE%89%E8%A3%85seata%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">4.3.4.</span> <span class="toc-text">下载安装seata服务器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-%E4%BB%A3%E7%90%86%E6%95%B0%E6%8D%AE%E6%BA%90"><span class="toc-number">4.3.5.</span> <span class="toc-text">3.4.代理数据源</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-%E6%AF%8F%E4%B8%AA%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AF%BC%E5%85%A5%E9%85%8D%E7%BD%AE"><span class="toc-number">4.3.6.</span> <span class="toc-text">3.5.每个微服务导入配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-%E6%B7%BB%E5%8A%A0%E6%B3%A8%E8%A7%A3"><span class="toc-number">4.3.7.</span> <span class="toc-text">3.4.添加注解</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%94%E3%80%81%E5%8F%AF%E9%9D%A0%E6%B6%88%E6%81%AF-%E6%9C%80%E7%BB%88%E4%B8%80%E8%87%B4%E6%80%A7"><span class="toc-number">5.</span> <span class="toc-text">五、可靠消息+最终一致性</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%A1%88"><span class="toc-number">5.1.</span> <span class="toc-text">1.实现方案</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-RabbitMQ%E5%BB%B6%E6%97%B6%E9%98%9F%E5%88%97%E3%80%81%E6%AD%BB%E4%BF%A1%E9%98%9F%E5%88%97"><span class="toc-number">5.2.</span> <span class="toc-text">2.RabbitMQ延时队列、死信队列</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E5%8F%AF%E9%9D%A0%E6%B6%88%E6%81%AF"><span class="toc-number">5.3.</span> <span class="toc-text">3.可靠消息</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/07/860d24e4422f.html" title="在绿联上安装clouddrive2">在绿联上安装clouddrive2</a><time datetime="2024-07-07T02:22:00.000Z" title="发表于 2024-07-07 10:22:00">2024-07-07</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/07/90f860897346.html" title="使用github和cloudflare实现自建docker加速器，解决docker镜像无法拉取的问题">使用github和cloudflare实现自建docker加速器，解决docker镜像无法拉取的问题</a><time datetime="2024-07-07T02:20:36.000Z" title="发表于 2024-07-07 10:20:36">2024-07-07</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/07/50fa77229b05.html" title="docker-java使用win系统下docker">docker-java使用win系统下docker</a><time datetime="2024-07-07T02:18:45.000Z" title="发表于 2024-07-07 10:18:45">2024-07-07</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/07/2d630400ad43.html" title="api开发平台">api开发平台</a><time datetime="2024-07-07T02:16:44.000Z" title="发表于 2024-07-07 10:16:44">2024-07-07</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/07/e0edd63ff2be.html" title="python程序打包为win/linux可执行文件">python程序打包为win/linux可执行文件</a><time datetime="2024-07-07T01:47:49.000Z" title="发表于 2024-07-07 09:47:49">2024-07-07</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2021 - 2024 By 阿库娅</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text"><div style="width:300px;margin:0 auto"> <a href="https://beian.miit.gov.cn/" target="_blank">鲁ICP备2022041346号</a> <a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=37148202000461"> <p> <img src="https://wordpress-img.upyun.ctcnb.cn/2023/01/%E5%A4%87%E6%A1%88%E5%9B%BE%E6%A0%87.png" />鲁公网安备 37148202000461号</p> </a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.13.0"></script><script src="/js/main.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>